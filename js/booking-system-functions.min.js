function bookacti_get_booking_system_data_by_interval(c,a){var b=c.attr("id"),f=$j.extend(!0,{},bookacti.booking_system[b]),d=bookacti_get_booking_system_attributes_without_data(c);a=a?a:$j.extend(!0,{},f.events_interval);bookacti.booking_system[b].events_interval=bookacti_get_extended_events_interval(c,a);bookacti_start_loading_booking_system(c);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingSystemDataByInterval",attributes:JSON.stringify(d),interval:JSON.stringify(a)},
dataType:"json",success:function(e){if("success"===e.status){$j.isEmptyObject(bookacti.booking_system[b].events)?bookacti.booking_system[b].events=e.booking_system_data.events:bookacti.booking_system[b].events=bookacti.booking_system[b].events.concat(e.booking_system_data.events);$j.isEmptyObject(bookacti.booking_system[b].events_data)?bookacti.booking_system[b].events_data=e.booking_system_data.events_data:$j.extend(bookacti.booking_system[b].events_data,e.booking_system_data.events_data);$j.isEmptyObject(bookacti.booking_system[b].groups_events)?
bookacti.booking_system[b].groups_events=e.booking_system_data.groups_events:$j.extend(!0,bookacti.booking_system[b].groups_events,e.booking_system_data.groups_events);$j.isEmptyObject(bookacti.booking_system[b].groups_data)?bookacti.booking_system[b].groups_data=e.booking_system_data.groups_data:$j.extend(bookacti.booking_system[b].groups_data,e.booking_system_data.groups_data);$j.isEmptyObject(bookacti.booking_system[b].bookings)?bookacti.booking_system[b].bookings=e.booking_system_data.bookings:
$j.extend(!0,bookacti.booking_system[b].bookings,e.booking_system_data.bookings);$j.isEmptyObject(bookacti.booking_system[b].groups_bookings)?bookacti.booking_system[b].groups_bookings=e.booking_system_data.groups_bookings:$j.extend(!0,bookacti.booking_system[b].groups_bookings,e.booking_system_data.groups_bookings);$j.isEmptyObject(bookacti.booking_system[b].booking_lists)?bookacti.booking_system[b].booking_lists=e.booking_system_data.booking_lists:$j.extend(!0,bookacti.booking_system[b].booking_lists,
e.booking_system_data.booking_lists);if(e?.trimmed_period?.start||e?.trimmed_period?.end)e?.trimmed_period?.start&&(bookacti.booking_system[b].start=e.trimmed_period.start),e?.trimmed_period?.end&&(bookacti.booking_system[b].end=e.trimmed_period.end),bookacti_booking_method_update_availability_period(c);e.booking_system_data.events.length&&bookacti_booking_method_display_events(c,e.booking_system_data.events);c.trigger("bookacti_booking_system_interval_data_loaded",[e,f,d,a])}else console.log("undefined"!==
typeof e.message?e.message:bookacti_localized.error),console.log(e)},error:function(e){console.log("AJAX "+bookacti_localized.error);console.log(e)},complete:function(){bookacti_stop_loading_booking_system(c)}})}
function bookacti_reload_booking_system(c,a){a=a||!1;var b=c.attr("id"),f=$j.extend(!0,{},bookacti.booking_system[b]),d=bookacti_get_booking_system_attributes_without_data(c);a||delete d.picked_events;bookacti_start_loading_booking_system(c);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiReloadBookingSystem",attributes:JSON.stringify(d)},dataType:"json",success:function(e){"success"===e.status?(c.empty(),bookacti_clear_booking_system_displayed_info(c),bookacti.booking_system[b]=
e.booking_system_data,"undefined"!==typeof f.rescheduled_bookings_data&&(bookacti.booking_system[b].rescheduled_bookings_data=$j.extend(!0,{},f.rescheduled_bookings_data)),"undefined"!==typeof f.templates_per_activities&&(bookacti.booking_system[b].templates_per_activities=$j.extend(!0,{},f.templates_per_activities)),c.append(e.html_elements),bookacti_booking_method_set_up(c),bookacti_fill_booking_system_fields(c),bookacti_fill_picked_events_list(c),c.trigger("bookacti_booking_system_reloaded",[e,
f,d])):(console.log("undefined"!==typeof e.message?e.message:bookacti_localized.error),console.log(e))},error:function(e){console.log("AJAX "+bookacti_localized.error);console.log(e)},complete:function(){bookacti_stop_loading_booking_system(c)}})}
function bookacti_get_booking_system_attributes_without_data(c){c=c.attr("id");var a=$j.extend(!0,{},bookacti.booking_system[c]),b=$j.extend(!0,{},bookacti.booking_system[c]),f=bookacti_localized.booking_system_attributes_keys;$j.each(a,function(d,e){-1===$j.inArray(d,f)&&delete b[d]});return b}
function bookacti_get_interval_of_events(c,a){var b=c.attr("id"),f=bookacti.booking_system[b].events_interval,d=bookacti_get_availability_period(c);b=parseInt(bookacti_localized.event_load_interval);var e=d.start?moment.utc(d.start):!1;d=d.end?moment.utc(d.end):!1;var g=moment.utc(a.start).clone(),h=moment.utc(a.end).clone();e&&g.isBefore(e)&&(g=e.clone());d&&h.isAfter(d)&&(h=d.clone());var m={},p={start:g.clone(),end:h.clone()};if($j.isEmptyObject(f))m=bookacti_get_new_interval_of_events(c,p);else{var n=
moment.utc(f.start).clone().locale("en");f=moment.utc(f.end).clone().locale("en");if(g.isBefore(n)||h.isAfter(f)){m=n.clone();var k=f.clone(),l=moment.utc(a.start).clone().subtract(1,"days").locale("en");a=moment.utc(a.end).clone().add(1,"days").locale("en");if((g.isBefore(n)&&h.isAfter(f)||h.isBefore(n)||g.isAfter(f))&&l.format("YYYY-MM-DD")+" 23:59:59"!==f.format("YYYY-MM-DD HH:mm:ss")&&a.format("YYYY-MM-DD")+" 00:00:00"!==n.format("YYYY-MM-DD HH:mm:ss"))bookacti_booking_method_clear_events(c),
m=bookacti_get_new_interval_of_events(c,p);else{if(g.isBefore(n)||a.format("YYYY-MM-DD")+" 00:00:00"===n.format("YYYY-MM-DD HH:mm:ss"))m.subtract(b,"days"),g.isBefore(m)&&(m=g.clone()),e&&m.isBefore(e)&&(m=e.clone()),k=moment.utc(n.clone().subtract(1,"days").format("YYYY-MM-DD")+" 23:59:59");else if(h.isAfter(f)||l.format("YYYY-MM-DD")+" 23:59:59"===f.format("YYYY-MM-DD HH:mm:ss"))k.add(b,"days"),h.isAfter(k)&&(k=h.clone()),d&&k.isAfter(d)&&(k=d.clone()),m=moment.utc(f.clone().add(1,"days").format("YYYY-MM-DD")+
" 00:00:00");m={start:m.locale("en").format("YYYY-MM-DD HH:mm:ss"),end:k.locale("en").format("YYYY-MM-DD HH:mm:ss")}}}}return m}
function bookacti_get_new_interval_of_events(c,a){var b=c.attr("id"),f=bookacti_get_availability_period(c);if("undefined"===typeof f.start||"undefined"===typeof f.end)return{};b=bookacti.booking_system[b].past_events;var d=moment.utc(bookacti_localized.current_time),e=d.locale("en").format("YYYY-MM-DD HH:mm:ss");c=f.start?moment.utc(f.start):!1;var g=f.end?moment.utc(f.end):!1;if(!b&&g&&g.isBefore(d))return[];$j.isEmptyObject(a)&&(c&&c.isAfter(d)&&(a={start:f.start,end:f.start}),g&&$j.isEmptyObject(a)&&
g.isBefore(d)&&(a={start:f.end,end:f.end}),$j.isEmptyObject(a)&&(a={start:e,end:e}));e=parseInt(bookacti_localized.event_load_interval);f=moment.utc(moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD")+" 00:00:00");d=moment.utc(moment.utc(a.end).clone().locale("en").format("YYYY-MM-DD")+" 23:59:59");a=parseInt(Math.abs(moment.utc(a.end).diff(a.start,"days")));a>e&&(e=a);e=a=Math.round((e-a)/2);b?(f.subtract(a,"days"),c&&c.isAfter(f)&&(e+=Math.abs(f.diff(c,"days")))):e+=a;c&&c.isAfter(f)&&
(f=c.clone());d.add(e,"days");g&&g.isBefore(d)&&(d=g.clone());return{start:f.locale("en").format("YYYY-MM-DD HH:mm:ss"),end:d.locale("en").format("YYYY-MM-DD HH:mm:ss")}}function bookacti_get_extended_events_interval(c,a){c=c.attr("id");c=bookacti.booking_system[c].events_interval;return $j.isEmptyObject(a)?c:$j.isEmptyObject(c)?{start:a.start,end:a.end}:{start:moment.utc(a.start).isBefore(moment.utc(c.start))?a.start:c.start,end:moment.utc(a.end).isAfter(moment.utc(c.end))?a.end:c.end}}
function bookacti_get_availability_period(c){c=c.attr("id");c=bookacti.booking_system[c];return{start:c.start,end:c.end}}
function bookacti_refresh_booking_numbers(c){var a=c.attr("id"),b=bookacti.booking_system[a].calendars,f=bookacti.booking_system[a].groups_data,d=bookacti.booking_system[a].groups_events;bookacti_start_loading_booking_system(c);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingNumbers",template_ids:b,groups_data:f,groups_events:d},dataType:"json",success:function(e){bookacti.booking_system[a].bookings=[];"undefined"!==typeof e.bookings&&(bookacti.booking_system[a].bookings=
e.bookings,bookacti.booking_system[a].groups_bookings=e.groups_bookings);bookacti_booking_method_rerender_events(c)},error:function(e){alert("AJAX "+bookacti_localized.error);console.log(e)},complete:function(){bookacti_stop_loading_booking_system(c)}})}
function bookacti_event_click(c,a){var b=c.attr("id"),f=bookacti.booking_system[b].multiple_bookings;if(!bookacti_unpick_events(c,a)){var d={},e=[],g=0;"bookacti-booking-system-reschedule"!==b&&(d=bookacti_get_event_groups(c,a),g=bookacti_get_event_groups_nb(d),e=Object.keys(d));var h=!1;1<g||1===g&&bookacti.booking_system[b].groups_single_events?(h=!0,bookacti_dialog_choose_group_of_events(c,d,a)):(e=(b=e.length?e[0]:0)?Object.keys(d[b]):[],e=e.length?e[0]:"",f||bookacti_unpick_all_events(c),bookacti_pick_events(c,
a,b,e),b&&c.trigger("bookacti_group_of_events_chosen",[b,e,a]));c.trigger("bookacti_event_click",[a,d,h])}}
function bookacti_get_event_groups(c,a){var b={};if("object"!==typeof a||"undefined"===typeof a.id||"undefined"===typeof a.start||"undefined"===typeof a.end)return b;c=c.attr("id");var f="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),d=moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),e=moment.utc(a.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),g=bookacti.booking_system[c]?.groups_first_event_only;$j.each(bookacti.booking_system[c].groups_events,function(h,
m){$j.each(m,function(p,n){$j.each(n,function(k,l){if(parseInt(l.id)===f&&l.start===d&&l.end===e)return"undefined"===typeof b[h]&&(b[h]={}),b[h][p]=n,!1;if(g&&parseInt(g))return!1})})});return b}function bookacti_get_event_groups_nb(c){var a=0;$j.each(c,function(b,f){$j.each(f,function(d,e){++a})});return a}
function bookacti_fill_booking_system_fields(c){var a=c.siblings(".bookacti-booking-system-inputs");if(a.length){a.find('input[name^="selected_events"]').remove();var b=0,f=c.attr("id");$j.each(bookacti.booking_system[f].picked_events,function(d,e){a.append('<input type="hidden" name="selected_events['+b+'][group_id]" value="'+e.group_id+'"/>');a.append('<input type="hidden" name="selected_events['+b+'][group_date]" value="'+e.group_date+'"/>');a.append('<input type="hidden" name="selected_events['+
b+'][id]" value="'+e.id+'"/>');a.append('<input type="hidden" name="selected_events['+b+'][start]" value="'+e.start+'"/>');a.append('<input type="hidden" name="selected_events['+b+'][end]" value="'+e.end+'"/>');++b});c.trigger("bookacti_fill_booking_system_fields")}}
function bookacti_pick_events(c,a,b,f){$j.isNumeric(a)&&(a={id:parseInt(a),start:"",end:""});b=$j.isNumeric(b)?parseInt(b):0;f=f?f:"";var d="undefined"!==typeof a.groupId?parseInt(a.groupId):"undefined"!==typeof a.id?parseInt(a.id):0,e=0;if(!b&&!d)return e;b?(d=c.attr("id"),"undefined"!==typeof bookacti.booking_system[d].groups_events[b]&&"undefined"!==typeof bookacti.booking_system[d].groups_events[b][f]&&(d=bookacti.booking_system[d].groups_events[b][f].slice(),$j.each(d,function(g,h){group_picked_nb=
bookacti_pick_event(c,h,b,f);e+=group_picked_nb}))):e=bookacti_pick_event(c,a);c.trigger("bookacti_events_picked",[a,b,f]);return e}
function bookacti_is_event_picked(c,a){c=c.attr("id");c=$j.extend(!0,{},bookacti.booking_system[c].picked_events);var b="undefined"!==typeof a.start?moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD"):"",f=$j.isNumeric(a)?parseInt(a):"undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),d=!1;c&&$j.each(c,function(e,g){if(g.id==f&&($j.isNumeric(a)||g.start.substr(0,10)===b))return d=g,!1});return d}
function bookacti_pick_event(c,a,b,f){$j.isNumeric(a)&&(a={id:parseInt(a),start:"",end:""});b=$j.isNumeric(b)?parseInt(b):0;f=f?f:"";var d="undefined"!==typeof a.groupId?parseInt(a.groupId):"undefined"!==typeof a.id?parseInt(a.id):0,e=0;if(!b&&!d)return e;var g=c.attr("id"),h="undefined"!==typeof a.title?a.title:"",m="undefined"!==typeof a.activity_id?parseInt(a.activity_id):0;m||"undefined"===typeof bookacti.booking_system[g].events_data[d]||(h=bookacti.booking_system[g].events_data[d].title,m=bookacti.booking_system[g].events_data[d].activity_id);
var p="undefined"!==typeof a.start?a.start:"",n="undefined"!==typeof a.end?a.end:"";d={group_id:b,group_date:f?moment.utc(f).clone().locale("en").format("YYYY-MM-DD"):"",id:d,start:p?moment.utc(p).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"):"",end:n?moment.utc(n).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"):"",title:h,activity_id:parseInt(m)};bookacti.booking_system[g].picked_events.push(d);++e;bookacti.booking_system[g].picked_events.sort(function(k,l){k=moment.utc(k.start);l=moment.utc(l.start);
return k.isBefore(l)?-1:k.isAfter(l)?1:0});c.trigger("bookacti_pick_event",[a,b,f]);return e}
function bookacti_unpick_events(c,a,b,f){$j.isNumeric(a)&&(a={id:parseInt(a),start:"",end:""});b=$j.isNumeric(b)?parseInt(b):0;f=f?f:"";var d="undefined"!==typeof a.groupId?parseInt(a.groupId):"undefined"!==typeof a.id?parseInt(a.id):0,e=0;if(!b&&!d)return e;var g=c.attr("id"),h="undefined"!==typeof a.start?a.start:"",m=h?moment.utc(h).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"):"",p=b,n=f?moment.utc(f).clone().locale("en").format("YYYY-MM-DD"):"",k=[];$j.each(bookacti.booking_system[g].picked_events,
function(l,q){if(!q.group_id)return!0;l=q.group_id+"_"+q.group_date;var r=p&&q.group_id==p?1:0,B=n&&q.group_date===n?1:0,C=d&&q.id==d?1:0;q=m&&q.start.substr(0,10)===m.substr(0,10)?1:0;d||!r||n&&!B||k.push(l);p||!C||m&&!q||k.push(l);C&&r&&(n&&!B||m&&!q||k.push(l))});h=$j.grep(bookacti.booking_system[g].picked_events,function(l){var q=l.group_id+"_"+l.group_date,r=d&&l.id==d?1:0;l=m&&l.start.substr(0,10)===m.substr(0,10)?1:0;return 0<=$j.inArray(q,k)||r&&!m||r&&l?(++e,!1):!0});bookacti.booking_system[g].picked_events=
h;c.trigger("bookacti_events_unpicked",[a,b,f]);return e}function bookacti_unpick_all_events(c){var a=c.attr("id");bookacti.booking_system[a].picked_events=[];c.siblings(".bookacti-booking-system-inputs").find('input[name^="selected_events"]').remove();c.siblings(".bookacti-booking-system-inputs").find("input").val("");c.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list").empty();c.siblings(".bookacti-picked-events").hide();c.trigger("bookacti_unpick_all_events")}
function bookacti_get_picked_events_list_items(c){var a={},b=c.attr("id");qty_field=(c.closest("form").length?c.closest("form"):c.closest(".bookacti-form-fields")).find('input[name="quantity"], input.bookacti-quantity');var f=qty_field.length?parseInt(qty_field.val()):1;$j.each(bookacti.booking_system[b].picked_events,function(d,e){d=0;"undefined"!==typeof bookacti.booking_system[b].events_data&&0<parseInt(e.id)&&"undefined"!==typeof bookacti.booking_system[b].events_data[e.id]&&(d=bookacti.booking_system[b].events_data[e.id].activity_id);
var g=0;"undefined"!==typeof bookacti.booking_system[b].groups_data&&0<parseInt(e.group_id)&&"undefined"!==typeof bookacti.booking_system[b].groups_data[e.group_id]&&(g=bookacti.booking_system[b].groups_data[e.group_id].category_id);d={id:e.id,title:e.title,group_id:e.group_id,group_date:e.group_date,start:moment.utc(e.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),end:moment.utc(e.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),activity_id:parseInt(d),category_id:parseInt(g),quantity:f};
c.trigger("bookacti_picked_events_list_item_data",[d,e]);e=0<parseInt(d.group_id)?"group_"+d.group_id+"_"+d.group_date:"event_"+d.id+"_"+d.start+"_"+d.end;g=$j("<li></li>",{html:'<span class="bookacti-booking-event-title" >'+d.title+"</span>"});var h=bookacti_format_event_duration(d.start,d.end);h&&g.append('<span class="bookacti-booking-event-title-separator" > - </span>'+h);0<d.quantity&&(h=bookacti_get_activity_unit(c,d.activity_id,d.quantity))&&g.append('<span class="bookacti-booking-event-quantity-separator" > - </span><span class="bookacti-booking-event-quantity" >'+
d.quantity+" "+h+"</span>");g.data("event-id",d.id).attr("data-event-id",d.id);g.data("event-start",d.start).attr("data-event-start",d.start);g.data("event-end",d.end).attr("data-event-end",d.end);0<parseInt(d.group_id)?"undefined"===typeof a[e]?(h="","undefined"!==typeof bookacti.booking_system[b].groups_data[d.group_id]&&(h='<span class="bookacti-picked-group-of-events-title">'+bookacti.booking_system[b].groups_data[d.group_id].title+"</span>"),g=$j("<li></li>",{html:h+'<ul class="bookacti-picked-group-of-events-list">'+
g[0].outerHTML+"</ul>"}),g.data("group-id",d.group_id).attr("data-group-id",d.group_id),g.data("group-date",d.group_date).attr("data-group-date",d.group_date),a[e]=$j.extend(!0,{},d),a[e].list_element=g):(a[e].end=d.end,a[e].list_element.find("ul").append(g)):(a[e]=$j.extend(!0,{},d),a[e].list_element=g)});c.trigger("bookacti_picked_events_list_items",[a]);return a}
function bookacti_fill_picked_events_list(c){var a=c.attr("id"),b=c.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list-title"),f=c.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list");f.empty();c.siblings(".bookacti-picked-events").hide();if("undefined"!==typeof bookacti.booking_system[a].picked_events&&bookacti.booking_system[a].picked_events.length){var d=bookacti.booking_system[a].multiple_bookings;b.html(1===bookacti.booking_system[a].picked_events.length?
bookacti_localized.selected_event:bookacti_localized.selected_events);a=bookacti_get_picked_events_list_items(c);$j.each(a,function(e,g){e=g.list_element;d&&(e.find(".bookacti-picked-group-of-events-title").length?e.find(".bookacti-picked-group-of-events-title").after('<span class="bookacti-unpick-event-icon"></span>'):e.append('<span class="bookacti-unpick-event-icon"></span>'));f.append(e)});f.is(":empty")||c.siblings(".bookacti-picked-events").show();c.trigger("bookacti_picked_events_list_filled")}}
function bookacti_set_tooltip_position(c,a,b){if(a.length){b=0<=$j.inArray(b,["below","above"])?b:"below";a.css("position","absolute");var f=$j(window).width();a.outerWidth()>f-40&&(a.css("min-width",f-40+"px"),a.outerWidth(f-40));var d=c.offset(),e=c.offset().left+c.outerWidth()/2;d.top+="above"===b?-1*(a.outerHeight()+15):c.height()+15;d.left=e-a.outerWidth()/2;0>d.left&&(d.left=20);c=d.left+a.outerWidth();c>f-20&&(d.left-=c-(f-20));a.offset(d);b="above"===b?"bookacti-tooltip-arrow-bottom":"bookacti-tooltip-arrow-top";
a.find(".bookacti-tooltip-arrow."+b).length||(a.find(".bookacti-tooltip-arrow").remove(),a.append('<div class="bookacti-tooltip-arrow '+b+'"></div>'));a=a.find(".bookacti-tooltip-arrow");d=e-d.left-a.outerWidth()/2;a.css("left",d+"px")}}
function bookacti_get_min_and_max_quantity(c){var a=c.attr("id"),b=bookacti.booking_system[a],f=[],d=1,e=999999999,g=999999999,h,m,p,n;$j.each(b.picked_events,function(k,l){m=h=0;p=1;n=!1;if(0<parseInt(l.group_id)){k=l.group_id+""+l.group_date;if(-1<$j.inArray(k,f))return!0;f.push(k);"undefined"!==typeof b.groups_data&&"undefined"!==typeof b.groups_data[l.group_id]&&(k=parseInt(b.groups_data[l.group_id].category_id),"undefined"!==typeof b.group_categories_data&&"undefined"!==typeof b.group_categories_data[k]&&
"undefined"!==typeof b.group_categories_data[k].settings&&(k=b.group_categories_data[k].settings,p="undefined"===typeof k.min_bookings_per_user?1:k.min_bookings_per_user?parseInt(k.min_bookings_per_user):1,n="undefined"===typeof k.max_bookings_per_user?!1:k.max_bookings_per_user?parseInt(k.max_bookings_per_user):!1));l.group_date&&"undefined"!==typeof b.groups_bookings[l.group_id]&&"undefined"!==typeof b.groups_bookings[l.group_id][l.group_date]&&(h=parseInt(b.groups_bookings[l.group_id][l.group_date].availability),
p||n)&&(m=parseInt(b.groups_bookings[l.group_id][l.group_date].current_user_bookings))}else"undefined"!==typeof b.events_data&&"undefined"!==typeof b.events_data[l.id]&&(h=bookacti_get_event_availability(c,l),k=parseInt(b.events_data[l.id].activity_id),"undefined"!==typeof b.activities_data&&"undefined"!==typeof b.activities_data[k]&&"undefined"!==typeof b.activities_data[k].settings&&(k=b.activities_data[k].settings,p="undefined"===typeof k.min_bookings_per_user?1:k.min_bookings_per_user?parseInt(k.min_bookings_per_user):
1,n="undefined"===typeof k.max_bookings_per_user?!1:k.max_bookings_per_user?parseInt(k.max_bookings_per_user):!1,p||n))&&(k=moment.utc(l.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),"undefined"!==typeof b.bookings[l.id]&&"undefined"!==typeof b.bookings[l.id][k]&&(m=parseInt(b.bookings[l.id][k].current_user_bookings)));n=n&&0!=n&&n-m<h?Math.max(n-m,0):h;p=p&&0!=p&&1<p&&m<p?Math.max(p-m,0):1;p>d&&(d=p);n&&n<e&&(e=n);h<g&&(g=h)});a={avail:g,min:d,max:e};c.trigger("bookacti_min_and_max_quantity",
[a]);return a}
function bookacti_set_min_and_max_quantity(c,a){a="undefined"===typeof a?1:parseInt(a);var b=bookacti_get_min_and_max_quantity(c),f=c.closest("form").length?c.closest("form"):c.closest(".bookacti-form-fields");b.field=f.find('input[name="quantity"]');c.trigger("bookacti_update_quantity",[b]);if(!b.field.length)return b;f=parseInt(b.field.val());b.value=f;f>b.max&&a&&(b.value=b.max);f<b.min&&(b.min>b.avail&&(b.max=b.min),a&&(b.value=b.min));b.field.attr("min",1);b.field.removeAttr("max");c=c.attr("id");
if(!bookacti.booking_system[c].picked_events.length)return b;b.field.attr("max",b.max);b.field.attr("min",b.min);a&&b.field.val(b.value);f!==parseInt(b.value)&&b.field.trigger("bookacti_quantity_updated",[f,b]);return b}
function bookacti_format_event_duration(c,a){c=moment.utc(c).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");a=moment.utc(a).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var b=moment.utc(c).clone().locale(bookacti_localized.current_lang_code),f=moment.utc(a).clone().locale(bookacti_localized.current_lang_code);c=(a=c.substr(0,10)===a.substr(0,10))?"bookacti-booking-event-end-same-day":"";f=a?f.formatPHP(bookacti_localized.time_format):f.formatPHP(bookacti_localized.date_format);a=a?bookacti_localized.date_time_separator:
bookacti_localized.dates_separator;return'<span class="bookacti-booking-event-start">'+b.formatPHP(bookacti_localized.date_format)+'</span><span class="bookacti-booking-event-date-separator '+c+'">'+a+'</span><span class="bookacti-booking-event-end '+c+'">'+f+"</span>"}
function bookacti_get_activity_unit(c,a,b){b=$j.isNumeric(b)?parseInt(b):1;if(!a||0===b)return"";c=c.attr("id");if("undefined"===typeof bookacti.booking_system[c].activities_data||"undefined"===typeof bookacti.booking_system[c].activities_data[a])return"";a=bookacti.booking_system[c].activities_data[a];if("undefined"===typeof a.settings||"undefined"===typeof a.settings.unit_name_plural||"undefined"===typeof a.settings.unit_name_singular||""===a.settings.unit_name_plural||""===a.settings.unit_name_singular)return"";
b=1===b?a.settings.unit_name_singular:a.settings.unit_name_plural;return"undefined"===typeof a.settings.places_number||""===a.settings.places_number||0===parseInt(a.settings.places_number)?b:b+=1===parseInt(a.settings.places_number)?" "+bookacti_localized.one_person_per_booking:" "+bookacti_localized.n_people_per_booking.replace("%1$s",a.settings.places_number)}
function bookacti_clear_booking_system_displayed_info(c,a){a||bookacti_unpick_all_events(c);c.siblings(".bookacti-notices").hide();c.siblings(".bookacti-notices").empty();c.show();c.trigger("bookacti_displayed_info_cleared")}
function bookacti_get_event_number_of_bookings(c,a){c=c.attr("id");c=bookacti.booking_system[c];var b="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);a=moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var f=0;"undefined"!==typeof c.bookings&&"undefined"!==typeof c.bookings[b]&&"undefined"!==typeof c.bookings[b][a]&&"undefined"!==typeof c.bookings[b][a].quantity&&$j.isNumeric(c.bookings[b][a].quantity)&&(f=parseInt(c.bookings[b][a].quantity));return f}
function bookacti_get_event_availability(c,a){var b=c.attr("id"),f=bookacti.booking_system[b],d="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);b=0;"undefined"!==typeof a.availability&&(b=a.availability);"undefined"!==typeof f.events_data[d]&&"undefined"!==typeof f.events_data[d].availability&&$j.isNumeric(f.events_data[d].availability)&&(b=parseInt(f.events_data[d].availability));c=bookacti_get_event_number_of_bookings(c,a);return b-c}
function bookacti_is_event_available(c,a){var b=c.attr("id"),f=bookacti.booking_system[b],d=f.past_events,e=f.past_events_bookable,g="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),h=moment.utc(a.start).clone().locale("en"),m=moment.utc(a.end).clone().locale("en"),p=moment.utc(bookacti_localized.current_time),n=bookacti_get_event_availability(c,a),k=bookacti_get_availability_period(c),l=!1,q=!0;"undefined"!==typeof a.is_available&&(a.is_available||(q=!1));"undefined"!==typeof a.extendedProps&&
"undefined"!==typeof a.extendedProps.is_available&&(a.extendedProps.is_available||(q=!1));if(0>=n)return!1;c=bookacti_get_event_groups(c,a);a=0<bookacti_get_event_groups_nb(c);var r=f.groups_single_events;if("bookacti-booking-system-reschedule"===b){if(a&&!r)return!1;if(b="undefined"!==typeof f.rescheduled_bookings_data?f.rescheduled_bookings_data:[]){var B=0,C=!1,D=1;$j.each(b,function(u,v){v?.event_id==g&&v?.event_start===h.format("YYYY-MM-DD HH:mm:ss")&&v?.event_end===m.format("YYYY-MM-DD HH:mm:ss")&&
(C=!0);"undefined"!==typeof v.quantity&&parseInt(v.quantity)>D&&(D=parseInt(v.quantity));++B});if(C&&1===B||D>n)return!1}}if((!a||a&&r)&&q&&"undefined"!==typeof f.events_data[g]&&(q=!1,d&&(e||!h.isBefore(p)||bookacti_localized.started_events_bookable&&m.isAfter(p)||(q=!0),e||(k.start&&h.isBefore(moment.utc(k.start))&&(q=!0),k.end&&m.isAfter(moment.utc(k.end))&&(q=!0))),!q)){d=parseInt(f.events_data[g].activity_id);r=f.activities_data[d].settings;d=max_qty_ok=max_users_ok=!0;event_start_formatted=
h.format("YYYY-MM-DD HH:mm:ss");if("undefined"!==typeof f.bookings[g]&&"undefined"!==typeof f.bookings[g][event_start_formatted]&&(q="undefined"===typeof r.min_bookings_per_user?0:r.min_bookings_per_user?parseInt(r.min_bookings_per_user):0,b="undefined"===typeof r.max_bookings_per_user?0:r.max_bookings_per_user?parseInt(r.max_bookings_per_user):0,r="undefined"===typeof r.max_users_per_event?0:r.max_users_per_event?parseInt(r.max_users_per_event):0,q||b||r)){var H=f.bookings[g][event_start_formatted],
E=parseInt(H.current_user_bookings);r&&0===E&&H.distinct_users>=r&&(max_users_ok=!1);b&&E>=b&&(max_qty_ok=!1);q&&q>n+E&&(d=!1)}d&&max_qty_ok&&max_users_ok&&(l=!0)}a&&!l&&$j.each(c,function(u,v){var I=f.groups_data[u],K=parseInt(I.category_id),t=f.group_categories_data[K].settings,J=parseInt(bookacti_localized.started_groups_bookable);"undefined"!==typeof t.started_groups_bookable&&0<=$j.inArray(t.started_groups_bookable,[0,1,"0","1",!0,!1])&&(J=$j.isNumeric(t.started_groups_bookable)?parseInt(t.started_groups_bookable):
t.started_groups_bookable?1:0);$j.each(v,function(w,x){var y=moment.utc(x[0].start).clone();x=moment.utc(x[x.length-1].end).clone();if(!(e||!y.isBefore(p)||J&&x.isAfter(p))||!e&&(k.start&&y.isBefore(moment.utc(k.start))||k.end&&y.isAfter(moment.utc(k.end))))return!0;var z;var A=y=z=x=0;"undefined"!==typeof f.groups_bookings[u]&&"undefined"!==typeof f.groups_bookings[u][w]&&(A=f.groups_bookings[u][w].is_available,y=f.groups_bookings[u][w].availability,z=f.groups_bookings[u][w].current_user_bookings,
x=f.groups_bookings[u][w].distinct_users);if(A&&0<y){w=max_qty_ok=max_users_ok=!0;if(null!=I){A="undefined"===typeof t.max_users_per_event?0:t.max_users_per_event?parseInt(t.max_users_per_event):0;var F="undefined"===typeof t.max_bookings_per_user?0:t.max_bookings_per_user?parseInt(t.max_bookings_per_user):0,G="undefined"===typeof t.min_bookings_per_user?0:t.min_bookings_per_user?parseInt(t.min_bookings_per_user):0;if(G||F||A)z=parseInt(z),A&&0===z&&parseInt(x)>=A&&(max_users_ok=!1),F&&z>=F&&(max_qty_ok=
!1),G&&G>y+z&&(w=!1)}if(w&&max_qty_ok&&max_users_ok)return l=!0,!1}})});return l}function bookacti_get_bookings_number_for_a_single_grouped_event(c,a,b){b=$j.isEmptyObject(b)?bookacti_get_event_groups(c,a):b;var f=c.attr("id"),d=bookacti.booking_system[f];c=bookacti_get_event_number_of_bookings(c,a);var e=0;$j.each(b,function(g,h){$j.each(h,function(m,p){"undefined"!==typeof d.groups_bookings[g]&&"undefined"!==typeof d.groups_bookings[g][m]&&(e+=d.groups_bookings[g][m].quantity)})});return c-e}
function bookacti_get_event_availability_div(c,a){var b=c.attr("id"),f=1==bookacti.booking_system[b].bookings_only?!0:!1,d=bookacti_get_event_availability(c,a),e="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),g=bookacti.booking_system[b].events_data?.[e]?.activity_id,h=bookacti.booking_system[b].events_data?.[e]?.availability,m=bookacti.booking_system[b].activities_data?.[g]?.settings?.show_unit_in_availability;m="undefined"===typeof m?0:parseInt(m);var p=1===d?bookacti.booking_system[b].activities_data?.[g]?.settings?.unit_name_singular:
bookacti.booking_system[b].activities_data?.[g]?.settings?.unit_name_plural;e=1<d?bookacti_localized.avails:bookacti_localized.avail;h||=0;p&&m||(p="");var n=(d<h?"bookacti-booked":"bookacti-not-booked")+(0>=d?" bookacti-full":"");var k="",l=h?parseInt(d/h*100):0;h=parseInt(bookacti.booking_system[b].hide_availability);var q=parseInt(bookacti_localized.hide_availability_fixed);l=100>h&&l>h;var r=0<q&&d>q;if(!f){if(0>=q&&l||100<=h&&r||l&&r)d="",k="bookacti-hide-availability";!bookacti_is_event_available(c,
a)&&0<d&&(n+=" bookacti-not-bookable","{current}"!==bookacti_localized.not_bookable&&(bookacti_localized.not_bookable?(p=d="",e=bookacti_localized.not_bookable):(d=0,p=bookacti.booking_system[b].activities_data?.[g]?.settings?.unit_name_plural,e=bookacti_localized.avails,p&&m||(p=""))))}a="";p&&(a="bookacti-has-unit-name");c=$j("<div></div>",{"class":"bookacti-availability-container "+k});n=$j("<div></div>",{"class":"bookacti-available-places "+n});d=$j("<span></span>",{"class":"bookacti-available-places-number",
html:d});p=$j("<span></span>",{"class":"bookacti-available-places-unit-name "+a,html:p});e=$j("<span></span>",{"class":"bookacti-available-places-avail-particle",html:e});n.append(d);n.append(p);n.append(e);c.append(n);return c}
function bookacti_get_event_number_of_bookings_div(c,a){var b=c.attr("id"),f=bookacti_get_event_number_of_bookings(c,a);c=bookacti_get_event_availability(c,a);a="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);var d=0;"undefined"!==typeof bookacti.booking_system[b].events_data[a]&&"undefined"!==typeof bookacti.booking_system[b].events_data[a].availability&&(d=bookacti.booking_system[b].events_data[a].availability);c=(0===d?"bookacti-no-availability":"")+(0<f?" bookacti-booked":" bookacti-not-booked")+
(0>=c?" bookacti-full":"");b=$j("<div></div>",{"class":"bookacti-availability-container"});c=$j("<div></div>",{"class":"bookacti-available-places "+c});f=$j("<span></span>",{"class":"bookacti-active-bookings-number",html:f});c.append(f);b.append(c);return b}
function bookacti_sort_events_array_by_dates(c,a,b,f){a=a||!1;b=b||!1;f=f||{start:"start",end:"end"};c.sort(function(d,e){a||d[f.start]===e[f.start]?(d=moment.utc(d[f.end]),e=moment.utc(e[f.end])):(d=moment.utc(d[f.start]),e=moment.utc(e[f.start]));var g=0;d.isAfter(e)&&(g=1);d.isBefore(e)&&(g=-1);!0===b&&(g*=-1);return g});return c}
function bookacti_booking_method_set_up(c,a){a=a?1:0;var b=c.attr("id");booking_method=bookacti.booking_system[b].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");bookacti.booking_system[b].no_events||(c.trigger("bookacti_booking_method_set_up",[booking_method,a]),bookacti.booking_system[b].picked_events.length&&"undefined"!==typeof bookacti.booking_system[b].events&&(bookacti_set_min_and_max_quantity(c),bookacti_fill_picked_events_list(c)))}
function bookacti_booking_method_update_availability_period(c){var a=c.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");a=bookacti_get_availability_period(c);c.trigger("bookacti_booking_method_update_availability_period",[booking_method,a])}
function bookacti_booking_method_display_events(c,a){var b=c.attr("id");booking_method=bookacti.booking_system[b].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");c.trigger("bookacti_booking_method_display_events",[booking_method,a])}
function bookacti_booking_method_refetch_events(c){var a=c.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");c.trigger("bookacti_refetch_events",[booking_method])}
function bookacti_booking_method_rerender_events(c){var a=c.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");c.trigger("bookacti_rerender_events",[booking_method])}
function bookacti_booking_method_clear_events(c){var a=c.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");bookacti.booking_system[a].events=[];bookacti.booking_system[a].events_data=[];bookacti.booking_system[a].events_interval=[];c.trigger("bookacti_clear_events",[booking_method])}
function bookacti_start_loading_booking_system(c){var a=c.attr("id");if("undefined"!==typeof bookacti.booking_system[a]){var b=bookacti.booking_system[a].method;-1===$j.inArray(b,bookacti_localized.available_booking_methods)&&(b="calendar");$j.isNumeric(bookacti.booking_system[a].loading_number)||(bookacti.booking_system[a].loading_number=0);c.trigger("bookacti_start_loading",[b]);bookacti.booking_system[a].loading_number++}}
function bookacti_stop_loading_booking_system(c,a){a=a?a:!1;var b=c.attr("id");if("undefined"!==typeof bookacti.booking_system[b]){var f=bookacti.booking_system[b].method;-1===$j.inArray(f,bookacti_localized.available_booking_methods)&&(f="calendar");bookacti.booking_system[b].loading_number--;bookacti.booking_system[b].loading_number=Math.max(bookacti.booking_system[b].loading_number,0);a&&(bookacti.booking_system[b].loading_number=0);0===bookacti.booking_system[b].loading_number&&c.trigger("bookacti_exit_loading_state",
[f,a])}}function bookacti_redirect_to_activity_url(c,a){var b=c.attr("id");b=bookacti.booking_system[b];a="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);"undefined"!==typeof b.events_data[a]&&(a=b.events_data[a].activity_id,"undefined"!==typeof b.redirect_url_by_activity[a]&&bookacti_redirect_booking_system_to_url(c,b.redirect_url_by_activity[a]))}
function bookacti_redirect_to_group_category_url(c,a){var b=c.attr("id");b=bookacti.booking_system[b];"undefined"!==typeof b.groups_data[a]&&(a=b.groups_data[a].category_id,"undefined"!==typeof b.redirect_url_by_group_category[a]&&bookacti_redirect_booking_system_to_url(c,b.redirect_url_by_group_category[a]))}
function bookacti_redirect_booking_system_to_url(c,a){if(a){var b=c.closest("form").length?c.closest("form"):c.closest(".bookacti-form-fields"),f=b.find('input[type="submit"]');f.length&&f.prop("disabled",!0);bookacti_start_loading_booking_system(c);f.length&&bookacti_add_loading_html(f,"after");var d=bookacti_is_url_external(a)?1:0,e=bookacti_get_url_parameter("method",a).toUpperCase(),g="JS"===e||d&&!e?1:0;0>$j.inArray(e,["POST","GET"])&&(e=d?"GET":"POST");d={method:e,action:a,id:"","class":"bookacti-temporary-form",
"data-redirect-timeout":15E3,"data-redirect-with-js":g};c.trigger("bookacti_before_redirect",[d]);if(1===d["data-redirect-with-js"])window.location.assign(a);else if(c.closest("form").length){var h={};$j.each(d,function(m,p){h[m]=b.attr(m)});b.attr(d);b.submit();b.attr(h)}else c.closest(".bookacti-form-fields").wrap("<form></form>"),c.closest("form").attr(d).submit(),c.closest(".bookacti-form-fields").unwrap("form");c.trigger("bookacti_after_redirect",[d]);setTimeout(function(){bookacti_stop_loading_booking_system(c);
f.length&&(bookacti_remove_loading_html(c),f.prop("disabled",!1))},d["data-redirect-timeout"])}};
