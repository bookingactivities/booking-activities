function bookacti_fetch_events(b,d){var a=b.attr("id");var c=bookacti.booking_system[a];d=d||c.events_interval;bookacti.booking_system[a]["events_interval"]=bookacti_get_extended_events_interval(b,d);bookacti_start_loading_booking_system(b);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiFetchEvents",attributes:JSON.stringify(c),is_admin:bookacti_localized.is_admin?1:0,interval:d},dataType:"json",success:function(e){if(e.status==="success"){if($j.isEmptyObject(bookacti.booking_system[a]["events"])){bookacti.booking_system[a]["events"]=e.events}else{$j.extend(bookacti.booking_system[a]["events"],e.events)}if($j.isEmptyObject(bookacti.booking_system[a]["events_data"])){bookacti.booking_system[a]["events_data"]=e.events_data}else{$j.extend(bookacti.booking_system[a]["events_data"],e.events_data)}if($j.isEmptyObject(bookacti.booking_system[a]["booking_lists"])){bookacti.booking_system[a]["booking_lists"]=e.booking_lists}else{$j.extend(true,bookacti.booking_system[a]["booking_lists"],e.booking_lists)}if(e.events.length){bookacti_booking_method_display_events(b,e.events)}}else{var f=typeof e.message!=="undefined"?e.message:bookacti_localized.error;console.log(f);console.log(e)}},error:function(f){console.log("AJAX "+bookacti_localized.error);console.log(f)},complete:function(){bookacti_stop_loading_booking_system(b)}})}function bookacti_reload_booking_system(c,a){a=a||false;var b=c.attr("id");var g=$j.extend(true,{},bookacti.booking_system[b]);var d=$j.extend(true,{},bookacti.booking_system[b]);var h=a?d.picked_events:[];var f=typeof d.rescheduled_booking_data!=="undefined"?d.rescheduled_booking_data:[];var e=typeof d.templates_per_activities!=="undefined"?d.templates_per_activities:[];delete d.events;delete d.events_data;delete d.events_interval;delete d.bookings;delete d.activities_data;delete d.groups_events;delete d.groups_data;delete d.group_categories_data;delete d.picked_events;delete d.rescheduled_booking_data;delete d.templates_per_activities;bookacti_start_loading_booking_system(c);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiReloadBookingSystem",attributes:JSON.stringify(d),is_admin:bookacti_localized.is_admin?1:0},dataType:"json",success:function(i){if(i.status==="success"){c.empty();bookacti_clear_booking_system_displayed_info(c,a);bookacti.booking_system[b]=i.booking_system_data;bookacti.booking_system[b]["picked_events"]=h;if(f){bookacti.booking_system[b]["rescheduled_booking_data"]=f}if(e){bookacti.booking_system[b]["templates_per_activities"]=e}c.append(i.html_elements);c.trigger("bookacti_booking_system_reloaded",g);bookacti_booking_method_set_up(c)}else{var j=typeof i.message!=="undefined"?i.message:bookacti_localized.error;console.log(j);console.log(i)}},error:function(i){console.log("AJAX "+bookacti_localized.error);console.log(i)},complete:function(){bookacti_stop_loading_booking_system(c)}})}function bookacti_fetch_events_from_interval(e,d){var j=e.attr("id");var k=bookacti.booking_system[j]["events_interval"];var n=bookacti_get_availability_period(e);var p=moment.utc(n.start);var a=moment.utc(n.end);var h=moment.utc(d.start).clone();var f=moment.utc(d.end).clone();if(h.isBefore(p)){h=p.clone()}if(f.isAfter(a)){f=a.clone()}var l=false;var o=parseInt(bookacti_localized.event_load_interval);var r={start:h.clone(),end:f.clone()};if($j.isEmptyObject(k)){l=bookacti_get_new_interval_of_events(e,r,o)}else{var c=moment.utc(k.start);var q=moment.utc(k.end);if(h.isBefore(c)||f.isAfter(q)){var g=c.clone();var i=q.clone();var b=moment.utc(d.start).clone().subtract(1,"days");var m=moment.utc(d.end).clone().add(1,"days");if(((h.isBefore(c)&&f.isAfter(q))||(f.isBefore(c))||(h.isAfter(q)))&&b.format("YYYY-MM-DD")+" 23:59:59"!==q.format("YYYY-MM-DD HH:mm:ss")&&m.format("YYYY-MM-DD")+" 00:00:00"!==c.format("YYYY-MM-DD HH:mm:ss")){bookacti_booking_method_clear_events(e);l=bookacti_get_new_interval_of_events(e,r,o)}else{if(h.isBefore(c)||m.format("YYYY-MM-DD")+" 00:00:00"===c.format("YYYY-MM-DD HH:mm:ss")){g.subtract(o,"days");if(h.isBefore(g)){g=h.clone()}if(g.isBefore(p)){g=p.clone()}i=moment.utc(c.clone().subtract(1,"days").format("YYYY-MM-DD")+" 23:59:59")}else{if(f.isAfter(q)||b.format("YYYY-MM-DD")+" 23:59:59"===q.format("YYYY-MM-DD HH:mm:ss")){i.add(o,"days");if(f.isAfter(i)){i=f.clone()}if(i.isAfter(a)){i=a.clone()}g=moment.utc(q.clone().add(1,"days").format("YYYY-MM-DD")+" 00:00:00")}}l={start:g.format("YYYY-MM-DD HH:mm:ss"),end:i.format("YYYY-MM-DD HH:mm:ss")}}}}if(l!==false){if(j==="bookacti-template-calendar"){bookacti_fetch_events_on_template(null,l)}else{bookacti_fetch_events(e,l)}}}function bookacti_get_new_interval_of_events(b,i,l){var n=b.attr("id");var e=bookacti_get_availability_period(b);if(typeof e.start==="undefined"||typeof e.end==="undefined"){return{}}var p=bookacti.booking_system[n]["past_events"];var f=moment.utc(bookacti_localized.current_time);var g=f.format("YYYY-MM-DD HH:mm:ss");var k=moment.utc(e.start);var c=moment.utc(e.end);if(!p&&c.isBefore(f)){return[]}if($j.isEmptyObject(i)){if(k.isAfter(f)){i={start:e.start,end:e.start}}else{if(c.isBefore(f)){i={start:e.end,end:e.end}}else{i={start:g,end:g}}}}l=parseInt(l)||parseInt(bookacti_localized.event_load_interval);var o=moment.utc(moment.utc(i.start).format("YYYY-MM-DD")+" 00:00:00");var a=moment.utc(moment.utc(i.end).format("YYYY-MM-DD")+" 23:59:59");var h=parseInt(Math.abs(moment.utc(i.end).diff(i.start,"days")));if(h>l){l=h}var m=Math.round((l-h)/2);var j=m;if(p){o.subtract(m,"days");if(k.isAfter(o)){j+=Math.abs(o.diff(k,"days"))}}else{j+=m}if(k.isAfter(o)){o=k.clone()}a.add(j,"days");if(c.isBefore(a)){a=c}var d={start:o.format("YYYY-MM-DD HH:mm:ss"),end:a.format("YYYY-MM-DD HH:mm:ss")};return d}function bookacti_get_extended_events_interval(b,c){var a=b.attr("id");var e=bookacti.booking_system[a]["events_interval"];if($j.isEmptyObject(c)){return e}var d=[];if($j.isEmptyObject(e)){d={start:c.start,end:c.end}}else{d={start:moment.utc(c.start).isBefore(moment.utc(e.start))?c.start:e.start,end:moment.utc(c.end).isAfter(moment.utc(e.end))?c.end:e.end}}return d}function bookacti_get_availability_period(b){var a=b.attr("id");var c=bookacti.booking_system[a];return{start:c.start,end:c.end}}function bookacti_refresh_booking_numbers(b,d){d=d||null;if(d&&!$j.isArray(d)){d=[d]}var a=b.attr("id");var c=bookacti.booking_system[a]["calendars"];if(a==="bookacti-template-calendar"){bookacti_start_template_loading()}else{bookacti_start_loading_booking_system(b)}$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingNumbers",template_id:c,event_id:d},dataType:"json",success:function(e){if(e.status==="success"){if(d!=null){$j.each(d,function(f,g){if(bookacti.booking_system[a]["bookings"][g]){delete bookacti.booking_system[a]["bookings"][g]}bookacti.booking_system[a]["bookings"][g]=e.bookings[g]})}else{bookacti.booking_system[a]["bookings"]=e.bookings}bookacti_booking_method_rerender_events(b)}},error:function(f){alert("AJAX "+bookacti_localized.error);console.log(f)},complete:function(){if(a==="bookacti-template-calendar"){bookacti_stop_template_loading()}else{bookacti_stop_loading_booking_system(b)}}})}function bookacti_event_click(b,e){var a=b.attr("id");var c="single";if(a!=="bookacti-booking-system-reschedule"){c=bookacti_get_event_group_ids(b,e)}var d=false;if($j.isArray(c)&&((c.length>1)||(c.length===1&&bookacti.booking_system[a]["groups_single_events"]))){d=true;bookacti_dialog_choose_group_of_events(b,c,e)}else{bookacti_pick_events_of_group(b,c,e);if(!d&&$j.isArray(c)){b.trigger("bookacti_group_of_events_chosen",[c[0],e])}}c=$j.isArray(c)&&c.length===1?c[0]:c;b.trigger("bookacti_event_click",[e,c,d])}function bookacti_get_event_group_ids(b,f){if(typeof f!=="object"){return false}else{if(typeof f.id==="undefined"||typeof f.start==="undefined"||typeof f.end==="undefined"){return false}}var a=b.attr("id");var g=f.id;var e=f.start instanceof moment?f.start.format("YYYY-MM-DD HH:mm:ss"):f.start;var c=f.end instanceof moment?f.end.format("YYYY-MM-DD HH:mm:ss"):f.end;var d=[];$j.each(bookacti.booking_system[a]["groups_events"],function(h,i){$j.each(i,function(j,k){if(k.id==g&&k.start===e&&k.end===c){d.push(h);return false}})});if(!d.length){d="single"}return d}function bookacti_fill_booking_system_fields(b,d,c){c=$j.isArray(c)&&c.length===1?c[0]:c;c=$j.isNumeric(c)||c==="single"?c:false;var e=d.start instanceof moment?d.start.format("YYYY-MM-DD HH:mm:ss"):d.start;var a=d.end instanceof moment?d.end.format("YYYY-MM-DD HH:mm:ss"):d.end;if(c!==false){b.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_group_id"]').val(c)}b.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_id"]').val(d.id);b.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_start"]').val(e);b.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_end"]').val(a)}function bookacti_pick_events_of_group(b,d,c){d=$j.isArray(d)&&d.length===1?d[0]:d;d=$j.isNumeric(d)||d==="single"?d:false;if(d==="single"&&typeof c!=="object"){return false}if(!d&&typeof c!=="object"){return false}if(!d&&typeof c==="object"){d="single"}var a=b.attr("id");bookacti_unpick_all_events(b);if(d==="single"){bookacti_pick_event(b,c)}else{$j.each(bookacti.booking_system[a]["groups_events"][d],function(f,e){bookacti_pick_event(b,e,d)})}b.trigger("bookacti_events_picked",[d,c])}function bookacti_pick_event(b,d,c){c=c||false;var a=b.attr("id");if((typeof d!=="object")||(typeof d==="object"&&(typeof d.id==="undefined"||typeof d.start==="undefined"))){return false}var e={id:d.id,title:d.title,start:moment.utc(d.start).format("YYYY-MM-DD HH:mm:ss"),end:moment.utc(d.end).format("YYYY-MM-DD HH:mm:ss"),group_id:c};bookacti.booking_system[a]["picked_events"].push(e);b.trigger("bookacti_pick_event",[d])}function bookacti_unpick_event(b,e,g,d){var a=b.attr("id");d=d?true:false;g=typeof g!=="undefined"?g:false;if((typeof e!=="object"&&!$j.isNumeric(e))||(typeof e==="object"&&(typeof e.id==="undefined"||typeof e.start==="undefined"))||($j.isNumeric(e)&&!d&&typeof g==="undefined")){return false}if(!g&&typeof e==="object"){g=d?false:e.start}var c={id:typeof e==="object"?e.id:e,start:moment.utc(g).format("YYYY-MM-DD HH:mm:ss")};var f=$j.grep(bookacti.booking_system[a]["picked_events"],function(h){if(h.id==c.id&&(d||h.start.substr(0,10)===c.start.substr(0,10))){return false}return true});bookacti.booking_system[a]["picked_events"]=f;b.trigger("bookacti_unpick_event",[e,d])}function bookacti_unpick_all_events(b){var a=b.attr("id");bookacti.booking_system[a]["picked_events"]=[];b.trigger("bookacti_unpick_all_events")}function bookacti_fill_picked_events_list(c){var b=c.attr("id");var d=c.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list-title");var a=c.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list");a.empty();if(typeof bookacti.booking_system[b]["picked_events"]==="undefined"){return}if(!bookacti.booking_system[b]["picked_events"].length){return}var e=bookacti.booking_system[b]["picked_events"].length===1?bookacti_localized.selected_event:bookacti_localized.selected_events;d.html(e);$j.each(bookacti.booking_system[b]["picked_events"],function(h,n){var g=bookacti_format_event_duration(n.start,n.end);var f={title:n.title,duration:g,quantity:1};c.trigger("bookacti_picked_events_list_data",[f,n]);var j=0;if(typeof bookacti.booking_system[b]["events_data"]!=="undefined"){if(typeof bookacti.booking_system[b]["events_data"][n.id]!=="undefined"){j=bookacti.booking_system[b]["events_data"][n.id]["activity_id"]}}var m=bookacti_get_activity_unit(c,j,f.quantity);if(m!==""){m='<span class="bookacti-booking-event-quantity-separator" > - </span><span class="bookacti-booking-event-quantity" >'+m+"</span>"}var l={html:'<span class="bookacti-booking-event-title" >'+f.title+'</span><span class="bookacti-booking-event-title-separator" > - </span>'+f.duration+m};c.trigger("bookacti_picked_events_list_element_data",[l,n]);var k=$j("<li></li>",l);a.append(k)});c.siblings(".bookacti-picked-events").show();c.trigger("bookacti_picked_events_list_filled")}function bookacti_set_tooltip_position(c,d,e){e=$j.inArray(e,["below","above"])>=0?e:"below";d.css("position","absolute");var h=$j(window).width();if(d.outerWidth()>h){d.outerWidth(h)}var g=c.offset();var b=c.offset().left+(c.outerWidth()/2);g.top+=e==="above"?((d.outerHeight()+15)*-1):c.height()+15;g.left=b-(d.outerWidth()/2);if(g.left<0){g.left=0}var a=g.left+d.outerWidth();if(a>h){g.left-=(a-h)}d.offset(g);var j=e==="above"?"bookacti-tooltip-arrow-bottom":"bookacti-tooltip-arrow-top";if(!d.find(".bookacti-tooltip-arrow."+j).length){d.find(".bookacti-tooltip-arrow").remove();d.append('<div class="bookacti-tooltip-arrow '+j+'"></div>')}var f=d.find(".bookacti-tooltip-arrow");var i=b-g.left-(f.outerWidth()/2);f.css("left",i+"px")}function bookacti_set_min_and_max_quantity(f,d,l){var j=f.attr("id");var g=parseInt(d.val());var b=parseInt(d.val());var k=0;var n=0;var s=1;var c=false;if($j.isNumeric(f.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_group_id"]').val())){var p=f.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_group_id"]').val();if(typeof bookacti.booking_system[j]["groups_data"]!=="undefined"){if(typeof bookacti.booking_system[j]["groups_data"][p]!=="undefined"){var a=parseInt(bookacti.booking_system[j]["groups_data"][p]["category_id"]);if(typeof bookacti.booking_system[j]["group_categories_data"]!=="undefined"){if(typeof bookacti.booking_system[j]["group_categories_data"][a]!=="undefined"){if(typeof bookacti.booking_system[j]["group_categories_data"][a]["settings"]!=="undefined"){var r=bookacti.booking_system[j]["group_categories_data"][a]["settings"];s=typeof r.min_bookings_per_user==="undefined"?1:(r.min_bookings_per_user?parseInt(r.min_bookings_per_user):1);c=typeof r.max_bookings_per_user==="undefined"?false:(r.max_bookings_per_user?parseInt(r.max_bookings_per_user):false);k=bookacti.booking_system[j]["groups_data"][p]["availability"];if(s||c){n=parseInt(bookacti.booking_system[j]["groups_data"][p]["current_user_bookings"])}}}}}}}else{var q=bookacti.booking_system[j]["picked_events"][0];var i=parseInt(q.id);if(typeof bookacti.booking_system[j]["events_data"]!=="undefined"){if(typeof bookacti.booking_system[j]["events_data"][i]!=="undefined"){var h=parseInt(bookacti.booking_system[j]["events_data"][i]["activity_id"]);if(typeof bookacti.booking_system[j]["activities_data"]!=="undefined"){if(typeof bookacti.booking_system[j]["activities_data"][h]!=="undefined"){if(typeof bookacti.booking_system[j]["activities_data"][h]["settings"]!=="undefined"){var o=bookacti.booking_system[j]["activities_data"][h]["settings"];s=typeof o.min_bookings_per_user==="undefined"?1:(o.min_bookings_per_user?parseInt(o.min_bookings_per_user):1);c=typeof o.max_bookings_per_user==="undefined"?false:(o.max_bookings_per_user?parseInt(o.max_bookings_per_user):false);k=bookacti_get_event_availability(f,q);if(s||c){var e=moment.utc(q.start).format("YYYY-MM-DD HH:mm:ss");if(typeof bookacti.booking_system[j]["bookings"][q.id]!=="undefined"){if(typeof bookacti.booking_system[j]["bookings"][q.id][e]!=="undefined"){var m=bookacti.booking_system[j]["bookings"][q.id][e];n=parseInt(m.current_user_bookings)}}}}}}}}}c=c&&c!=0&&(c-n)<k?Math.max((c-n),0):k;d.attr("max",c);if(g>c){d.val(c);b=c}s=s&&s!=0&&s>1&&n<s?Math.max((s-n),0):1;d.attr("min",s);if(g<s){if(s>k){d.attr("max",s)}d.val(s);b=s}l.quantity=b;if(g!==b){d.trigger("bookacti_quantity_updated",[g,l])}}function bookacti_format_event_duration(a,c){a=a instanceof moment?a.format("YYYY-MM-DD HH:mm:ss"):a;c=c instanceof moment?c.format("YYYY-MM-DD HH:mm:ss"):c;var b=moment.utc(a).locale(bookacti_localized.current_lang_code);var f=moment.utc(c).locale(bookacti_localized.current_lang_code);var i=a.substr(0,10)===c.substr(0,10);var g=i?"bookacti-booking-event-end-same-day":"";var h=i?f.formatPHP(bookacti_localized.time_format):f.formatPHP(bookacti_localized.date_format);var d=i?bookacti_localized.date_time_separator:bookacti_localized.dates_separator;var e='<span class="bookacti-booking-event-start">'+b.formatPHP(bookacti_localized.date_format)+'</span><span class="bookacti-booking-event-date-separator '+g+'">'+d+'</span><span class="bookacti-booking-event-end '+g+'">'+h+"</span>";return e}function bookacti_get_activity_unit(b,c,f){f=$j.isNumeric(f)?parseInt(f):1;if(!c||f===0){return""}var a=b.attr("id");if(typeof bookacti.booking_system[a]["activities_data"]==="undefined"){return""}if(typeof bookacti.booking_system[a]["activities_data"][c]==="undefined"){return""}var e=bookacti.booking_system[a]["activities_data"][c];if(typeof e.settings==="undefined"){return""}if(typeof e.settings["unit_name_plural"]==="undefined"||typeof e.settings["unit_name_singular"]==="undefined"){return""}if(e.settings["unit_name_plural"]===""||e.settings["unit_name_singular"]===""){return""}var d=f+" ";d+=f===1?e.settings["unit_name_singular"]:e.settings["unit_name_plural"];if(typeof e.settings["places_number"]==="undefined"){return d+"<br/>"}if(e.settings["places_number"]===""||parseInt(e.settings["places_number"])===0){return d+"<br/>"}d+=" ";d+=parseInt(e.settings["places_number"])===1?bookacti_localized.one_person_per_booking:bookacti_localized.n_people_per_booking.replace("%1$s",e.settings["places_number"]);d+="<br/>";return d}function bookacti_clear_booking_system_displayed_info(b,a){a=a||false;if(!a){b.siblings(".bookacti-booking-system-inputs").find("input").val("");b.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list").empty();b.siblings(".bookacti-picked-events").hide();bookacti_unpick_all_events(b)}b.siblings(".bookacti-notices").hide();b.siblings(".bookacti-notices").empty();b.show();b.trigger("bookacti_displayed_info_cleared")}function bookacti_get_event_number_of_bookings(b,d){var a=b.attr("id");var c=moment.utc(d.start).format("YYYY-MM-DD HH:mm:ss");if(typeof bookacti.booking_system[a]["bookings"]==="undefined"){return 0}if(typeof bookacti.booking_system[a]["bookings"][d.id]==="undefined"){return 0}if(typeof bookacti.booking_system[a]["bookings"][d.id][c]==="undefined"){return 0}if(typeof bookacti.booking_system[a]["bookings"][d.id][c]["quantity"]==="undefined"){return 0}if(!$j.isNumeric(bookacti.booking_system[a]["bookings"][d.id][c]["quantity"])){return 0}return parseInt(bookacti.booking_system[a]["bookings"][d.id][c]["quantity"])}function bookacti_get_event_availability(b,c){var a=b.attr("id");var d=0;if(typeof c.availability!=="undefined"){d=c.availability}if(typeof bookacti.booking_system[a]["events_data"][c.id]!=="undefined"){d=bookacti.booking_system[a]["events_data"][c.id]["availability"]}var e=bookacti_get_event_number_of_bookings(b,c);return parseInt(d)-parseInt(e)}function bookacti_is_event_available(e,s){var l=e.attr("id");var v=bookacti.booking_system[l]["past_events"];var i=bookacti.booking_system[l]["past_events_bookable"];var j=moment.utc(bookacti_localized.current_time);var a=moment.utc(s.start).clone();var g=moment.utc(s.end).clone();var m=bookacti_get_event_availability(e,s);var u=bookacti_get_availability_period(e);var n=false;if(m<=0){return false}var c=bookacti_get_event_group_ids(e,s);var r=$j.isArray(c)&&c.length>0;var h=bookacti.booking_system[l]["groups_single_events"];if(l==="bookacti-booking-system-reschedule"){if(r&&!h){return false}var f=typeof bookacti.booking_system[l]["rescheduled_booking_data"]!=="undefined"?bookacti.booking_system[l]["rescheduled_booking_data"]:[];if(typeof f.event_id!=="undefined"&&typeof f.event_start!=="undefined"&&typeof f.event_end!=="undefined"){if(f.event_id==s.id&&f.event_start===a.format("YYYY-MM-DD HH:mm:ss")&&f.event_end===g.format("YYYY-MM-DD HH:mm:ss")){return false}}if(typeof f.quantity!=="undefined"){if(parseInt(f.quantity)>m){return false}}}if((!r||(r&&h))&&typeof bookacti.booking_system[l]["events_data"][s.id]!=="undefined"){var o=false;if(v){if(!i&&a.isBefore(j)&&!(bookacti_localized.started_events_bookable&&g.isAfter(j))){o=true}if(!i&&(a.isBefore(moment.utc(u.start))||g.isAfter(moment.utc(u.end)))){o=true}}if(!o){var k=parseInt(bookacti.booking_system[l]["events_data"][s.id]["activity_id"]);var q=bookacti.booking_system[l]["activities_data"][k]["settings"];var x=max_qty_ok=max_users_ok=true;event_start_formatted=a.format("YYYY-MM-DD HH:mm:ss");if(typeof bookacti.booking_system[l]["bookings"][s.id]!=="undefined"){if(typeof bookacti.booking_system[l]["bookings"][s.id][event_start_formatted]!=="undefined"){var w=typeof q.min_bookings_per_user==="undefined"?0:(q.min_bookings_per_user?parseInt(q.min_bookings_per_user):0);var b=typeof q.max_bookings_per_user==="undefined"?0:(q.max_bookings_per_user?parseInt(q.max_bookings_per_user):0);var d=typeof q.max_users_per_event==="undefined"?0:(q.max_users_per_event?parseInt(q.max_users_per_event):0);if(w||b||d){var p=bookacti.booking_system[l]["bookings"][s.id][event_start_formatted];var t=parseInt(p.current_user_bookings);if(d&&t===0&&p.distinct_users>=d){max_users_ok=false}if(b&&t>=b){max_qty_ok=false}if(w&&w>m+t){x=false}}}}if(x&&max_qty_ok&&max_users_ok){n=true}}}if(r&&!n){$j.each(c,function(C,J){var I=bookacti.booking_system[l]["groups_data"][J];var z=parseInt(I.category_id);var F=bookacti.booking_system[l]["group_categories_data"][z]["settings"];var A=bookacti_localized.started_groups_bookable;if(typeof F.started_groups_bookable!=="undefined"){if($j.inArray(F.started_groups_bookable,[0,1,"0","1",true,false])>=0){A=parseInt(F.started_groups_bookable)}}var K=moment.utc(I.start).clone();var y=moment.utc(I.end).clone();if(!i&&K.isBefore(j)&&!(A&&y.isAfter(j))){return true}if(!i&&(K.isBefore(moment.utc(u.start))||y.isAfter(moment.utc(u.end)))){return true}var E=bookacti.booking_system[l]["groups_data"][J]["availability"];if(E>0){var B=max_qty_ok=max_users_ok=true;if(I!=null){var L=typeof F.max_users_per_event==="undefined"?0:(F.max_users_per_event?parseInt(F.max_users_per_event):0);var H=typeof F.max_bookings_per_user==="undefined"?0:(F.max_bookings_per_user?parseInt(F.max_bookings_per_user):0);var G=typeof F.min_bookings_per_user==="undefined"?0:(F.min_bookings_per_user?parseInt(F.min_bookings_per_user):0);if(G||H||L){var D=parseInt(I.current_user_bookings);if(L&&D===0&&I.distinct_users>=L){max_users_ok=false}if(H&&D>=H){max_qty_ok=false}if(G&&G>E+D){B=false}}}if(B&&max_qty_ok&&max_users_ok){n=true;return false}}})}return n}function bookacti_get_bookings_number_for_a_single_grouped_event(a,b,g){var h=a.attr("id");g=g||bookacti_get_event_group_ids(a,b);var c=b.start instanceof moment?b.start.format("YYYY-MM-DD HH:mm:ss"):b.start;var d=b.end instanceof moment?b.end.format("YYYY-MM-DD HH:mm:ss"):b.end;var f=bookacti_get_event_number_of_bookings(a,b);var i=bookacti.booking_system[h]["groups_events"];var e=0;$j.each(g,function(j,k){$j.each(i[k],function(m,l){if(b.id===l.id&&c===l.start&&d===l.end){e+=parseInt(l.group_bookings)}})});return f-e}function bookacti_get_event_availability_div(a,c){var j=a.attr("id");var h=bookacti_get_event_availability(a,c);var d="";var k=bookacti.booking_system[j]["events_data"][c.id]["activity_id"];if(k){var g=bookacti.booking_system[j]["activities_data"][k];if(g!==undefined){if(g.settings!==undefined){if(g.settings["unit_name_plural"]!==undefined&&g.settings["unit_name_singular"]!==undefined&&g.settings["show_unit_in_availability"]!==undefined){if(parseInt(g.settings["show_unit_in_availability"])){if(h===1){d=g.settings["unit_name_singular"]}else{d=g.settings["unit_name_plural"]}}}}}}var f=h>1?bookacti_localized.avails:bookacti_localized.avail;var e=bookacti.booking_system[j]["events_data"][c.id]["availability"];var l=h<e?"bookacti-booked":"bookacti-not-booked";var i=h<=0?"bookacti-full":"";var b='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+l+" "+i+'" ><span class="bookacti-available-places-number">'+h+'</span><span class="bookacti-available-places-unit-name"> '+d+'</span><span class="bookacti-available-places-avail-particle"> '+f+"</span></span></div>";return b}function bookacti_get_event_number_of_bookings_div(a,c){var h=a.attr("id");var d=parseInt(bookacti.booking_system[h]["events_data"][c.id]["availability"]);var e=bookacti_get_event_number_of_bookings(a,c);var f=bookacti_get_event_availability(a,c);var i=d===0?"bookacti-no-availability":"";var j=e>0?"bookacti-booked":"bookacti-not-booked";var g=f<=0?"bookacti-full":"";var b='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+j+" "+g+" "+i+'" ><span class="bookacti-active-bookings-number">'+e+"</span></span></div>";return b}function bookacti_sort_events_array_by_dates(d,b,a,c){b=b||false;a=a||false;c=c||{start:"start",end:"end"};d.sort(function(f,e){var g=b?0:new Date(f[c.start])-new Date(e[c.start]);if(g===0){g=new Date(f[c.end])-new Date(e[c.end])}if(a===true){g=!g}return g});return d}function bookacti_booking_method_set_up(b,c){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];c=c?1:0;if(bookacti.booking_system[a]["no_events"]){return}if(booking_method==="calendar"||$j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){bookacti_set_calendar_up(b,c)}else{b.trigger("bookacti_booking_method_set_up",[booking_method,c])}if(!$j.isEmptyObject(bookacti.booking_system[a]["picked_events"])&&typeof bookacti.booking_system[a]["events"]!=="undefined"){bookacti_fill_picked_events_list(b)}}function bookacti_booking_method_display_events(b,c){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if(booking_method==="calendar"||$j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){bookacti_display_events_on_calendar(b,c)}else{b.trigger("bookacti_booking_method_display_events",[booking_method,c])}}function bookacti_booking_method_refetch_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if(booking_method==="calendar"||$j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){b.find(".bookacti-calendar").fullCalendar("removeEvents");bookacti_fetch_events(b)}else{b.trigger("bookacti_refetch_events",[booking_method])}}function bookacti_booking_method_rerender_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if(booking_method==="calendar"||$j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){b.find(".bookacti-calendar").fullCalendar("rerenderEvents")}else{b.trigger("bookacti_rerender_events",[booking_method])}}function bookacti_booking_method_clear_events(b,c){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];c=c||null;if(!c){bookacti.booking_system[a]["events"]=[];bookacti.booking_system[a]["events_data"]=[];bookacti.booking_system[a]["events_interval"]=[]}else{delete bookacti.booking_system[a]["events_data"][c.id]}if(booking_method==="calendar"||$j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){bookacti_clear_events_on_calendar(b,c)}else{b.trigger("bookacti_clear_events",[booking_method,c])}}function bookacti_start_loading_booking_system(b){var a=b.attr("id");var c=bookacti.booking_system[a]["method"];var d='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";if(!$j.isNumeric(bookacti.booking_system[a]["loading_number"])){bookacti.booking_system[a]["loading_number"]=0}if(c==="calendar"||$j.inArray(c,bookacti_localized.available_booking_methods)===-1){if(b.find(".bookacti-calendar.fc").length){if(bookacti.booking_system[a]["loading_number"]===0||!b.find(".bookacti-loading-overlay").length){b.find(".bookacti-loading-alt").remove();bookacti_enter_calendar_loading_state(b.find(".bookacti-calendar"))}}else{if(!b.find(".bookacti-loading-alt").length){b.append(d)}}}if(bookacti.booking_system[a]["loading_number"]===0){b.trigger("bookacti_enter_loading_state")}bookacti.booking_system[a]["loading_number"]++;b.trigger("bookacti_start_loading",[c,d])}function bookacti_stop_loading_booking_system(b,c){c=c||false;var a=b.attr("id");var d=bookacti.booking_system[a]["method"];bookacti.booking_system[a]["loading_number"]--;bookacti.booking_system[a]["loading_number"]=Math.max(bookacti.booking_system[a]["loading_number"],0);if(c){bookacti.booking_system[a]["loading_number"]=0}b.trigger("bookacti_stop_loading");if(bookacti.booking_system[a]["loading_number"]===0){if(d==="calendar"||$j.inArray(d,bookacti_localized.available_booking_methods)===-1){bookacti_exit_calendar_loading_state(b.find(".bookacti-calendar"))}b.find(".bookacti-loading-alt").remove();b.trigger("bookacti_exit_loading_state",[d,c])}}function bookacti_redirect_to_activity_url(c,f){var b=c.attr("id");var d=bookacti.booking_system[b];if(typeof d.events_data[f.id]==="undefined"){return}var e=d.events_data[f.id]["activity_id"];if(typeof d.redirect_url_by_activity[e]==="undefined"){return}var a=d.redirect_url_by_activity[e];bookacti_redirect_booking_system_to_url(c,a)}function bookacti_redirect_to_group_category_url(c,f){var b=c.attr("id");var d=bookacti.booking_system[b];if(typeof d.groups_data[f]==="undefined"){return}var e=d.groups_data[f]["category_id"];if(typeof d.redirect_url_by_group_category[e]==="undefined"){return}var a=d.redirect_url_by_group_category[e];bookacti_redirect_booking_system_to_url(c,a)}function bookacti_redirect_booking_system_to_url(c,a){if(!a){return}var b="";if(!c.closest("form").length){c.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>');b=c.closest("form").serialize();c.closest(".bookacti-form-fields").unwrap("form.bookacti-temporary-form")}else{b=c.closest("form").serialize()}var d={url:a,params:b};d.url+=d.url.indexOf("?")>=0?"&"+b:"?"+b;c.trigger("bookacti_before_redirect",[d]);bookacti_start_loading_booking_system(c);window.location.href=d.url;bookacti_stop_loading_booking_system(c)};