function bookacti_get_booking_system_data_by_interval(b,d){var a=b.attr("id");var e=$j.extend(true,{},bookacti.booking_system[a]);var c=bookacti_get_booking_system_attributes_without_data(b);d=d?d:c.events_interval;bookacti.booking_system[a]["events_interval"]=bookacti_get_extended_events_interval(b,d);bookacti_start_loading_booking_system(b);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingSystemDataByInterval",attributes:JSON.stringify(c),interval:d},dataType:"json",success:function(f){if(f.status==="success"){if($j.isEmptyObject(bookacti.booking_system[a]["events"])){bookacti.booking_system[a]["events"]=f.booking_system_data.events}else{$j.extend(bookacti.booking_system[a]["events"],f.booking_system_data.events)}if($j.isEmptyObject(bookacti.booking_system[a]["events_data"])){bookacti.booking_system[a]["events_data"]=f.booking_system_data.events_data}else{$j.extend(bookacti.booking_system[a]["events_data"],f.booking_system_data.events_data)}if($j.isEmptyObject(bookacti.booking_system[a]["groups_events"])){bookacti.booking_system[a]["groups_events"]=f.booking_system_data.groups_events}else{$j.extend(true,bookacti.booking_system[a]["groups_events"],f.booking_system_data.groups_events)}if($j.isEmptyObject(bookacti.booking_system[a]["groups_data"])){bookacti.booking_system[a]["groups_data"]=f.booking_system_data.groups_data}else{$j.extend(bookacti.booking_system[a]["groups_data"],f.booking_system_data.groups_data)}if($j.isEmptyObject(bookacti.booking_system[a]["bookings"])){bookacti.booking_system[a]["bookings"]=f.booking_system_data.bookings}else{$j.extend(true,bookacti.booking_system[a]["bookings"],f.booking_system_data.bookings)}if($j.isEmptyObject(bookacti.booking_system[a]["groups_bookings"])){bookacti.booking_system[a]["groups_bookings"]=f.booking_system_data.groups_bookings}else{$j.extend(true,bookacti.booking_system[a]["groups_bookings"],f.booking_system_data.groups_bookings)}if($j.isEmptyObject(bookacti.booking_system[a]["booking_lists"])){bookacti.booking_system[a]["booking_lists"]=f.booking_system_data.booking_lists}else{$j.extend(true,bookacti.booking_system[a]["booking_lists"],f.booking_system_data.booking_lists)}if(f.booking_system_data.events.length){bookacti_booking_method_display_events(b,f.booking_system_data.events)}b.trigger("bookacti_booking_system_interval_data_loaded",[f,e,c,d])}else{var g=typeof f.message!=="undefined"?f.message:bookacti_localized.error;console.log(g);console.log(f)}},error:function(f){console.log("AJAX "+bookacti_localized.error);console.log(f)},complete:function(){bookacti_stop_loading_booking_system(b)}})}function bookacti_reload_booking_system(c,a){a=a||false;var b=c.attr("id");var e=$j.extend(true,{},bookacti.booking_system[b]);var d=bookacti_get_booking_system_attributes_without_data(c);if(!a){delete d.picked_events}bookacti_start_loading_booking_system(c);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiReloadBookingSystem",attributes:JSON.stringify(d)},dataType:"json",success:function(f){if(f.status==="success"){c.empty();bookacti_clear_booking_system_displayed_info(c);bookacti.booking_system[b]=f.booking_system_data;if(typeof e.rescheduled_booking_data!=="undefined"){bookacti.booking_system[b]["rescheduled_booking_data"]=$j.extend(true,{},e.rescheduled_booking_data)}if(typeof e.templates_per_activities!=="undefined"){bookacti.booking_system[b]["templates_per_activities"]=$j.extend(true,{},e.templates_per_activities)}c.append(f.html_elements);if(f.nonces){$j.each(f.nonces,function(i,h){if($j('input[type="hidden"][name="'+i+'"]').length){$j('input[type="hidden"][name="'+i+'"]').val(h)}})}bookacti_booking_method_set_up(c);bookacti_fill_booking_system_fields(c);bookacti_fill_picked_events_list(c);c.trigger("bookacti_booking_system_reloaded",[f,e,d])}else{var g=typeof f.message!=="undefined"?f.message:bookacti_localized.error;console.log(g);console.log(f)}},error:function(f){console.log("AJAX "+bookacti_localized.error);console.log(f)},complete:function(){bookacti_stop_loading_booking_system(c)}})}function bookacti_get_booking_system_attributes_without_data(b){var a=b.attr("id");var c=$j.extend(true,{},bookacti.booking_system[a]);var e=$j.extend(true,{},bookacti.booking_system[a]);var d=bookacti_localized.booking_system_attributes_keys;$j.each(c,function(f,g){if($j.inArray(f,d)===-1){delete e[f]}});return e}function bookacti_get_interval_of_events(e,d){var j=e.attr("id");var k=bookacti.booking_system[j]["events_interval"];var n=bookacti_get_availability_period(e);var o=parseInt(bookacti_localized.event_load_interval);var p=moment.utc(n.start);var a=moment.utc(n.end);var h=moment.utc(d.start).clone();var f=moment.utc(d.end).clone();if(h.isBefore(p)){h=p.clone()}if(f.isAfter(a)){f=a.clone()}var l={};var r={start:h.clone(),end:f.clone()};if($j.isEmptyObject(k)){l=bookacti_get_new_interval_of_events(e,r)}else{var c=moment.utc(k.start).clone().locale("en");var q=moment.utc(k.end).clone().locale("en");if(h.isBefore(c)||f.isAfter(q)){var g=c.clone();var i=q.clone();var b=moment.utc(d.start).clone().subtract(1,"days").locale("en");var m=moment.utc(d.end).clone().add(1,"days").locale("en");if(((h.isBefore(c)&&f.isAfter(q))||(f.isBefore(c))||(h.isAfter(q)))&&b.format("YYYY-MM-DD")+" 23:59:59"!==q.format("YYYY-MM-DD HH:mm:ss")&&m.format("YYYY-MM-DD")+" 00:00:00"!==c.format("YYYY-MM-DD HH:mm:ss")){bookacti_booking_method_clear_events(e);l=bookacti_get_new_interval_of_events(e,r)}else{if(h.isBefore(c)||m.format("YYYY-MM-DD")+" 00:00:00"===c.format("YYYY-MM-DD HH:mm:ss")){g.subtract(o,"days");if(h.isBefore(g)){g=h.clone()}if(g.isBefore(p)){g=p.clone()}i=moment.utc(c.clone().subtract(1,"days").format("YYYY-MM-DD")+" 23:59:59").locale("en")}else{if(f.isAfter(q)||b.format("YYYY-MM-DD")+" 23:59:59"===q.format("YYYY-MM-DD HH:mm:ss")){i.add(o,"days");if(f.isAfter(i)){i=f.clone()}if(i.isAfter(a)){i=a.clone()}g=moment.utc(q.clone().add(1,"days").format("YYYY-MM-DD")+" 00:00:00").locale("en")}}l={start:g.format("YYYY-MM-DD HH:mm:ss"),end:i.format("YYYY-MM-DD HH:mm:ss")}}}}return l}function bookacti_get_new_interval_of_events(c,i){var n=c.attr("id");var e=bookacti_get_availability_period(c);if(typeof e.start==="undefined"||typeof e.end==="undefined"){return{}}var p=bookacti.booking_system[n]["past_events"];var f=moment.utc(bookacti_localized.current_time).locale("en");var g=f.format("YYYY-MM-DD HH:mm:ss");var k=moment.utc(e.start).locale("en");var d=moment.utc(e.end).locale("en");if(!p&&d.isBefore(f)){return[]}if($j.isEmptyObject(i)){if(k.isAfter(f)){i={start:e.start,end:e.start}}else{if(d.isBefore(f)){i={start:e.end,end:e.end}}else{i={start:g,end:g}}}}var l=parseInt(bookacti_localized.event_load_interval);var o=moment.utc(moment.utc(i.start).clone().locale("en").format("YYYY-MM-DD")+" 00:00:00").locale("en");var b=moment.utc(moment.utc(i.end).clone().locale("en").format("YYYY-MM-DD")+" 23:59:59").locale("en");var h=parseInt(Math.abs(moment.utc(i.end).diff(i.start,"days")));if(h>l){l=h}var m=Math.round((l-h)/2);var j=m;if(p){o.subtract(m,"days");if(k.isAfter(o)){j+=Math.abs(o.diff(k,"days"))}}else{j+=m}if(k.isAfter(o)){o=k.clone()}b.add(j,"days");if(d.isBefore(b)){b=d}var a={start:o.format("YYYY-MM-DD HH:mm:ss"),end:b.format("YYYY-MM-DD HH:mm:ss")};return a}function bookacti_get_extended_events_interval(b,c){var a=b.attr("id");var e=bookacti.booking_system[a]["events_interval"];if($j.isEmptyObject(c)){return e}var d=[];if($j.isEmptyObject(e)){d={start:c.start,end:c.end}}else{d={start:moment.utc(c.start).isBefore(moment.utc(e.start))?c.start:e.start,end:moment.utc(c.end).isAfter(moment.utc(e.end))?c.end:e.end}}return d}function bookacti_get_availability_period(b){var a=b.attr("id");var c=bookacti.booking_system[a];return{start:c.start,end:c.end}}function bookacti_refresh_booking_numbers(b){var a=b.attr("id");var d=bookacti.booking_system[a]["calendars"];var c=bookacti.booking_system[a]["groups_data"];var e=bookacti.booking_system[a]["groups_events"];bookacti_start_loading_booking_system(b);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingNumbers",template_ids:d,groups_data:c,groups_events:e},dataType:"json",success:function(f){bookacti.booking_system[a]["bookings"]=[];if(typeof f.bookings!=="undefined"){bookacti.booking_system[a]["bookings"]=f.bookings;bookacti.booking_system[a]["groups_bookings"]=f.groups_bookings}bookacti_booking_method_rerender_events(b)},error:function(f){alert("AJAX "+bookacti_localized.error);console.log(f)},complete:function(){bookacti_stop_loading_booking_system(b)}})}function bookacti_event_click(a,b){var j=a.attr("id");var e=bookacti.booking_system[j]["multiple_bookings"];if(e){var l=bookacti_unpick_events(a,b);if(l){return}}var c={};var g=[];var f=0;if(j!=="bookacti-booking-system-reschedule"){c=bookacti_get_event_groups(a,b);f=bookacti_get_event_groups_nb(c);g=Object.keys(c)}var k=false;if(f>1||(f===1&&bookacti.booking_system[j]["groups_single_events"])){k=true;bookacti_dialog_choose_group_of_events(a,c,b)}else{var i=g.length?g[0]:0;var h=i?Object.keys(c[i]):[];var d=h.length?h[0]:"";if(!e){bookacti_unpick_all_events(a)}bookacti_pick_events(a,b,i,d);if(i){a.trigger("bookacti_group_of_events_chosen",[i,d,b])}}a.trigger("bookacti_event_click",[b,c,k])}function bookacti_get_event_groups(c,f){var a={};if(typeof f!=="object"){return a}else{if(typeof f.id==="undefined"||typeof f.start==="undefined"||typeof f.end==="undefined"){return group_ids}}var b=c.attr("id");var g=parseInt(f.id);var e=moment.utc(f.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var d=moment.utc(f.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");$j.each(bookacti.booking_system[b]["groups_events"],function(h,i){$j.each(i,function(k,j){$j.each(j,function(l,m){if(parseInt(m.id)===g&&m.start===e&&m.end===d){if(typeof a[h]==="undefined"){a[h]={}}a[h][k]=j;return false}})})});return a}function bookacti_get_event_groups_nb(b){var a=0;$j.each(b,function(c,d){$j.each(d,function(f,e){++a})});return a}function bookacti_fill_booking_system_fields(c){var b=c.siblings(".bookacti-booking-system-inputs");if(!b.length){return}b.find('input[name^="selected_events"]').remove();var d=0;var a=c.attr("id");$j.each(bookacti.booking_system[a]["picked_events"],function(e,f){b.append('<input type="hidden" name="selected_events['+d+'][group_id]" value="'+f.group_id+'"/>');b.append('<input type="hidden" name="selected_events['+d+'][group_date]" value="'+f.group_date+'"/>');b.append('<input type="hidden" name="selected_events['+d+'][id]" value="'+f.id+'"/>');b.append('<input type="hidden" name="selected_events['+d+'][start]" value="'+f.start+'"/>');b.append('<input type="hidden" name="selected_events['+d+'][end]" value="'+f.end+'"/>');++d;c.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_group_id"]').val(f.group_id?f.group_id:0);c.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_id"]').val(f.id);c.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_start"]').val(f.start);c.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_end"]').val(f.end)});c.trigger("bookacti_fill_booking_system_fields")}function bookacti_pick_events(b,d,c,g){d=typeof d==="object"?d:($j.isNumeric(d)?{id:d}:{});c=$j.isNumeric(c)?parseInt(c):0;g=g?g:"";var e=0;if(typeof d.id==="undefined"){d.id=0}if(typeof d.start==="undefined"){d.start=""}if(!c&&!d.id){return e}if(!c){e=bookacti_pick_event(b,d)}else{var a=b.attr("id");if(typeof bookacti.booking_system[a]["groups_events"][c]!=="undefined"){if(typeof bookacti.booking_system[a]["groups_events"][c][g]!=="undefined"){var f=bookacti.booking_system[a]["groups_events"][c][g].slice();$j.each(f,function(h,j){group_picked_nb=bookacti_pick_event(b,j,c,g);e+=group_picked_nb})}}}b.trigger("bookacti_events_picked",[d,c,g]);return e}function bookacti_is_event_picked(c,e){var b=c.attr("id");var g=$j.extend(true,{},bookacti.booking_system[b]["picked_events"]);var a=typeof e==="object"?moment.utc(e.start).clone().locale("en").format("YYYY-MM-DD"):"";var f=typeof e==="object"?e.id:e;var d=false;if(g){$j.each(g,function(h,j){if(j.id==f&&($j.isNumeric(e)||j.start.substr(0,10)===a)){d=j;return false}})}return d}function bookacti_pick_event(a,b,f,d){b=typeof b==="object"?b:($j.isNumeric(b)?{id:b}:{});f=$j.isNumeric(f)?parseInt(f):0;d=d?d:"";var c=0;if(typeof b.id==="undefined"){b.id=0}if(typeof b.start==="undefined"){b.start=""}if(!f&&!b.id){return c}var g=a.attr("id");var e=typeof b.title!=="undefined"?b.title:"";var h=typeof b.activity_id!=="undefined"?parseInt(b.activity_id):0;if(!h){if(typeof bookacti.booking_system[g]["events_data"][b.id]!=="undefined"){e=bookacti.booking_system[g]["events_data"][b.id]["title"];h=bookacti.booking_system[g]["events_data"][b.id]["activity_id"]}}var i={group_id:f,group_date:d?moment.utc(d).clone().locale("en").format("YYYY-MM-DD"):"",id:parseInt(b.id),start:moment.utc(b.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),end:moment.utc(b.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),title:e,activity_id:parseInt(h)};bookacti.booking_system[g]["picked_events"].push(i);++c;bookacti.booking_system[g]["picked_events"].sort(function(l,k){var j=moment.utc(l.start);var m=moment.utc(k.start);return((j.isBefore(m))?-1:((j.isAfter(m))?1:0))});a.trigger("bookacti_pick_event",[b,f,d]);return c}function bookacti_unpick_events(a,b,g,d){b=typeof b==="object"?b:($j.isNumeric(b)?{id:b}:{});g=$j.isNumeric(g)?parseInt(g):0;d=d?d:"";var i=0;if(typeof b.id==="undefined"){b.id=0}if(typeof b.start==="undefined"){b.start=""}if(!g&&!b.id){return i}var h=a.attr("id");var e={id:parseInt(b.id),start:b.start?moment.utc(b.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"):"",group_id:g,group_date:d?moment.utc(d).clone().locale("en").format("YYYY-MM-DD"):""};var c=[];$j.each(bookacti.booking_system[h]["picked_events"],function(k,p){if(!p.group_id){return true}var m=p.group_id+"_"+p.group_date;var n=e.group_id&&p.group_id==e.group_id?1:0;var l=e.group_date&&p.group_date===e.group_date?1:0;var o=e.id&&p.id==e.id?1:0;var j=e.start&&p.start.substr(0,10)===e.start.substr(0,10)?1:0;if(!e.id&&n){if(!e.group_date||l){c.push(m)}}if(!e.group_id&&o){if(!e.start||j){c.push(m)}}if(o&&n){if((!e.group_date||l)&&(!e.start||j)){c.push(m)}}});var f=$j.grep(bookacti.booking_system[h]["picked_events"],function(m){var k=m.group_id+"_"+m.group_date;var l=e.id&&m.id==e.id?1:0;var j=e.start&&m.start.substr(0,10)===e.start.substr(0,10)?1:0;if($j.inArray(k,c)>=0||(l&&!e.start)||(l&&j)){++i;return false}return true});bookacti.booking_system[h]["picked_events"]=f;a.trigger("bookacti_events_unpicked",[b,g,d]);return i}function bookacti_unpick_all_events(b){var a=b.attr("id");bookacti.booking_system[a]["picked_events"]=[];b.siblings(".bookacti-booking-system-inputs").find('input[name^="selected_events"]').remove();b.siblings(".bookacti-booking-system-inputs").find("input").val("");b.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list").empty();b.siblings(".bookacti-picked-events").hide();b.trigger("bookacti_unpick_all_events")}function bookacti_get_picked_events_list_items(c){var b={};var a=c.attr("id");var d=c.closest("form").length?c.closest("form"):c.closest(".bookacti-form-fields");qty_field=d.find('input[name="quantity"]');var e=qty_field.length?parseInt(qty_field.val()):1;$j.each(bookacti.booking_system[a]["picked_events"],function(h,r){var p=0;if(typeof bookacti.booking_system[a]["events_data"]!=="undefined"&&parseInt(r.id)>0){if(typeof bookacti.booking_system[a]["events_data"][r.id]!=="undefined"){p=bookacti.booking_system[a]["events_data"][r.id]["activity_id"]}}var g=0;if(typeof bookacti.booking_system[a]["groups_data"]!=="undefined"&&parseInt(r.group_id)>0){if(typeof bookacti.booking_system[a]["groups_data"][r.group_id]!=="undefined"){g=bookacti.booking_system[a]["groups_data"][r.group_id]["category_id"]}}var o={id:r.id,title:r.title,group_id:r.group_id,group_date:r.group_date,start:moment.utc(r.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),end:moment.utc(r.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),activity_id:parseInt(p),category_id:parseInt(g),quantity:e,price:0,price_to_display:"",has_price:false};c.trigger("bookacti_picked_events_list_item_data",[o,r]);var k=parseInt(o.group_id)>0?"event-group-"+o.group_id+"-"+o.group_date:"event-"+o.id+"-"+o.start+"-"+o.end;var m=$j("<li></li>",{html:'<span class="bookacti-booking-event-title" >'+o.title+"</span>"});var l=bookacti_format_event_duration(o.start,o.end);if(l){m.append('<span class="bookacti-booking-event-title-separator" > - </span>'+l)}if(o.quantity>0){var f=bookacti_get_activity_unit(c,o.activity_id,o.quantity);if(f){m.append('<span class="bookacti-booking-event-quantity-separator" > - </span><span class="bookacti-booking-event-quantity" >'+o.quantity+" "+f+"</span>")}}m.data("event-id",o.id).attr("data-event-id",o.id);m.data("event-start",o.start).attr("data-event-start",o.start);m.data("event-end",o.end).attr("data-event-end",o.end);if(parseInt(o.group_id)>0){if(typeof b[k]==="undefined"){var j="";if(typeof bookacti.booking_system[a]["groups_data"][o.group_id]!=="undefined"){var n=bookacti.booking_system[a]["groups_data"][o.group_id];j='<span class="bookacti-picked-group-of-events-title">'+n.title+"</span>"}var q=$j("<li></li>",{html:j+'<ul class="bookacti-picked-group-of-events-list">'+m[0].outerHTML+"</ul>"});q.data("group-id",o.group_id).attr("data-group-id",o.group_id);q.data("group-date",o.group_date).attr("data-group-date",o.group_date);b[k]=$j.extend(true,{},o);b[k].list_element=q}else{b[k]["end"]=o.end;b[k].list_element.find("ul").append(m)}}else{b[k]=$j.extend(true,{},o);b[k].list_element=m}});c.trigger("bookacti_picked_events_list_items",[b]);return b}function bookacti_fill_picked_events_list(d){var c=d.attr("id");var f=d.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list-title");var b=d.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list");b.empty();d.siblings(".bookacti-picked-events").hide();if(typeof bookacti.booking_system[c]["picked_events"]==="undefined"){return}if(!bookacti.booking_system[c]["picked_events"].length){return}var e=bookacti.booking_system[c]["multiple_bookings"];var g=bookacti.booking_system[c]["picked_events"].length===1?bookacti_localized.selected_event:bookacti_localized.selected_events;f.html(g);var a=bookacti_get_picked_events_list_items(d);$j.each(a,function(j,h){var k=h.list_element;if(e){k.prepend('<span class="bookacti-unpick-event-icon"></span>')}b.append(k)});if(!b.is(":empty")){d.siblings(".bookacti-picked-events").show()}d.trigger("bookacti_picked_events_list_filled")}function bookacti_set_tooltip_position(c,d,e){e=$j.inArray(e,["below","above"])>=0?e:"below";d.css("position","absolute");var h=$j(window).width();if(d.outerWidth()>h){d.outerWidth(h)}var g=c.offset();var b=c.offset().left+(c.outerWidth()/2);g.top+=e==="above"?((d.outerHeight()+15)*-1):c.height()+15;g.left=b-(d.outerWidth()/2);if(g.left<0){g.left=0}var a=g.left+d.outerWidth();if(a>h){g.left-=(a-h)}d.offset(g);var j=e==="above"?"bookacti-tooltip-arrow-bottom":"bookacti-tooltip-arrow-top";if(!d.find(".bookacti-tooltip-arrow."+j).length){d.find(".bookacti-tooltip-arrow").remove();d.append('<div class="bookacti-tooltip-arrow '+j+'"></div>')}var f=d.find(".bookacti-tooltip-arrow");var i=b-g.left-(f.outerWidth()/2);f.css("left",i+"px")}function bookacti_get_min_and_max_quantity(a){var j=a.attr("id");var c=bookacti.booking_system[j];var g=[];var f=1;var i=999999999;var b=999999999;var h,l,e,d;$j.each(c.picked_events,function(o,u){h=0;l=0;e=1;d=false;if(parseInt(u.group_id)>0){var n=u.group_id+""+u.group_date;if($j.inArray(n,g)>-1){return true}g.push(n);if(typeof c.groups_data!=="undefined"){if(typeof c.groups_data[u.group_id]!=="undefined"){var m=parseInt(c.groups_data[u.group_id]["category_id"]);if(typeof c.group_categories_data!=="undefined"){if(typeof c.group_categories_data[m]!=="undefined"){if(typeof c.group_categories_data[m]["settings"]!=="undefined"){var q=c.group_categories_data[m]["settings"];e=typeof q.min_bookings_per_user==="undefined"?1:(q.min_bookings_per_user?parseInt(q.min_bookings_per_user):1);d=typeof q.max_bookings_per_user==="undefined"?false:(q.max_bookings_per_user?parseInt(q.max_bookings_per_user):false)}}}}}if(u.group_date){if(typeof c.groups_bookings[u.group_id]!=="undefined"){if(typeof c.groups_bookings[u.group_id][u.group_date]!=="undefined"){h=parseInt(c.groups_bookings[u.group_id][u.group_date]["availability"]);if(e||d){l=parseInt(c.groups_bookings[u.group_id][u.group_date]["current_user_bookings"])}}}}}else{if(typeof c.events_data!=="undefined"){if(typeof c.events_data[u.id]!=="undefined"){h=bookacti_get_event_availability(a,u);var t=parseInt(c.events_data[u.id]["activity_id"]);if(typeof c.activities_data!=="undefined"){if(typeof c.activities_data[t]!=="undefined"){if(typeof c.activities_data[t]["settings"]!=="undefined"){var r=c.activities_data[t]["settings"];e=typeof r.min_bookings_per_user==="undefined"?1:(r.min_bookings_per_user?parseInt(r.min_bookings_per_user):1);d=typeof r.max_bookings_per_user==="undefined"?false:(r.max_bookings_per_user?parseInt(r.max_bookings_per_user):false);if(e||d){var p=moment.utc(u.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");if(typeof c.bookings[u.id]!=="undefined"){if(typeof c.bookings[u.id][p]!=="undefined"){var s=c.bookings[u.id][p];l=parseInt(s.current_user_bookings)}}}}}}}}}d=d&&d!=0&&(d-l)<h?Math.max((d-l),0):h;e=e&&e!=0&&e>1&&l<e?Math.max((e-l),0):1;if(e>f){f=e}if(d&&d<i){i=d}if(h<b){b=h}});var k={avail:b,min:f,max:i};a.trigger("bookacti_min_and_max_quantity",[k]);return k}function bookacti_set_min_and_max_quantity(b){var e=bookacti_get_min_and_max_quantity(b);var d=b.closest("form").length?b.closest("form"):b.closest(".bookacti-form-fields");e.field=d.find('input[name="quantity"]');b.trigger("bookacti_update_quantity",[e]);if(!e.field.length){return e}var c=parseInt(e.field.val());e.value=c;if(c>e.max){e.value=e.max}if(c<e.min){if(e.min>e.avail){e.max=e.min}e.value=e.min}e.field.attr("min",1);e.field.removeAttr("max");var a=b.attr("id");if(!bookacti.booking_system[a]["picked_events"].length){return e}e.field.attr("max",e.max);e.field.attr("min",e.min);e.field.val(e.value);if(c!==parseInt(e.value)){e.field.trigger("bookacti_quantity_updated",[c,e])}return e}function bookacti_format_event_duration(a,c){a=moment.utc(a).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");c=moment.utc(c).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var b=moment.utc(a).clone().locale(bookacti_localized.current_lang_code);var f=moment.utc(c).clone().locale(bookacti_localized.current_lang_code);var i=a.substr(0,10)===c.substr(0,10);var g=i?"bookacti-booking-event-end-same-day":"";var h=i?f.formatPHP(bookacti_localized.time_format):f.formatPHP(bookacti_localized.date_format);var d=i?bookacti_localized.date_time_separator:bookacti_localized.dates_separator;var e='<span class="bookacti-booking-event-start">'+b.formatPHP(bookacti_localized.date_format)+'</span><span class="bookacti-booking-event-date-separator '+g+'">'+d+'</span><span class="bookacti-booking-event-end '+g+'">'+h+"</span>";return e}function bookacti_get_activity_unit(b,c,f){f=$j.isNumeric(f)?parseInt(f):1;if(!c||f===0){return""}var a=b.attr("id");if(typeof bookacti.booking_system[a]["activities_data"]==="undefined"){return""}if(typeof bookacti.booking_system[a]["activities_data"][c]==="undefined"){return""}var e=bookacti.booking_system[a]["activities_data"][c];if(typeof e.settings==="undefined"){return""}if(typeof e.settings["unit_name_plural"]==="undefined"||typeof e.settings["unit_name_singular"]==="undefined"){return""}if(e.settings["unit_name_plural"]===""||e.settings["unit_name_singular"]===""){return""}var d=f===1?e.settings["unit_name_singular"]:e.settings["unit_name_plural"];if(typeof e.settings["places_number"]==="undefined"){return d}if(e.settings["places_number"]===""||parseInt(e.settings["places_number"])===0){return d}d+=parseInt(e.settings["places_number"])===1?" "+bookacti_localized.one_person_per_booking:" "+bookacti_localized.n_people_per_booking.replace("%1$s",e.settings["places_number"]);return d}function bookacti_clear_booking_system_displayed_info(b,a){a=a||false;if(!a){bookacti_unpick_all_events(b)}b.siblings(".bookacti-notices").hide();b.siblings(".bookacti-notices").empty();b.show();b.trigger("bookacti_displayed_info_cleared")}function bookacti_get_event_number_of_bookings(b,e){var a=b.attr("id");var c=bookacti.booking_system[a];var d=moment.utc(e.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var f=0;if(typeof c.bookings!=="undefined"){if(typeof c.bookings[e.id]!=="undefined"){if(typeof c.bookings[e.id][d]!=="undefined"){if(typeof c.bookings[e.id][d]["quantity"]!=="undefined"){if($j.isNumeric(c.bookings[e.id][d]["quantity"])){f=parseInt(c.bookings[e.id][d]["quantity"])}}}}}return f}function bookacti_get_event_availability(b,d){var a=b.attr("id");var c=bookacti.booking_system[a];var e=0;if(typeof d.availability!=="undefined"){e=d.availability}if(typeof c.events_data[d.id]!=="undefined"){if(typeof c.events_data[d.id]["availability"]!=="undefined"){if($j.isNumeric(c.events_data[d.id]["availability"])){e=parseInt(c.events_data[d.id]["availability"])}}}var f=bookacti_get_event_number_of_bookings(b,d);return e-f}function bookacti_is_event_available(e,t){var n=e.attr("id");var j=bookacti.booking_system[n];var w=j.past_events;var k=j.past_events_bookable;var l=moment.utc(bookacti_localized.current_time);var a=moment.utc(t.start).clone().locale("en");var h=moment.utc(t.end).clone().locale("en");var o=bookacti_get_event_availability(e,t);var v=bookacti_get_availability_period(e);var p=false;if(o<=0){return false}var x=bookacti_get_event_groups(e,t);var g=bookacti_get_event_groups_nb(x);var s=g>0;var i=j.groups_single_events;if(n==="bookacti-booking-system-reschedule"){if(s&&!i){return false}var f=typeof j.rescheduled_booking_data!=="undefined"?j.rescheduled_booking_data:[];if(typeof f.event_id!=="undefined"&&typeof f.event_start!=="undefined"&&typeof f.event_end!=="undefined"){if(f.event_id==t.id&&f.event_start===a.format("YYYY-MM-DD HH:mm:ss")&&f.event_end===h.format("YYYY-MM-DD HH:mm:ss")){return false}}if(typeof f.quantity!=="undefined"){if(parseInt(f.quantity)>o){return false}}}if((!s||(s&&i))&&typeof j.events_data[t.id]!=="undefined"){var q=false;if(w){if(!k&&a.isBefore(l)&&!(bookacti_localized.started_events_bookable&&h.isAfter(l))){q=true}if(!k&&(a.isBefore(moment.utc(v.start))||h.isAfter(moment.utc(v.end)))){q=true}}if(!q){var m=parseInt(j.events_data[t.id]["activity_id"]);var r=j.activities_data[m]["settings"];var z=max_qty_ok=max_users_ok=true;event_start_formatted=a.format("YYYY-MM-DD HH:mm:ss");if(typeof j.bookings[t.id]!=="undefined"){if(typeof j.bookings[t.id][event_start_formatted]!=="undefined"){var y=typeof r.min_bookings_per_user==="undefined"?0:(r.min_bookings_per_user?parseInt(r.min_bookings_per_user):0);var b=typeof r.max_bookings_per_user==="undefined"?0:(r.max_bookings_per_user?parseInt(r.max_bookings_per_user):0);var d=typeof r.max_users_per_event==="undefined"?0:(r.max_users_per_event?parseInt(r.max_users_per_event):0);if(y||b||d){var c=j.bookings[t.id][event_start_formatted];var u=parseInt(c.current_user_bookings);if(d&&u===0&&c.distinct_users>=d){max_users_ok=false}if(b&&u>=b){max_qty_ok=false}if(y&&y>o+u){z=false}}}}if(z&&max_qty_ok&&max_users_ok){p=true}}}if(s&&!p){$j.each(x,function(D,F){var E=j.groups_data[D];var C=parseInt(E.category_id);var B=j.group_categories_data[C]["settings"];var A=parseInt(bookacti_localized.started_groups_bookable);if(typeof B.started_groups_bookable!=="undefined"){if($j.inArray(B.started_groups_bookable,[0,1,"0","1",true,false])>=0){A=$j.isNumeric(B.started_groups_bookable)?parseInt(B.started_groups_bookable):(B.started_groups_bookable?1:0)}}$j.each(F,function(J,P){var Q=moment.utc(P[0].start).clone();var G=moment.utc(P[P.length-1].end).clone();if(!k&&Q.isBefore(l)&&!(A&&G.isAfter(l))){return true}if(!k&&(Q.isBefore(moment.utc(v.start))||Q.isAfter(moment.utc(v.end)))){return true}var L,M,H;L=M=H=0;if(typeof j.groups_bookings[D]!=="undefined"){if(typeof j.groups_bookings[D][J]!=="undefined"){L=j.groups_bookings[D][J]["availability"];M=j.groups_bookings[D][J]["current_user_bookings"];H=j.groups_bookings[D][J]["distinct_users"]}}if(parseInt(L)>0){var I=max_qty_ok=max_users_ok=true;if(E!=null){var R=typeof B.max_users_per_event==="undefined"?0:(B.max_users_per_event?parseInt(B.max_users_per_event):0);var O=typeof B.max_bookings_per_user==="undefined"?0:(B.max_bookings_per_user?parseInt(B.max_bookings_per_user):0);var N=typeof B.min_bookings_per_user==="undefined"?0:(B.min_bookings_per_user?parseInt(B.min_bookings_per_user):0);if(N||O||R){var K=parseInt(M);if(R&&K===0&&parseInt(H)>=R){max_users_ok=false}if(O&&K>=O){max_qty_ok=false}if(N&&N>L+K){I=false}}}if(I&&max_qty_ok&&max_users_ok){p=true;return false}}})})}return p}function bookacti_get_bookings_number_for_a_single_grouped_event(c,e,a){a=!$j.isEmptyObject(a)?a:bookacti_get_event_groups(c,e);var b=c.attr("id");var d=bookacti.booking_system[b];var f=bookacti_get_event_number_of_bookings(c,e);var g=0;$j.each(a,function(h,i){$j.each(i,function(k,j){if(typeof d.groups_bookings[h]!=="undefined"){if(typeof d.groups_bookings[h][k]!=="undefined"){g+=d.groups_bookings[h][k]["quantity"]}}})});return f-g}function bookacti_get_event_availability_div(g,q){var l=g.attr("id");var i=bookacti.booking_system[l];var m=bookacti_get_event_availability(g,q);var k=0;var t=0;if(typeof i.events_data[q.id]!=="undefined"){if(typeof i.events_data[q.id]["activity_id"]!=="undefined"){k=bookacti.booking_system[l]["events_data"][q.id]["activity_id"]}if(typeof i.events_data[q.id]["availability"]!=="undefined"){t=bookacti.booking_system[l]["events_data"][q.id]["availability"]}}var s="";if(k){var p=bookacti.booking_system[l]["activities_data"][k];if(p!==undefined){if(p.settings!==undefined){if(p.settings["unit_name_plural"]!==undefined&&p.settings["unit_name_singular"]!==undefined&&p.settings["show_unit_in_availability"]!==undefined){if(parseInt(p.settings["show_unit_in_availability"])){if(m===1){s=p.settings["unit_name_singular"]}else{s=p.settings["unit_name_plural"]}}}}}}var n=m>1?bookacti_localized.avails:bookacti_localized.avail;var b=m<t?"bookacti-booked":"bookacti-not-booked";var c=m<=0?"bookacti-full":"";var h="";var d=bookacti.booking_system[l]["bookings_only"]==1?true:false;var r=parseInt((m/t)*100);var j=parseInt(bookacti.booking_system[l]["hide_availability"]);var e=parseInt(bookacti_localized.hide_availability_fixed);var a=j<100&&r>j;var f=e>0&&m>e;if(!d&&((e<=0&&a)||(j>=100&&f)||(a&&f))){m="";h="bookacti-hide-availability"}var o='<div class="bookacti-availability-container '+h+'" ><span class="bookacti-available-places '+b+" "+c+'" ><span class="bookacti-available-places-number">'+m+'</span><span class="bookacti-available-places-unit-name"> '+s+'</span><span class="bookacti-available-places-avail-particle"> '+n+"</span></span></div>";return o}function bookacti_get_event_number_of_bookings_div(a,c){var h=a.attr("id");var e=bookacti_get_event_number_of_bookings(a,c);var f=bookacti_get_event_availability(a,c);var d=0;if(typeof bookacti.booking_system[h]["events_data"][c.id]!=="undefined"){if(typeof bookacti.booking_system[h]["events_data"][c.id]["availability"]!=="undefined"){d=bookacti.booking_system[h]["events_data"][c.id]["availability"]}}var i=d===0?"bookacti-no-availability":"";var j=e>0?"bookacti-booked":"bookacti-not-booked";var g=f<=0?"bookacti-full":"";var b='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+j+" "+g+" "+i+'" ><span class="bookacti-active-bookings-number">'+e+"</span></span></div>";return b}function bookacti_sort_events_array_by_dates(d,b,a,c){b=b||false;a=a||false;c=c||{start:"start",end:"end"};d.sort(function(f,e){if(b||f[c.start]===e[c.start]){var i=moment.utc(f[c.end]);var h=moment.utc(e[c.end])}else{var i=moment.utc(f[c.start]);var h=moment.utc(e[c.start])}var g=0;if(i.isAfter(h)){g=1}if(i.isBefore(h)){g=-1}if(a===true){g=g*-1}return g});return d}function bookacti_booking_method_set_up(b,c){c=c?1:0;var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if($j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){booking_method="calendar"}if(bookacti.booking_system[a]["no_events"]){return}b.trigger("bookacti_booking_method_set_up",[booking_method,c]);if(bookacti.booking_system[a]["picked_events"].length&&typeof bookacti.booking_system[a]["events"]!=="undefined"){bookacti_set_min_and_max_quantity(b);bookacti_fill_picked_events_list(b)}}function bookacti_booking_method_display_events(b,c){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if($j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){booking_method="calendar"}b.trigger("bookacti_booking_method_display_events",[booking_method,c])}function bookacti_booking_method_refetch_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if($j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){booking_method="calendar"}b.trigger("bookacti_refetch_events",[booking_method])}function bookacti_booking_method_rerender_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if($j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){booking_method="calendar"}b.trigger("bookacti_rerender_events",[booking_method])}function bookacti_booking_method_clear_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a]["method"];if($j.inArray(booking_method,bookacti_localized.available_booking_methods)===-1){booking_method="calendar"}bookacti.booking_system[a]["events"]=[];bookacti.booking_system[a]["events_data"]=[];bookacti.booking_system[a]["events_interval"]=[];b.trigger("bookacti_clear_events",[booking_method])}function bookacti_start_loading_booking_system(b){var a=b.attr("id");var c=bookacti.booking_system[a]["method"];if($j.inArray(c,bookacti_localized.available_booking_methods)===-1){c="calendar"}if(!$j.isNumeric(bookacti.booking_system[a]["loading_number"])){bookacti.booking_system[a]["loading_number"]=0}b.trigger("bookacti_start_loading",[c]);bookacti.booking_system[a]["loading_number"]++}function bookacti_stop_loading_booking_system(b,c){c=c?c:false;var a=b.attr("id");var d=bookacti.booking_system[a]["method"];if($j.inArray(d,bookacti_localized.available_booking_methods)===-1){d="calendar"}bookacti.booking_system[a]["loading_number"]--;bookacti.booking_system[a]["loading_number"]=Math.max(bookacti.booking_system[a]["loading_number"],0);if(c){bookacti.booking_system[a]["loading_number"]=0}if(bookacti.booking_system[a]["loading_number"]===0){b.trigger("bookacti_exit_loading_state",[d,c])}}function bookacti_redirect_to_activity_url(c,f){var b=c.attr("id");var d=bookacti.booking_system[b];if(typeof d.events_data[f.id]==="undefined"){return}var e=d.events_data[f.id]["activity_id"];if(typeof d.redirect_url_by_activity[e]==="undefined"){return}var a=d.redirect_url_by_activity[e];bookacti_redirect_booking_system_to_url(c,a)}function bookacti_redirect_to_group_category_url(c,f){var b=c.attr("id");var d=bookacti.booking_system[b];if(typeof d.groups_data[f]==="undefined"){return}var e=d.groups_data[f]["category_id"];if(typeof d.redirect_url_by_group_category[e]==="undefined"){return}var a=d.redirect_url_by_group_category[e];bookacti_redirect_booking_system_to_url(c,a)}function bookacti_redirect_booking_system_to_url(c,a){if(!a){return}var e=c.closest("form").length?c.closest("form"):c.closest(".bookacti-form-fields");var b=e.find('input[type="submit"]');if(b.length){b.prop("disabled",true)}bookacti_start_loading_booking_system(c);if(b.length){var f='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";b.after(f)}var g={method:"post",action:a,"class":"bookacti-temporary-form",id:"","data-redirect-timeout":15000};c.trigger("bookacti_before_redirect",[g]);if(c.closest("form").length){var d={};$j.each(g,function(i,h){d[i]=e.attr(i)});e.attr(g);e.submit();e.attr(d)}else{c.closest(".bookacti-form-fields").wrap("<form></form>");c.closest("form").attr(g).submit();c.closest(".bookacti-form-fields").unwrap("form.bookacti-temporary-form")}c.trigger("bookacti_after_redirect",[g]);setTimeout(function(){bookacti_stop_loading_booking_system(c);if(b.length){b.next(".bookacti-loading-alt").remove();b.prop("disabled",false)}},g["data-redirect-timeout"])};