function bookacti_get_booking_system_data_by_interval(b,a){var c=b.attr("id"),f=$j.extend(!0,{},bookacti.booking_system[c]),d=bookacti_get_booking_system_attributes_without_data(b);a=a?a:$j.extend(!0,{},f.events_interval);bookacti.booking_system[c].events_interval=bookacti_get_extended_events_interval(b,a);bookacti_start_loading_booking_system(b);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingSystemDataByInterval",attributes:JSON.stringify(d),interval:JSON.stringify(a)},
dataType:"json",success:function(e){if("success"===e.status){$j.isEmptyObject(bookacti.booking_system[c].events)?bookacti.booking_system[c].events=e.booking_system_data.events:bookacti.booking_system[c].events=bookacti.booking_system[c].events.concat(e.booking_system_data.events);$j.isEmptyObject(bookacti.booking_system[c].events_data)?bookacti.booking_system[c].events_data=e.booking_system_data.events_data:$j.extend(bookacti.booking_system[c].events_data,e.booking_system_data.events_data);$j.isEmptyObject(bookacti.booking_system[c].groups_events)?
bookacti.booking_system[c].groups_events=e.booking_system_data.groups_events:$j.extend(!0,bookacti.booking_system[c].groups_events,e.booking_system_data.groups_events);$j.isEmptyObject(bookacti.booking_system[c].groups_data)?bookacti.booking_system[c].groups_data=e.booking_system_data.groups_data:$j.extend(bookacti.booking_system[c].groups_data,e.booking_system_data.groups_data);$j.isEmptyObject(bookacti.booking_system[c].bookings)?bookacti.booking_system[c].bookings=e.booking_system_data.bookings:
$j.extend(!0,bookacti.booking_system[c].bookings,e.booking_system_data.bookings);$j.isEmptyObject(bookacti.booking_system[c].groups_bookings)?bookacti.booking_system[c].groups_bookings=e.booking_system_data.groups_bookings:$j.extend(!0,bookacti.booking_system[c].groups_bookings,e.booking_system_data.groups_bookings);$j.isEmptyObject(bookacti.booking_system[c].booking_lists)?bookacti.booking_system[c].booking_lists=e.booking_system_data.booking_lists:$j.extend(!0,bookacti.booking_system[c].booking_lists,
e.booking_system_data.booking_lists);if(e?.trimmed_period?.start||e?.trimmed_period?.end)e?.trimmed_period?.start&&(bookacti.booking_system[c].start=e.trimmed_period.start),e?.trimmed_period?.end&&(bookacti.booking_system[c].end=e.trimmed_period.end),bookacti_booking_method_update_availability_period(b);e.booking_system_data.events.length&&bookacti_booking_method_display_events(b,e.booking_system_data.events);b.trigger("bookacti_booking_system_interval_data_loaded",[e,f,d,a])}else console.log("undefined"!==
typeof e.message?e.message:bookacti_localized.error),console.log(e)},error:function(e){console.log("AJAX "+bookacti_localized.error);console.log(e)},complete:function(){bookacti_stop_loading_booking_system(b)}})}
function bookacti_reload_booking_system(b,a){a=a||!1;var c=b.attr("id"),f=$j.extend(!0,{},bookacti.booking_system[c]),d=bookacti_get_booking_system_attributes_without_data(b);a||delete d.picked_events;bookacti_start_loading_booking_system(b);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiReloadBookingSystem",attributes:JSON.stringify(d)},dataType:"json",success:function(e){"success"===e.status?(b.empty(),bookacti_clear_booking_system_displayed_info(b),bookacti.booking_system[c]=
e.booking_system_data,"undefined"!==typeof f.rescheduled_bookings_data&&(bookacti.booking_system[c].rescheduled_bookings_data=$j.extend(!0,{},f.rescheduled_bookings_data)),"undefined"!==typeof f.templates_per_activities&&(bookacti.booking_system[c].templates_per_activities=$j.extend(!0,{},f.templates_per_activities)),b.append(e.html_elements),bookacti_booking_method_set_up(b),bookacti_fill_booking_system_fields(b),bookacti_fill_picked_events_list(b),b.trigger("bookacti_booking_system_reloaded",[e,
f,d])):(console.log("undefined"!==typeof e.message?e.message:bookacti_localized.error),console.log(e))},error:function(e){console.log("AJAX "+bookacti_localized.error);console.log(e)},complete:function(){bookacti_stop_loading_booking_system(b)}})}
function bookacti_get_booking_system_attributes_without_data(b){b=b.attr("id");var a=$j.extend(!0,{},bookacti.booking_system[b]),c=$j.extend(!0,{},bookacti.booking_system[b]),f=bookacti_localized.booking_system_attributes_keys;$j.each(a,function(d,e){-1===$j.inArray(d,f)&&delete c[d]});return c}
function bookacti_get_interval_of_events(b,a){var c=b.attr("id"),f=bookacti.booking_system[c].events_interval,d=bookacti_get_availability_period(b);c=parseInt(bookacti_localized.event_load_interval);var e=d.start?moment.utc(d.start):!1;d=d.end?moment.utc(d.end):!1;var g=moment.utc(a.start).clone(),h=moment.utc(a.end).clone();e&&g.isBefore(e)&&(g=e.clone());d&&h.isAfter(d)&&(h=d.clone());var l={},p={start:g.clone(),end:h.clone()};if($j.isEmptyObject(f))l=bookacti_get_new_interval_of_events(b,p);else{var n=
moment.utc(f.start).clone().locale("en");f=moment.utc(f.end).clone().locale("en");if(g.isBefore(n)||h.isAfter(f)){l=n.clone();var k=f.clone(),m=moment.utc(a.start).clone().subtract(1,"days").locale("en");a=moment.utc(a.end).clone().add(1,"days").locale("en");if((g.isBefore(n)&&h.isAfter(f)||h.isBefore(n)||g.isAfter(f))&&m.format("YYYY-MM-DD")+" 23:59:59"!==f.format("YYYY-MM-DD HH:mm:ss")&&a.format("YYYY-MM-DD")+" 00:00:00"!==n.format("YYYY-MM-DD HH:mm:ss"))bookacti_booking_method_clear_events(b),
l=bookacti_get_new_interval_of_events(b,p);else{if(g.isBefore(n)||a.format("YYYY-MM-DD")+" 00:00:00"===n.format("YYYY-MM-DD HH:mm:ss"))l.subtract(c,"days"),g.isBefore(l)&&(l=g.clone()),e&&l.isBefore(e)&&(l=e.clone()),k=moment.utc(n.clone().subtract(1,"days").format("YYYY-MM-DD")+" 23:59:59");else if(h.isAfter(f)||m.format("YYYY-MM-DD")+" 23:59:59"===f.format("YYYY-MM-DD HH:mm:ss"))k.add(c,"days"),h.isAfter(k)&&(k=h.clone()),d&&k.isAfter(d)&&(k=d.clone()),l=moment.utc(f.clone().add(1,"days").format("YYYY-MM-DD")+
" 00:00:00");l={start:l.locale("en").format("YYYY-MM-DD HH:mm:ss"),end:k.locale("en").format("YYYY-MM-DD HH:mm:ss")}}}}return l}
function bookacti_get_new_interval_of_events(b,a){var c=b.attr("id"),f=bookacti_get_availability_period(b);if("undefined"===typeof f.start||"undefined"===typeof f.end)return{};c=bookacti.booking_system[c].past_events;var d=moment.utc(bookacti_localized.current_time),e=d.locale("en").format("YYYY-MM-DD HH:mm:ss");b=f.start?moment.utc(f.start):!1;var g=f.end?moment.utc(f.end):!1;if(!c&&g&&g.isBefore(d))return[];$j.isEmptyObject(a)&&(b&&b.isAfter(d)&&(a={start:f.start,end:f.start}),g&&$j.isEmptyObject(a)&&
g.isBefore(d)&&(a={start:f.end,end:f.end}),$j.isEmptyObject(a)&&(a={start:e,end:e}));e=parseInt(bookacti_localized.event_load_interval);f=moment.utc(moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD")+" 00:00:00");d=moment.utc(moment.utc(a.end).clone().locale("en").format("YYYY-MM-DD")+" 23:59:59");a=parseInt(Math.abs(moment.utc(a.end).diff(a.start,"days")));a>e&&(e=a);e=a=Math.round((e-a)/2);c?(f.subtract(a,"days"),b&&b.isAfter(f)&&(e+=Math.abs(f.diff(b,"days")))):e+=a;b&&b.isAfter(f)&&
(f=b.clone());d.add(e,"days");g&&g.isBefore(d)&&(d=g.clone());return{start:f.locale("en").format("YYYY-MM-DD HH:mm:ss"),end:d.locale("en").format("YYYY-MM-DD HH:mm:ss")}}function bookacti_get_extended_events_interval(b,a){b=b.attr("id");b=bookacti.booking_system[b].events_interval;return $j.isEmptyObject(a)?b:$j.isEmptyObject(b)?{start:a.start,end:a.end}:{start:moment.utc(a.start).isBefore(moment.utc(b.start))?a.start:b.start,end:moment.utc(a.end).isAfter(moment.utc(b.end))?a.end:b.end}}
function bookacti_get_availability_period(b){b=b.attr("id");b=bookacti.booking_system[b];return{start:b.start,end:b.end}}
function bookacti_refresh_booking_numbers(b){var a=b.attr("id"),c=bookacti.booking_system[a].calendars,f=bookacti.booking_system[a].groups_data,d=bookacti.booking_system[a].groups_events;bookacti_start_loading_booking_system(b);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingNumbers",template_ids:c,groups_data:f,groups_events:d},dataType:"json",success:function(e){bookacti.booking_system[a].bookings=[];"undefined"!==typeof e.bookings&&(bookacti.booking_system[a].bookings=
e.bookings,bookacti.booking_system[a].groups_bookings=e.groups_bookings);bookacti_booking_method_rerender_events(b)},error:function(e){alert("AJAX "+bookacti_localized.error);console.log(e)},complete:function(){bookacti_stop_loading_booking_system(b)}})}
function bookacti_event_click(b,a){var c=b.attr("id"),f=bookacti.booking_system[c].multiple_bookings;if(!bookacti_unpick_events(b,a)){var d={},e=[],g=0;"bookacti-booking-system-reschedule"!==c&&(d=bookacti_get_event_groups(b,a),g=bookacti_get_event_groups_nb(d),e=Object.keys(d));var h=!1;1<g||1===g&&bookacti.booking_system[c].groups_single_events?(h=!0,bookacti_dialog_choose_group_of_events(b,d,a)):(e=(c=e.length?e[0]:0)?Object.keys(d[c]):[],e=e.length?e[0]:"",f||bookacti_unpick_all_events(b),bookacti_pick_events(b,
a,c,e),c&&b.trigger("bookacti_group_of_events_chosen",[c,e,a]));b.trigger("bookacti_event_click",[a,d,h])}}
function bookacti_get_event_groups(b,a){var c={};if("object"!==typeof a||"undefined"===typeof a.id||"undefined"===typeof a.start||"undefined"===typeof a.end)return c;b=b.attr("id");var f="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),d=moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),e=moment.utc(a.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),g=bookacti.booking_system[b]?.groups_first_event_only;$j.each(bookacti.booking_system[b].groups_events,function(h,
l){$j.each(l,function(p,n){$j.each(n,function(k,m){if(parseInt(m.id)===f&&m.start===d&&m.end===e)return"undefined"===typeof c[h]&&(c[h]={}),c[h][p]=n,!1;if(g&&parseInt(g))return!1})})});return c}function bookacti_get_event_groups_nb(b){var a=0;$j.each(b,function(c,f){$j.each(f,function(d,e){++a})});return a}
function bookacti_fill_booking_system_fields(b){var a=b.siblings(".bookacti-booking-system-inputs");if(a.length){a.find('input[name^="selected_events"]').remove();var c=0,f=b.attr("id");$j.each(bookacti.booking_system[f].picked_events,function(d,e){a.append('<input type="hidden" name="selected_events['+c+'][group_id]" value="'+e.group_id+'"/>');a.append('<input type="hidden" name="selected_events['+c+'][group_date]" value="'+e.group_date+'"/>');a.append('<input type="hidden" name="selected_events['+
c+'][id]" value="'+e.id+'"/>');a.append('<input type="hidden" name="selected_events['+c+'][start]" value="'+e.start+'"/>');a.append('<input type="hidden" name="selected_events['+c+'][end]" value="'+e.end+'"/>');++c});b.trigger("bookacti_fill_booking_system_fields")}}
function bookacti_pick_events(b,a,c,f){$j.isNumeric(a)&&(a={id:parseInt(a),start:"",end:""});c=$j.isNumeric(c)?parseInt(c):0;f=f?f:"";var d="undefined"!==typeof a.groupId?parseInt(a.groupId):"undefined"!==typeof a.id?parseInt(a.id):0,e=0;if(!c&&!d)return e;c?(d=b.attr("id"),"undefined"!==typeof bookacti.booking_system[d].groups_events[c]&&"undefined"!==typeof bookacti.booking_system[d].groups_events[c][f]&&(d=bookacti.booking_system[d].groups_events[c][f].slice(),$j.each(d,function(g,h){group_picked_nb=
bookacti_pick_event(b,h,c,f);e+=group_picked_nb}))):e=bookacti_pick_event(b,a);b.trigger("bookacti_events_picked",[a,c,f]);return e}
function bookacti_is_event_picked(b,a){b=b.attr("id");b=$j.extend(!0,{},bookacti.booking_system[b].picked_events);var c="undefined"!==typeof a.start?moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD"):"",f=$j.isNumeric(a)?parseInt(a):"undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),d=!1;b&&$j.each(b,function(e,g){if(g.id==f&&($j.isNumeric(a)||g.start.substr(0,10)===c))return d=g,!1});return d}
function bookacti_pick_event(b,a,c,f){$j.isNumeric(a)&&(a={id:parseInt(a),start:"",end:""});c=$j.isNumeric(c)?parseInt(c):0;f=f?f:"";var d="undefined"!==typeof a.groupId?parseInt(a.groupId):"undefined"!==typeof a.id?parseInt(a.id):0,e=0;if(!c&&!d)return e;var g=b.attr("id"),h="undefined"!==typeof a.title?a.title:"",l="undefined"!==typeof a.activity_id?parseInt(a.activity_id):0;l||"undefined"===typeof bookacti.booking_system[g].events_data[d]||(h=bookacti.booking_system[g].events_data[d].title,l=bookacti.booking_system[g].events_data[d].activity_id);
var p="undefined"!==typeof a.start?a.start:"",n="undefined"!==typeof a.end?a.end:"";d={group_id:c,group_date:f?moment.utc(f).clone().locale("en").format("YYYY-MM-DD"):"",id:d,start:p?moment.utc(p).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"):"",end:n?moment.utc(n).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"):"",title:h,activity_id:parseInt(l)};bookacti.booking_system[g].picked_events.push(d);++e;bookacti.booking_system[g].picked_events.sort(function(k,m){k=moment.utc(k.start);m=moment.utc(m.start);
return k.isBefore(m)?-1:k.isAfter(m)?1:0});b.trigger("bookacti_pick_event",[a,c,f]);return e}
function bookacti_unpick_events(b,a,c,f){$j.isNumeric(a)&&(a={id:parseInt(a),start:"",end:""});c=$j.isNumeric(c)?parseInt(c):0;f=f?f:"";var d="undefined"!==typeof a.groupId?parseInt(a.groupId):"undefined"!==typeof a.id?parseInt(a.id):0,e=0;if(!c&&!d)return e;var g=b.attr("id"),h="undefined"!==typeof a.start?a.start:"",l=h?moment.utc(h).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"):"",p=c,n=f?moment.utc(f).clone().locale("en").format("YYYY-MM-DD"):"",k=[];$j.each(bookacti.booking_system[g].picked_events,
function(m,q){if(!q.group_id)return!0;m=q.group_id+"_"+q.group_date;var r=p&&q.group_id==p?1:0,B=n&&q.group_date===n?1:0,C=d&&q.id==d?1:0;q=l&&q.start.substr(0,10)===l.substr(0,10)?1:0;d||!r||n&&!B||k.push(m);p||!C||l&&!q||k.push(m);C&&r&&(n&&!B||l&&!q||k.push(m))});h=$j.grep(bookacti.booking_system[g].picked_events,function(m){var q=m.group_id+"_"+m.group_date,r=d&&m.id==d?1:0;m=l&&m.start.substr(0,10)===l.substr(0,10)?1:0;return 0<=$j.inArray(q,k)||r&&!l||r&&m?(++e,!1):!0});bookacti.booking_system[g].picked_events=
h;b.trigger("bookacti_events_unpicked",[a,c,f]);return e}function bookacti_unpick_all_events(b){var a=b.attr("id");bookacti.booking_system[a].picked_events=[];b.siblings(".bookacti-booking-system-inputs").find('input[name^="selected_events"]').remove();b.siblings(".bookacti-booking-system-inputs").find("input").val("");b.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list").empty();b.siblings(".bookacti-picked-events").hide();b.trigger("bookacti_unpick_all_events")}
function bookacti_get_picked_events_list_items(b){var a={},c=b.attr("id");qty_field=(b.closest("form").length?b.closest("form"):b.closest(".bookacti-form-fields")).find('input[name="quantity"], input.bookacti-quantity');var f=qty_field.length?parseInt(qty_field.val()):1;$j.each(bookacti.booking_system[c].picked_events,function(d,e){d=0;"undefined"!==typeof bookacti.booking_system[c].events_data&&0<parseInt(e.id)&&"undefined"!==typeof bookacti.booking_system[c].events_data[e.id]&&(d=bookacti.booking_system[c].events_data[e.id].activity_id);
var g=0;"undefined"!==typeof bookacti.booking_system[c].groups_data&&0<parseInt(e.group_id)&&"undefined"!==typeof bookacti.booking_system[c].groups_data[e.group_id]&&(g=bookacti.booking_system[c].groups_data[e.group_id].category_id);d={id:e.id,title:e.title,group_id:e.group_id,group_date:e.group_date,start:moment.utc(e.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),end:moment.utc(e.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),activity_id:parseInt(d),category_id:parseInt(g),quantity:f};
b.trigger("bookacti_picked_events_list_item_data",[d,e]);e=0<parseInt(d.group_id)?"group_"+d.group_id+"_"+d.group_date:"event_"+d.id+"_"+d.start+"_"+d.end;g=$j("<li></li>",{html:'<span class="bookacti-booking-event-title" >'+d.title+"</span>"});var h=bookacti_format_event_duration(d.start,d.end);h&&g.append('<span class="bookacti-booking-event-title-separator" > - </span>'+h);0<d.quantity&&(h=bookacti_get_activity_unit(b,d.activity_id,d.quantity))&&g.append('<span class="bookacti-booking-event-quantity-separator" > - </span><span class="bookacti-booking-event-quantity" >'+
d.quantity+" "+h+"</span>");g.data("event-id",d.id).attr("data-event-id",d.id);g.data("event-start",d.start).attr("data-event-start",d.start);g.data("event-end",d.end).attr("data-event-end",d.end);0<parseInt(d.group_id)?"undefined"===typeof a[e]?(h="","undefined"!==typeof bookacti.booking_system[c].groups_data[d.group_id]&&(h='<span class="bookacti-picked-group-of-events-title">'+bookacti.booking_system[c].groups_data[d.group_id].title+"</span>"),g=$j("<li></li>",{html:h+'<ul class="bookacti-picked-group-of-events-list">'+
g[0].outerHTML+"</ul>"}),g.data("group-id",d.group_id).attr("data-group-id",d.group_id),g.data("group-date",d.group_date).attr("data-group-date",d.group_date),a[e]=$j.extend(!0,{},d),a[e].list_element=g):(a[e].end=d.end,a[e].list_element.find("ul").append(g)):(a[e]=$j.extend(!0,{},d),a[e].list_element=g)});b.trigger("bookacti_picked_events_list_items",[a]);return a}
function bookacti_fill_picked_events_list(b){var a=b.attr("id"),c=b.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list-title"),f=b.siblings(".bookacti-picked-events").find(".bookacti-picked-events-list");f.empty();b.siblings(".bookacti-picked-events").hide();if("undefined"!==typeof bookacti.booking_system[a].picked_events&&bookacti.booking_system[a].picked_events.length){var d=bookacti.booking_system[a].multiple_bookings;c.html(1===bookacti.booking_system[a].picked_events.length?
bookacti_localized.selected_event:bookacti_localized.selected_events);a=bookacti_get_picked_events_list_items(b);$j.each(a,function(e,g){e=g.list_element;d&&(e.find(".bookacti-picked-group-of-events-title").length?e.find(".bookacti-picked-group-of-events-title").after('<span class="bookacti-unpick-event-icon"></span>'):e.append('<span class="bookacti-unpick-event-icon"></span>'));f.append(e)});f.is(":empty")||b.siblings(".bookacti-picked-events").show();b.trigger("bookacti_picked_events_list_filled")}}
function bookacti_set_tooltip_position(b,a,c){if(a.length){c=0<=$j.inArray(c,["below","above"])?c:"below";a.css("position","absolute");var f=$j(window).width();a.outerWidth()>f-40&&(a.css("min-width",f-40+"px"),a.outerWidth(f-40));var d=b.offset(),e=b.offset().left+b.outerWidth()/2;d.top+="above"===c?-1*(a.outerHeight()+15):b.height()+15;d.left=e-a.outerWidth()/2;0>d.left&&(d.left=20);b=d.left+a.outerWidth();b>f-20&&(d.left-=b-(f-20));a.offset(d);c="above"===c?"bookacti-tooltip-arrow-bottom":"bookacti-tooltip-arrow-top";
a.find(".bookacti-tooltip-arrow."+c).length||(a.find(".bookacti-tooltip-arrow").remove(),a.append('<div class="bookacti-tooltip-arrow '+c+'"></div>'));a=a.find(".bookacti-tooltip-arrow");d=e-d.left-a.outerWidth()/2;a.css("left",d+"px")}}
function bookacti_get_min_and_max_quantity(b){var a=b.attr("id"),c=bookacti.booking_system[a],f=[],d=1,e=999999999,g=999999999,h,l,p,n;$j.each(c.picked_events,function(k,m){l=h=0;p=1;n=!1;if(0<parseInt(m.group_id)){k=m.group_id+""+m.group_date;if(-1<$j.inArray(k,f))return!0;f.push(k);"undefined"!==typeof c.groups_data&&"undefined"!==typeof c.groups_data[m.group_id]&&(k=parseInt(c.groups_data[m.group_id].category_id),"undefined"!==typeof c.group_categories_data&&"undefined"!==typeof c.group_categories_data[k]&&
"undefined"!==typeof c.group_categories_data[k].settings&&(k=c.group_categories_data[k].settings,p="undefined"===typeof k.min_bookings_per_user?1:k.min_bookings_per_user?parseInt(k.min_bookings_per_user):1,n="undefined"===typeof k.max_bookings_per_user?!1:k.max_bookings_per_user?parseInt(k.max_bookings_per_user):!1));m.group_date&&"undefined"!==typeof c.groups_bookings[m.group_id]&&"undefined"!==typeof c.groups_bookings[m.group_id][m.group_date]&&(h=parseInt(c.groups_bookings[m.group_id][m.group_date].availability),
p||n)&&(l=parseInt(c.groups_bookings[m.group_id][m.group_date].current_user_bookings))}else"undefined"!==typeof c.events_data&&"undefined"!==typeof c.events_data[m.id]&&(h=bookacti_get_event_availability(b,m),k=parseInt(c.events_data[m.id].activity_id),"undefined"!==typeof c.activities_data&&"undefined"!==typeof c.activities_data[k]&&"undefined"!==typeof c.activities_data[k].settings&&(k=c.activities_data[k].settings,p="undefined"===typeof k.min_bookings_per_user?1:k.min_bookings_per_user?parseInt(k.min_bookings_per_user):
1,n="undefined"===typeof k.max_bookings_per_user?!1:k.max_bookings_per_user?parseInt(k.max_bookings_per_user):!1,p||n))&&(k=moment.utc(m.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss"),"undefined"!==typeof c.bookings[m.id]&&"undefined"!==typeof c.bookings[m.id][k]&&(l=parseInt(c.bookings[m.id][k].current_user_bookings)));n=n&&0!=n&&n-l<h?Math.max(n-l,0):h;p=p&&0!=p&&1<p&&l<p?Math.max(p-l,0):1;p>d&&(d=p);n&&n<e&&(e=n);h<g&&(g=h)});a={avail:g,min:d,max:e};b.trigger("bookacti_min_and_max_quantity",
[a]);return a}
function bookacti_set_min_and_max_quantity(b){var a=bookacti_get_min_and_max_quantity(b),c=b.closest("form").length?b.closest("form"):b.closest(".bookacti-form-fields");a.field=c.find('input[name="quantity"]');b.trigger("bookacti_update_quantity",[a]);if(!a.field.length)return a;c=parseInt(a.field.val());a.value=c;c>a.max&&(a.value=a.max);c<a.min&&(a.min>a.avail&&(a.max=a.min),a.value=a.min);a.field.attr("min",1);a.field.removeAttr("max");b=b.attr("id");if(!bookacti.booking_system[b].picked_events.length)return a;a.field.attr("max",
a.max);a.field.attr("min",a.min);a.field.val(a.value);c!==parseInt(a.value)&&a.field.trigger("bookacti_quantity_updated",[c,a]);return a}
function bookacti_format_event_duration(b,a){b=moment.utc(b).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");a=moment.utc(a).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var c=moment.utc(b).clone().locale(bookacti_localized.current_lang_code),f=moment.utc(a).clone().locale(bookacti_localized.current_lang_code);b=(a=b.substr(0,10)===a.substr(0,10))?"bookacti-booking-event-end-same-day":"";f=a?f.formatPHP(bookacti_localized.time_format):f.formatPHP(bookacti_localized.date_format);a=a?bookacti_localized.date_time_separator:
bookacti_localized.dates_separator;return'<span class="bookacti-booking-event-start">'+c.formatPHP(bookacti_localized.date_format)+'</span><span class="bookacti-booking-event-date-separator '+b+'">'+a+'</span><span class="bookacti-booking-event-end '+b+'">'+f+"</span>"}
function bookacti_get_activity_unit(b,a,c){c=$j.isNumeric(c)?parseInt(c):1;if(!a||0===c)return"";b=b.attr("id");if("undefined"===typeof bookacti.booking_system[b].activities_data||"undefined"===typeof bookacti.booking_system[b].activities_data[a])return"";a=bookacti.booking_system[b].activities_data[a];if("undefined"===typeof a.settings||"undefined"===typeof a.settings.unit_name_plural||"undefined"===typeof a.settings.unit_name_singular||""===a.settings.unit_name_plural||""===a.settings.unit_name_singular)return"";
c=1===c?a.settings.unit_name_singular:a.settings.unit_name_plural;return"undefined"===typeof a.settings.places_number||""===a.settings.places_number||0===parseInt(a.settings.places_number)?c:c+=1===parseInt(a.settings.places_number)?" "+bookacti_localized.one_person_per_booking:" "+bookacti_localized.n_people_per_booking.replace("%1$s",a.settings.places_number)}
function bookacti_clear_booking_system_displayed_info(b,a){a||bookacti_unpick_all_events(b);b.siblings(".bookacti-notices").hide();b.siblings(".bookacti-notices").empty();b.show();b.trigger("bookacti_displayed_info_cleared")}
function bookacti_get_event_number_of_bookings(b,a){b=b.attr("id");b=bookacti.booking_system[b];var c="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);a=moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var f=0;"undefined"!==typeof b.bookings&&"undefined"!==typeof b.bookings[c]&&"undefined"!==typeof b.bookings[c][a]&&"undefined"!==typeof b.bookings[c][a].quantity&&$j.isNumeric(b.bookings[c][a].quantity)&&(f=parseInt(b.bookings[c][a].quantity));return f}
function bookacti_get_event_availability(b,a){var c=b.attr("id"),f=bookacti.booking_system[c],d="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);c=0;"undefined"!==typeof a.availability&&(c=a.availability);"undefined"!==typeof f.events_data[d]&&"undefined"!==typeof f.events_data[d].availability&&$j.isNumeric(f.events_data[d].availability)&&(c=parseInt(f.events_data[d].availability));b=bookacti_get_event_number_of_bookings(b,a);return c-b}
function bookacti_is_event_available(b,a){var c=b.attr("id"),f=bookacti.booking_system[c],d=f.past_events,e=f.past_events_bookable,g="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),h=moment.utc(a.start).clone().locale("en"),l=moment.utc(a.end).clone().locale("en"),p=moment.utc(bookacti_localized.current_time),n=bookacti_get_event_availability(b,a),k=bookacti_get_availability_period(b),m=!1,q=!0;"undefined"!==typeof a.is_available&&(a.is_available||(q=!1));"undefined"!==typeof a.extendedProps&&
"undefined"!==typeof a.extendedProps.is_available&&(a.extendedProps.is_available||(q=!1));if(0>=n)return!1;b=bookacti_get_event_groups(b,a);a=0<bookacti_get_event_groups_nb(b);var r=f.groups_single_events;if("bookacti-booking-system-reschedule"===c){if(a&&!r)return!1;if(c="undefined"!==typeof f.rescheduled_bookings_data?f.rescheduled_bookings_data:[]){var B=0,C=!1,D=1;$j.each(c,function(u,v){v?.event_id==g&&v?.event_start===h.format("YYYY-MM-DD HH:mm:ss")&&v?.event_end===l.format("YYYY-MM-DD HH:mm:ss")&&
(C=!0);"undefined"!==typeof v.quantity&&parseInt(v.quantity)>D&&(D=parseInt(v.quantity));++B});if(C&&1===B||D>n)return!1}}if((!a||a&&r)&&q&&"undefined"!==typeof f.events_data[g]&&(q=!1,d&&(e||!h.isBefore(p)||bookacti_localized.started_events_bookable&&l.isAfter(p)||(q=!0),e||(k.start&&h.isBefore(moment.utc(k.start))&&(q=!0),k.end&&l.isAfter(moment.utc(k.end))&&(q=!0))),!q)){d=parseInt(f.events_data[g].activity_id);r=f.activities_data[d].settings;d=max_qty_ok=max_users_ok=!0;event_start_formatted=
h.format("YYYY-MM-DD HH:mm:ss");if("undefined"!==typeof f.bookings[g]&&"undefined"!==typeof f.bookings[g][event_start_formatted]&&(q="undefined"===typeof r.min_bookings_per_user?0:r.min_bookings_per_user?parseInt(r.min_bookings_per_user):0,c="undefined"===typeof r.max_bookings_per_user?0:r.max_bookings_per_user?parseInt(r.max_bookings_per_user):0,r="undefined"===typeof r.max_users_per_event?0:r.max_users_per_event?parseInt(r.max_users_per_event):0,q||c||r)){var H=f.bookings[g][event_start_formatted],
E=parseInt(H.current_user_bookings);r&&0===E&&H.distinct_users>=r&&(max_users_ok=!1);c&&E>=c&&(max_qty_ok=!1);q&&q>n+E&&(d=!1)}d&&max_qty_ok&&max_users_ok&&(m=!0)}a&&!m&&$j.each(b,function(u,v){var I=f.groups_data[u],K=parseInt(I.category_id),t=f.group_categories_data[K].settings,J=parseInt(bookacti_localized.started_groups_bookable);"undefined"!==typeof t.started_groups_bookable&&0<=$j.inArray(t.started_groups_bookable,[0,1,"0","1",!0,!1])&&(J=$j.isNumeric(t.started_groups_bookable)?parseInt(t.started_groups_bookable):
t.started_groups_bookable?1:0);$j.each(v,function(w,x){var y=moment.utc(x[0].start).clone();x=moment.utc(x[x.length-1].end).clone();if(!(e||!y.isBefore(p)||J&&x.isAfter(p))||!e&&(k.start&&y.isBefore(moment.utc(k.start))||k.end&&y.isAfter(moment.utc(k.end))))return!0;var z;var A=y=z=x=0;"undefined"!==typeof f.groups_bookings[u]&&"undefined"!==typeof f.groups_bookings[u][w]&&(A=f.groups_bookings[u][w].is_available,y=f.groups_bookings[u][w].availability,z=f.groups_bookings[u][w].current_user_bookings,
x=f.groups_bookings[u][w].distinct_users);if(A&&0<y){w=max_qty_ok=max_users_ok=!0;if(null!=I){A="undefined"===typeof t.max_users_per_event?0:t.max_users_per_event?parseInt(t.max_users_per_event):0;var F="undefined"===typeof t.max_bookings_per_user?0:t.max_bookings_per_user?parseInt(t.max_bookings_per_user):0,G="undefined"===typeof t.min_bookings_per_user?0:t.min_bookings_per_user?parseInt(t.min_bookings_per_user):0;if(G||F||A)z=parseInt(z),A&&0===z&&parseInt(x)>=A&&(max_users_ok=!1),F&&z>=F&&(max_qty_ok=
!1),G&&G>y+z&&(w=!1)}if(w&&max_qty_ok&&max_users_ok)return m=!0,!1}})});return m}function bookacti_get_bookings_number_for_a_single_grouped_event(b,a,c){c=$j.isEmptyObject(c)?bookacti_get_event_groups(b,a):c;var f=b.attr("id"),d=bookacti.booking_system[f];b=bookacti_get_event_number_of_bookings(b,a);var e=0;$j.each(c,function(g,h){$j.each(h,function(l,p){"undefined"!==typeof d.groups_bookings[g]&&"undefined"!==typeof d.groups_bookings[g][l]&&(e+=d.groups_bookings[g][l].quantity)})});return b-e}
function bookacti_get_event_availability_div(b,a){var c=b.attr("id"),f=bookacti.booking_system[c];b=bookacti_get_event_availability(b,a);var d="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id),e=a=0;"undefined"!==typeof f.events_data[d]&&("undefined"!==typeof f.events_data[d].activity_id&&(a=bookacti.booking_system[c].events_data[d].activity_id),"undefined"!==typeof f.events_data[d].availability&&(e=bookacti.booking_system[c].events_data[d].availability));f="";a&&(a=bookacti.booking_system[c].activities_data[a],
void 0!==a&&void 0!==a.settings&&"undefined"!==typeof a.settings.unit_name_plural&&"undefined"!==typeof a.settings.unit_name_singular&&"undefined"!==typeof a.settings.show_unit_in_availability&&parseInt(a.settings.show_unit_in_availability)&&(f=1===b?a.settings.unit_name_singular:a.settings.unit_name_plural));a=1<b?bookacti_localized.avails:bookacti_localized.avail;d=(b<e?"bookacti-booked":"bookacti-not-booked")+(0>=b?" bookacti-full":"");var g="",h=1==bookacti.booking_system[c].bookings_only?!0:
!1,l=parseInt(b/e*100);c=parseInt(bookacti.booking_system[c].hide_availability);e=parseInt(bookacti_localized.hide_availability_fixed);l=100>c&&l>c;var p=0<e&&b>e;!h&&(0>=e&&l||100<=c&&p||l&&p)&&(b="",g="bookacti-hide-availability");h="";f&&(h="bookacti-has-unit-name");c=$j("<div></div>",{"class":"bookacti-availability-container "+g});d=$j("<div></div>",{"class":"bookacti-available-places "+d});b=$j("<span></span>",{"class":"bookacti-available-places-number",html:b});f=$j("<span></span>",{"class":"bookacti-available-places-unit-name "+
h,html:f});a=$j("<span></span>",{"class":"bookacti-available-places-avail-particle",html:a});d.append(b);d.append(f);d.append(a);c.append(d);return c}
function bookacti_get_event_number_of_bookings_div(b,a){var c=b.attr("id"),f=bookacti_get_event_number_of_bookings(b,a);b=bookacti_get_event_availability(b,a);a="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);var d=0;"undefined"!==typeof bookacti.booking_system[c].events_data[a]&&"undefined"!==typeof bookacti.booking_system[c].events_data[a].availability&&(d=bookacti.booking_system[c].events_data[a].availability);b=(0===d?"bookacti-no-availability":"")+(0<f?" bookacti-booked":" bookacti-not-booked")+
(0>=b?" bookacti-full":"");c=$j("<div></div>",{"class":"bookacti-availability-container"});b=$j("<div></div>",{"class":"bookacti-available-places "+b});f=$j("<span></span>",{"class":"bookacti-active-bookings-number",html:f});b.append(f);c.append(b);return c}
function bookacti_sort_events_array_by_dates(b,a,c,f){a=a||!1;c=c||!1;f=f||{start:"start",end:"end"};b.sort(function(d,e){a||d[f.start]===e[f.start]?(d=moment.utc(d[f.end]),e=moment.utc(e[f.end])):(d=moment.utc(d[f.start]),e=moment.utc(e[f.start]));var g=0;d.isAfter(e)&&(g=1);d.isBefore(e)&&(g=-1);!0===c&&(g*=-1);return g});return b}
function bookacti_booking_method_set_up(b,a){a=a?1:0;var c=b.attr("id");booking_method=bookacti.booking_system[c].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");bookacti.booking_system[c].no_events||(b.trigger("bookacti_booking_method_set_up",[booking_method,a]),bookacti.booking_system[c].picked_events.length&&"undefined"!==typeof bookacti.booking_system[c].events&&(bookacti_set_min_and_max_quantity(b),bookacti_fill_picked_events_list(b)))}
function bookacti_booking_method_update_availability_period(b){var a=b.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");a=bookacti_get_availability_period(b);b.trigger("bookacti_booking_method_update_availability_period",[booking_method,a])}
function bookacti_booking_method_display_events(b,a){var c=b.attr("id");booking_method=bookacti.booking_system[c].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");b.trigger("bookacti_booking_method_display_events",[booking_method,a])}
function bookacti_booking_method_refetch_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");b.trigger("bookacti_refetch_events",[booking_method])}
function bookacti_booking_method_rerender_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");b.trigger("bookacti_rerender_events",[booking_method])}
function bookacti_booking_method_clear_events(b){var a=b.attr("id");booking_method=bookacti.booking_system[a].method;-1===$j.inArray(booking_method,bookacti_localized.available_booking_methods)&&(booking_method="calendar");bookacti.booking_system[a].events=[];bookacti.booking_system[a].events_data=[];bookacti.booking_system[a].events_interval=[];b.trigger("bookacti_clear_events",[booking_method])}
function bookacti_start_loading_booking_system(b){var a=b.attr("id");if("undefined"!==typeof bookacti.booking_system[a]){var c=bookacti.booking_system[a].method;-1===$j.inArray(c,bookacti_localized.available_booking_methods)&&(c="calendar");$j.isNumeric(bookacti.booking_system[a].loading_number)||(bookacti.booking_system[a].loading_number=0);b.trigger("bookacti_start_loading",[c]);bookacti.booking_system[a].loading_number++}}
function bookacti_stop_loading_booking_system(b,a){a=a?a:!1;var c=b.attr("id");if("undefined"!==typeof bookacti.booking_system[c]){var f=bookacti.booking_system[c].method;-1===$j.inArray(f,bookacti_localized.available_booking_methods)&&(f="calendar");bookacti.booking_system[c].loading_number--;bookacti.booking_system[c].loading_number=Math.max(bookacti.booking_system[c].loading_number,0);a&&(bookacti.booking_system[c].loading_number=0);0===bookacti.booking_system[c].loading_number&&b.trigger("bookacti_exit_loading_state",
[f,a])}}function bookacti_redirect_to_activity_url(b,a){var c=b.attr("id");c=bookacti.booking_system[c];a="undefined"!==typeof a.groupId?parseInt(a.groupId):parseInt(a.id);"undefined"!==typeof c.events_data[a]&&(a=c.events_data[a].activity_id,"undefined"!==typeof c.redirect_url_by_activity[a]&&bookacti_redirect_booking_system_to_url(b,c.redirect_url_by_activity[a]))}
function bookacti_redirect_to_group_category_url(b,a){var c=b.attr("id");c=bookacti.booking_system[c];"undefined"!==typeof c.groups_data[a]&&(a=c.groups_data[a].category_id,"undefined"!==typeof c.redirect_url_by_group_category[a]&&bookacti_redirect_booking_system_to_url(b,c.redirect_url_by_group_category[a]))}
function bookacti_redirect_booking_system_to_url(b,a){if(a){var c=b.closest("form").length?b.closest("form"):b.closest(".bookacti-form-fields"),f=c.find('input[type="submit"]');f.length&&f.prop("disabled",!0);bookacti_start_loading_booking_system(b);f.length&&bookacti_add_loading_html(f,"after");var d=bookacti_is_url_external(a)?1:0,e=bookacti_get_url_parameter("method",a).toUpperCase(),g="JS"===e||d&&!e?1:0;0>$j.inArray(e,["POST","GET"])&&(e=d?"GET":"POST");d={method:e,action:a,id:"","class":"bookacti-temporary-form",
"data-redirect-timeout":15E3,"data-redirect-with-js":g};b.trigger("bookacti_before_redirect",[d]);if(1===d["data-redirect-with-js"])window.location.assign(a);else if(b.closest("form").length){var h={};$j.each(d,function(l,p){h[l]=c.attr(l)});c.attr(d);c.submit();c.attr(h)}else b.closest(".bookacti-form-fields").wrap("<form></form>"),b.closest("form").attr(d).submit(),b.closest(".bookacti-form-fields").unwrap("form");b.trigger("bookacti_after_redirect",[d]);setTimeout(function(){bookacti_stop_loading_booking_system(b);
f.length&&(bookacti_remove_loading_html(b),f.prop("disabled",!1))},d["data-redirect-timeout"])}};
