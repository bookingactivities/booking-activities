$j(document).ready(function(){if($j("#bookacti-template-calendar").length||$j("#bookacti-first-template-container").length){bookacti.selected_template=parseInt($j("#bookacti-template-picker").val())||0;bookacti.hidden_activities=[];bookacti.selected_category="new";bookacti.is_dragging=false;bookacti.is_resizing=false;bookacti.blocked_events=false;bookacti.load_events=false;bookacti.booking_system["bookacti-template-calendar"]=[];bookacti.booking_system["bookacti-template-calendar"]["calendars"]=bookacti.selected_template?[bookacti.selected_template]:[];bookacti.booking_system["bookacti-template-calendar"]["bookings"]=[];bookacti.booking_system["bookacti-template-calendar"]["exceptions"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["activities_data"]={};bookacti.booking_system["bookacti-template-calendar"]["events_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["events_interval"]=[];bookacti.booking_system["bookacti-template-calendar"]["group_categories_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]={start:$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-start")||false,end:$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-end")||false};bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=0;bookacti.booking_system["bookacti-template-calendar"]["method"]="calendar";bookacti.booking_system["bookacti-template-calendar"]["past_events"]=true;bookacti.booking_system["bookacti-template-calendar"]["past_events_bookable"]=true;bookacti_init_activities();bookacti_init_groups_of_events();bookacti_init_show_hide_activities_switch();bookacti_init_template_dialogs();bookacti_bind_template_dialogs();$j("#bookacti-template-picker").on("change",function(){bookacti_switch_template($j(this).val())});if($j("#bookacti-template-calendar").length){bookacti_load_template_calendar()}if(bookacti.selected_template){bookacti_switch_template(bookacti.selected_template)}$j("#bookacti-template-activities-container").on("dragstart",".fc-event",function(a,b){b.helper.css("maxWidth",$j(this).width())});window.onerror=function(e,b,a,d,c){$j("#bookacti-fatal-error").show()};$j("#bookacti-exit-loading").on("click",function(){bookacti_exit_template_loading_state(true);bookacti.load_events=true})}});function bookacti_load_template_calendar(){var a=$j("#bookacti-template-calendar");a.fullCalendar({locale:bookacti_localized.fullcalendar_locale,defaultView:"agendaWeek",minTime:"08:00",maxTime:"20:00",slotLabelFormat:"LT",slotDuration:"00:30",snapDuration:"00:05",scrollTime:"08:00",nowIndicator:0,weekNumbers:0,weekNumbersWithinDays:1,navLinks:0,slotEventOverlap:0,eventLimit:2,eventLimitClick:"popover",showNonCurrentDates:0,allDaySlot:false,allDayDefault:false,fixedWeekCount:false,showNonCurrentDates:false,editable:true,droppable:true,dropAccept:".fc-event",eventDurationEditable:false,dragRevertDuration:0,views:{week:{eventLimit:false},day:{eventLimit:false},listDay:{buttonText:bookacti_localized.calendar_button_list_day},listWeek:{buttonText:bookacti_localized.calendar_button_list_week},listMonth:{buttonText:bookacti_localized.calendar_button_list_month},listYear:{buttonText:bookacti_localized.calendar_button_list_year}},header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},validRange:{start:moment($j("#bookacti-template-picker :selected").data("template-start")),end:moment($j("#bookacti-template-picker :selected").data("template-end")).add(1,"days")},events:function(e,b,c,d){d([])},viewRender:function(b){if(bookacti.load_events===true){var c={start:moment.utc(b.intervalStart),end:moment.utc(b.intervalEnd).subtract(1,"days")};bookacti_fetch_events_from_interval($j("#bookacti-template-calendar"),c)}if(b.name==="agendaWeek"||b.name==="agendaDay"){a.fullCalendar("option","contentHeight","auto")}else{a.fullCalendar("option","contentHeight",null)}},eventRender:function(r,e,p){if(bookacti.is_dragging||bookacti.is_resizing){return true}var k=bookacti.booking_system["bookacti-template-calendar"]["events_data"][r.id];e.data("event-id",r.id);e.attr("data-event-id",r.id);e.data("event-start",r.start.format("YYYY-MM-DD HH:mm:ss"));e.attr("data-event-start",r.start.format("YYYY-MM-DD HH:mm:ss"));e.data("event-end",r.end.format("YYYY-MM-DD HH:mm:ss"));e.attr("data-event-end",r.end.format("YYYY-MM-DD HH:mm:ss"));r.render=1;if(typeof k!=="undefined"&&k.activity_id){var n=k.activity_id;e.data("activity-id",n);e.attr("data-activity-id",n)}var u=e.find(".fc-title");u.html(u.text());var g="LT";e.find(".fc-time").html('<span class="bookacti-event-time-start">'+r.start.format(g)+'</span><span class="bookacti-event-time-separator"> - </span><span class="bookacti-event-time-end">'+r.end.format(g)+"</span>");if(typeof k!=="undefined"&&k.availability){var o=parseInt(k.availability);r.bookings=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),r);if(r.bookings!=null){var l="",b="",d="";if(o===0){l="bookacti-no-availability"}else{if(r.bookings>0){b="bookacti-booked"}else{b="bookacti-not-booked"}if(r.bookings>=o){d="bookacti-full"}}var c='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+l+" "+b+" "+d+'" ><span class="bookacti-bookings" >'+r.bookings+'</span><span class="bookacti-total-availability" >/'+o+"</span></span></div>";e.append(c)}}var m=e.find(".bookacti-event-actions").length>0?e.find(".bookacti-event-actions"):$j("<div />",{"class":"bookacti-event-actions"});var s=[];if(!m.find(".bookacti-event-action-edit").length){var f=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-edit","data-hide-on-mouseout":"1"});var j=$j("<span />",{type:"checkbox","class":"dashicons dashicons-admin-generic bookacti-event-action-edit-button","aria-hidden":"true"});s.push(f.prepend(j))}if(!m.find(".bookacti-event-action-select").length){var q=false;$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(w,v){if(v.id==r.id&&v.start.substr(0,10)===r.start.format("YYYY-MM-DD")){q=true;return false}});var t=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-select","data-hide-on-mouseout":"0"});var i=$j("<input />",{type:"checkbox","class":"bookacti-event-action-select-checkbox",value:"0",checked:q});s.push(t.append(i))}$j.each(s,function(w,v){m.append(v)});a.trigger("bookacti_event_actions",[m,r,e,p]);e.append(m);if(p.name==="month"||p.name==="basicWeek"||p.name==="basicDay"){var h=$j("<div />",{"class":"fc-bg"});e.append(h)}if(typeof k!=="undefined"&&k.repeat_freq){if(k.repeat_freq!=="none"){if(bookacti.booking_system["bookacti-template-calendar"]["exceptions"]!==undefined&&bookacti.booking_system["bookacti-template-calendar"]["exceptions"][r.id]!==undefined){$j.each(bookacti.booking_system["bookacti-template-calendar"]["exceptions"][r.id],function(v,w){if(w.exception_type==="date"&&w.exception_value===r.start.format("YYYY-MM-DD")){r.render=0}})}}}if(bookacti.hidden_activities!=null&&n!=null){$j.each(bookacti.hidden_activities,function(w,v){if(parseInt(n)===v){e.addClass("event-exception");r.render=0}})}a.trigger("bookacti_event_render",[r,e,p]);if(!r.render){return false}},eventAfterRender:function(d,c,b){bookacti_add_class_according_to_event_size(c)},eventAfterAllRender:function(b){if(bookacti.blocked_events===true){$j(".fc-event").addClass("bookacti-event-unavailable")}else{if($j.isNumeric(bookacti.blocked_events)){$j('.fc-event[data-event-id="'+bookacti.blocked_events+'"]').addClass("bookacti-event-unavailable")}else{$j(".fc-event").removeClass("bookacti-event-unavailable")}}$j(".fc-event.event-exception").remove();$j('.bookacti-event-action[data-hide-on-mouseout="1"]').hide();$j.each(bookacti.booking_system["bookacti-template-calendar"]["picked_events"],function(c,d){a.find('.fc-event[data-event-id="'+d.id+'"][data-event-start="'+d.start+'"]').addClass("bookacti-picked-event")});bookacti_refresh_selected_events_display()},eventReceive:function(e){var d=parseInt(e.activity_id);var f=bookacti.booking_system["bookacti-template-calendar"]["activities_data"][d];var c=a.fullCalendar("getView");if(!f){return false}if(c.name.substr(0,6)!=="agenda"){var b=a.fullCalendar("option","minTime");e.start.set({hours:b.substr(0,2),minutes:b.substr(3,2),seconds:0})}e.end=e.start.clone();e.end.add(moment.duration(f.duration));if(parseInt(f.is_resizable)===1){e.durationEditable=true}bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiInsertEvent",activity_id:d,template_id:bookacti.selected_template,event_title:f.multilingual_title,event_start:e.start.format("YYYY-MM-DD HH:mm:ss"),event_end:e.end.format("YYYY-MM-DD HH:mm:ss"),event_availability:f.availability,nonce:bookacti_localized.nonce_insert_event},type:"POST",dataType:"json",success:function(g){if(g.status==="success"){e.id=g.event_id;e.bookings=0;bookacti.booking_system["bookacti-template-calendar"]["events_data"][e.id]=g.event_data;a.fullCalendar("updateEvent",e)}else{if(e._id!==undefined){if(e._id.indexOf("_")>=0){a.fullCalendar("removeEvents",e._id)}}a.fullCalendar("removeEvents",e.id);a.fullCalendar("refetchEvents");var h=bookacti_localized.error_insert_event;if(g.error==="not_allowed"){h+="\n"+bookacti_localized.error_not_allowed}alert(h);console.log(g)}},error:function(g){alert("AJAX "+bookacti_localized.error_insert_event);console.log(g)},complete:function(){bookacti_stop_template_loading()}})},eventResize:function(c,j,h){var b={id:c.id,start:c.start.clone(),end:c.end.clone().subtract(j._data),};var k=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),b);if(k>0){h();var f=bookacti.booking_system["bookacti-template-calendar"]["events_data"][c.id]["repeat_freq"]!=="none";if(f){bookacti_dialog_unbind_occurences(c,["resize"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}var d=c.id;var e=c.start.format("YYYY-MM-DD HH:mm:ss");var g=c.end.format("YYYY-MM-DD HH:mm:ss");var i=j._days;bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiResizeEvent",delta_days:i,event_id:d,event_start:e,event_end:g,nonce:bookacti_localized.nonce_move_or_resize_event},type:"POST",dataType:"json",success:function(l){if(l.status==="success"){var m=c.end.format("HH:mm:ss");$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(q,p){if(p.id==c.id){var o=moment(p.end).add(i,"days").format("YYYY-MM-DD")+" "+m;p.end=o}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(o,p){$j.each(p,function(r,s){if(s.id==c.id){var q=moment(s.end).add(i,"days").format("YYYY-MM-DD")+" "+m;s.end=q}})})}else{if(l.status==="failed"){h();if(l.error==="has_bookings"){if(!c.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),c.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][c.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurences(c,["resize"])}}var n=bookacti_localized.error_resize_event;if(l.error==="not_allowed"){n+="\n"+bookacti_localized.error_not_allowed}else{if(l.error==="has_bookings"){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),c.id);n+="\n"+bookacti_localized.error_edit_locked_event;n+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(n);console.log(l)}}},error:function(l){h();alert("AJAX "+bookacti_localized.error_resize_event);console.log(l)},complete:function(){bookacti_stop_template_loading()}})},eventDrop:function(c,n,l,k){var d=0;if(k.altKey){d=1}if(d){l()}else{var b={id:c.id,start:c.start.clone().subtract(n._data),end:c.end.clone().subtract(n._data),};var o=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),b);if(o>0){l();var i=bookacti.booking_system["bookacti-template-calendar"]["events_data"][c.id]["repeat_freq"]!=="none";if(i){bookacti_dialog_unbind_occurences(c,["move"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}}var g=c.id;var f=c.start.format("YYYY-MM-DD HH:mm:ss");var j=(c.end===null)?f:c.end.format("YYYY-MM-DD HH:mm:ss");var m=n._days;var h=bookacti.booking_system["bookacti-template-calendar"]["events_interval"];bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiMoveEvent",delta_days:m,event_id:g,event_start:f,event_end:j,interval:h,is_duplicated:d,nonce:bookacti_localized.nonce_move_or_resize_event},type:"POST",dataType:"json",success:function(e){if(e.status==="success"){if(d){var p=e.event_id;if(typeof e.exceptions[p]!=="undefined"){bookacti.booking_system["bookacti-template-calendar"]["exceptions"][p]=e.exceptions[p]}if(!$j.isEmptyObject(e.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][p]=e.event_data}$j("#bookacti-template-calendar").fullCalendar("addEventSource",e.events);return false}var s=c.start.format("HH:mm:ss");var q=c.end.format("HH:mm:ss");if(!$j.isEmptyObject(e.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][g]=e.event_data}$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(v,u){if(u.id==c.id){var w=moment(u.start).add(m,"days").format("YYYY-MM-DD")+" "+s;var t=moment(u.end).add(m,"days").format("YYYY-MM-DD")+" "+q;u.start=w;u.end=t}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(t,u){$j.each(u,function(w,y){if(y.id==c.id){var x=moment(y.start).add(m,"days").format("YYYY-MM-DD")+" "+s;var v=moment(y.end).add(m,"days").format("YYYY-MM-DD")+" "+q;y.start=x;y.end=v}})});if(e.events.length>0){$j("#bookacti-template-calendar").fullCalendar("removeEvents",g);$j("#bookacti-template-calendar").fullCalendar("addEventSource",e.events)}}else{if(e.status==="failed"){l();if(e.error==="has_bookings"){if(!c.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),c.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][c.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurences(c,["move"])}}var r=bookacti_localized.error_move_event;if(e.error==="not_allowed"){r+="\n"+bookacti_localized.error_not_allowed}else{if(e.error==="has_bookings"){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),c.id);r+="\n"+bookacti_localized.error_edit_locked_event;r+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(r);console.log(e)}}},error:function(p){l();alert("AJAX "+bookacti_localized.error_move_event);console.log(p)},complete:function(){bookacti_stop_template_loading()}})},eventDragStart:function(d,c,e,b){bookacti.is_dragging=true},eventDragStop:function(d,c,e,b){bookacti.is_dragging=false},eventResizeStart:function(d,c,e,b){bookacti.is_resizing=true},eventResizeStop:function(d,c,e,b){bookacti.is_resizing=false},eventClick:function(e,c,b){var d=$j(this);var f=$j('.fc-event[data-event-id="'+e.id+'"][data-event-start="'+e.start.format("YYYY-MM-DD HH:mm:ss")+'"]');if(bookacti.is_touch_device){if(!d.find(".bookacti-event-action").is(":visible")){$j(".bookacti-event-over").removeClass("bookacti-event-over");bookacti_show_event_actions(d)}else{bookacti_hide_event_actions(d,e)}}$j(".fc-event").removeClass("bookacti-picked-event");f.addClass("bookacti-picked-event");bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"].push({id:e.id,start:e.start.format("YYYY-MM-DD HH:mm:ss"),end:e.end.format("YYYY-MM-DD HH:mm:ss")});if($j(c.target).parents(".bookacti-event-actions").length){if($j(c.target).is(".bookacti-event-action-edit")||$j(c.target).parents(".bookacti-event-action-edit").length){if(e.editable!==false){bookacti_dialog_update_event(e)}}else{if($j(c.target).is(".bookacti-event-action-select")||$j(c.target).parents(".bookacti-event-action-select").length){if(d.find(".bookacti-event-action-select-checkbox").is(":checked")){bookacti_select_event(e)}else{bookacti_unselect_event(e);d.find(".bookacti-event-action-select").show()}}}}a.trigger("bookacti_pick_event",[e,c,b])},eventMouseover:function(e,c,b){var d=$j(this);bookacti_show_event_actions(d)},eventMouseout:function(e,c,b){var d=$j(this);bookacti_hide_event_actions(d,e)},loading:function(b){if(!b&&bookacti.is_touch_device){$j(".fc-event").each(function(){var c=$j.Event("mouseover",{target:this.firstChild,_dummyCalledOnStartup:true});$j(this).trigger(c)})}}})};