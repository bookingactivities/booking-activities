$j(document).ready(function(){if($j("#bookacti-template-calendar").length||$j("#bookacti-first-template-container").length){bookacti.selected_template=parseInt($j("#bookacti-template-picker").val())||0;bookacti.hidden_activities=[];bookacti.selected_category="new";bookacti.is_dragging=false;bookacti.is_resizing=false;bookacti.blocked_events=false;bookacti.load_events=false;bookacti.booking_system["bookacti-template-calendar"]={};bookacti.booking_system["bookacti-template-calendar"]["calendars"]=bookacti.selected_template?[bookacti.selected_template]:[];bookacti.booking_system["bookacti-template-calendar"]["bookings"]=[];bookacti.booking_system["bookacti-template-calendar"]["exceptions"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["activities_data"]={};bookacti.booking_system["bookacti-template-calendar"]["events_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["events_interval"]=[];bookacti.booking_system["bookacti-template-calendar"]["group_categories_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]={start:$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-start")||false,end:$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-end")||false};bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=0;bookacti.booking_system["bookacti-template-calendar"]["method"]="calendar";bookacti.booking_system["bookacti-template-calendar"]["past_events"]=true;bookacti.booking_system["bookacti-template-calendar"]["past_events_bookable"]=true;bookacti_init_activities();bookacti_init_groups_of_events();bookacti_init_show_hide_activities_switch();bookacti_init_template_dialogs();bookacti_bind_template_dialogs();$j("body").on("change","#bookacti-template-picker",function(){bookacti_switch_template($j(this).val())});if($j("#bookacti-template-calendar").length){bookacti_load_template_calendar($j("#bookacti-template-calendar"))}if(bookacti.selected_template){bookacti_switch_template(bookacti.selected_template)}$j("body").on("dragstart","#bookacti-template-activities-container .fc-event",function(a,b){b.helper.css("maxWidth",$j(this).width())});window.onerror=function(e,b,a,d,c){$j("#bookacti-fatal-error").show()};$j("body").on("click","#bookacti-exit-loading",function(){bookacti_exit_template_loading_state(true);bookacti.load_events=true})}});function bookacti_load_template_calendar(f){f=f||$j("#bookacti-template-calendar");var c=bookacti_get_availability_period(f,true);var d=typeof bookacti.booking_system["bookacti-template-calendar"]["template_data"]["settings"]!=="undefined"?bookacti.booking_system["bookacti-template-calendar"]["template_data"]["settings"]:{};var a=typeof d.minTime!=="undefined"?d.minTime:"00:00";var b=typeof d.maxTime!=="undefined"?(d.maxTime==="00:00"?"24:00":d.maxTime):"24:00";var g=typeof d.snapDuration!=="undefined"?d.snapDuration:"00:05";var e={locale:bookacti_localized.fullcalendar_locale,defaultView:"agendaWeek",minTime:a,maxTime:b,slotLabelFormat:"LT",slotDuration:"00:30",snapDuration:g,scrollTime:"00:00",aspectRatio:"auto",validRange:{start:c.start?moment(c.start):moment($j("#bookacti-template-picker :selected").data("template-start")),end:c.end?moment(c.end).add(1,"days"):moment($j("#bookacti-template-picker :selected").data("template-end")).add(1,"days")},nowIndicator:0,weekNumbers:0,weekNumbersWithinDays:1,navLinks:0,slotEventOverlap:0,eventLimit:false,eventLimitClick:"popover",showNonCurrentDates:0,allDaySlot:false,allDayDefault:false,fixedWeekCount:false,showNonCurrentDates:false,editable:true,droppable:true,dropAccept:".fc-event",eventDurationEditable:false,dragRevertDuration:0,header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:function(k,h,i,j){j([])},viewRender:function(h){if(bookacti.load_events===true){var i={start:moment.utc(h.intervalStart),end:moment.utc(h.intervalEnd).subtract(1,"days")};bookacti_fetch_events_from_interval($j("#bookacti-template-calendar"),i)}},eventRender:function(x,k,v){if(bookacti.is_dragging||bookacti.is_resizing){return true}var q=bookacti.booking_system["bookacti-template-calendar"]["events_data"][x.id];k.data("event-id",x.id);k.attr("data-event-id",x.id);k.data("event-start",x.start.format("YYYY-MM-DD HH:mm:ss"));k.attr("data-event-start",x.start.format("YYYY-MM-DD HH:mm:ss"));k.data("event-end",x.end.format("YYYY-MM-DD HH:mm:ss"));k.attr("data-event-end",x.end.format("YYYY-MM-DD HH:mm:ss"));x.render=1;if(typeof q!=="undefined"&&q.activity_id){var t=q.activity_id;k.data("activity-id",t);k.attr("data-activity-id",t)}var A=k.find(".fc-title");A.html(A.text());var m="LT";if(v.name.indexOf("agenda")>-1){m=f.fullCalendar("option","noMeridiemTimeFormat")}k.find(".fc-time").html('<span class="bookacti-event-time-start">'+x.start.format(m)+'</span><span class="bookacti-event-time-separator"> - </span><span class="bookacti-event-time-end">'+x.end.format(m)+"</span>");if(typeof q!=="undefined"&&q.availability){var u=parseInt(q.availability);x.bookings=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),x);if(x.bookings!=null){var r="",h="",j="";if(u===0){r="bookacti-no-availability"}else{if(x.bookings>0){h="bookacti-booked"}else{h="bookacti-not-booked"}if(x.bookings>=u){j="bookacti-full"}}var i='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+r+" "+h+" "+j+'" ><span class="bookacti-bookings" >'+x.bookings+'</span><span class="bookacti-total-availability" >/'+u+"</span></span></div>";k.append(i)}}var s=k.find(".bookacti-event-actions").length>0?k.find(".bookacti-event-actions"):$j("<div />",{"class":"bookacti-event-actions"});var y=[];if(!s.find(".bookacti-event-action-edit").length){var l=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-edit","data-hide-on-mouseout":"1"});var p=$j("<span />",{type:"checkbox","class":"dashicons dashicons-admin-generic bookacti-event-action-edit-button","aria-hidden":"true"});y.push(l.prepend(p))}if(!s.find(".bookacti-event-action-select").length){var w=false;$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(C,B){if(B.id==x.id&&B.start.substr(0,10)===x.start.format("YYYY-MM-DD")){w=true;return false}});var z=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-select","data-hide-on-mouseout":"0"});var o=$j("<input />",{type:"checkbox","class":"bookacti-event-action-select-checkbox",value:"0",checked:w});y.push(z.append(o))}$j.each(y,function(C,B){s.append(B)});f.trigger("bookacti_event_actions",[s,x,k,v]);k.append(s);if(v.name==="month"||v.name==="basicWeek"||v.name==="basicDay"){var n=$j("<div />",{"class":"fc-bg"});k.append(n)}if(typeof q!=="undefined"&&q.repeat_freq){if(q.repeat_freq!=="none"){if(bookacti.booking_system["bookacti-template-calendar"]["exceptions"]!==undefined&&bookacti.booking_system["bookacti-template-calendar"]["exceptions"][x.id]!==undefined){$j.each(bookacti.booking_system["bookacti-template-calendar"]["exceptions"][x.id],function(B,C){if(C.exception_type==="date"&&C.exception_value===x.start.format("YYYY-MM-DD")){x.render=0}})}}}if(bookacti.hidden_activities!=null&&t!=null){$j.each(bookacti.hidden_activities,function(C,B){if(parseInt(t)===B){k.addClass("event-exception");x.render=0}})}f.trigger("bookacti_event_render",[x,k,v]);if(!x.render){return false}},eventAfterRender:function(j,i,h){bookacti_add_class_according_to_event_size(i)},eventAfterAllRender:function(h){if(bookacti.blocked_events===true){$j(".fc-event").addClass("bookacti-event-unavailable")}else{if($j.isNumeric(bookacti.blocked_events)){$j('.fc-event[data-event-id="'+bookacti.blocked_events+'"]').addClass("bookacti-event-unavailable")}else{$j(".fc-event").removeClass("bookacti-event-unavailable")}}$j(".fc-event.event-exception").remove();$j('.bookacti-event-action[data-hide-on-mouseout="1"]').hide();$j.each(bookacti.booking_system["bookacti-template-calendar"]["picked_events"],function(j,k){f.find('.fc-event[data-event-id="'+k.id+'"][data-event-start="'+k.start+'"]').addClass("bookacti-picked-event")});bookacti_refresh_selected_events_display()},eventReceive:function(k){var j=parseInt(k.activity_id);var m=bookacti.booking_system["bookacti-template-calendar"]["activities_data"][j];var i=f.fullCalendar("getView");if(!m){return false}if(i.name.substr(0,6)!=="agenda"){var h=f.fullCalendar("option","minTime");k.start.set({hours:h.substr(0,2),minutes:h.substr(3,2),seconds:0})}k.end=k.start.clone();k.end.add(moment.duration(m.duration));if(parseInt(m.is_resizable)===1){k.durationEditable=true}var l={action:"bookactiInsertEvent",activity_id:j,template_id:bookacti.selected_template,event_title:m.multilingual_title,event_start:k.start.format("YYYY-MM-DD HH:mm:ss"),event_end:k.end.format("YYYY-MM-DD HH:mm:ss"),event_availability:m.availability,nonce:bookacti_localized.nonce_insert_event};f.trigger("bookacti_insert_event_before",[k,l]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:l,type:"POST",dataType:"json",success:function(n){if(n.status==="success"){k.id=n.event_id;k.bookings=0;bookacti.booking_system["bookacti-template-calendar"]["events_data"][k.id]=n.event_data;f.fullCalendar("updateEvent",k);f.trigger("bookacti_event_inserted",[k,n,l])}else{if(k._id!==undefined){if(k._id.indexOf("_")>=0){f.fullCalendar("removeEvents",k._id)}}f.fullCalendar("removeEvents",k.id);f.fullCalendar("refetchEvents");var o=bookacti_localized.error_insert_event;if(n.error==="not_allowed"){o+="\n"+bookacti_localized.error_not_allowed}alert(o);console.log(n)}},error:function(n){alert("AJAX "+bookacti_localized.error_insert_event);console.log(n)},complete:function(){bookacti_stop_template_loading()}})},eventResize:function(i,q,o){var h={id:i.id,start:i.start.clone(),end:i.end.clone().subtract(q._data),};var r=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),h);if(r>0){o();var l=bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none";if(l){bookacti_dialog_unbind_occurences(i,["resize"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}var j=i.id;var k=i.start.format("YYYY-MM-DD HH:mm:ss");var m=i.end.format("YYYY-MM-DD HH:mm:ss");var p=q._days;var n={action:"bookactiResizeEvent",delta_days:p,event_id:j,event_start:k,event_end:m,nonce:bookacti_localized.nonce_move_or_resize_event};f.trigger("bookacti_resize_event_before",[i,n,q]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:n,type:"POST",dataType:"json",success:function(s){if(s.status==="success"){var t=i.end.format("HH:mm:ss");$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(x,w){if(w.id==i.id){var v=moment(w.end).add(p,"days").format("YYYY-MM-DD")+" "+t;w.end=v}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(v,w){$j.each(w,function(y,z){if(z.id==i.id){var x=moment(z.end).add(p,"days").format("YYYY-MM-DD")+" "+t;z.end=x}})});f.trigger("bookacti_event_resized",[i,s,n])}else{if(s.status==="failed"){o();if(s.error==="has_bookings"){if(!i.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurences(i,["resize"])}}var u=bookacti_localized.error_resize_event;if(s.error==="not_allowed"){u+="\n"+bookacti_localized.error_not_allowed}else{if(s.error==="has_bookings"){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id);u+="\n"+bookacti_localized.error_edit_locked_event;u+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(u);console.log(s)}}},error:function(s){o();alert("AJAX "+bookacti_localized.error_resize_event);console.log(s)},complete:function(){bookacti_stop_template_loading()}})},eventDrop:function(i,t,r,q){var j=0;if(q.altKey){j=1}if(j){r()}else{var h={id:i.id,start:i.start.clone().subtract(t._data),end:i.end.clone().subtract(t._data),};var u=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),h);if(u>0){r();var n=bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none";if(n){bookacti_dialog_unbind_occurences(i,["move"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}}var l=i.id;var k=i.start.format("YYYY-MM-DD HH:mm:ss");var o=(i.end===null)?k:i.end.format("YYYY-MM-DD HH:mm:ss");var s=t._days;var m=bookacti.booking_system["bookacti-template-calendar"]["events_interval"];var p={action:"bookactiMoveEvent",delta_days:s,event_id:l,event_start:k,event_end:o,interval:m,is_duplicated:j,nonce:bookacti_localized.nonce_move_or_resize_event};f.trigger("bookacti_move_event_before",[i,p,t]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:p,type:"POST",dataType:"json",success:function(v){if(v.status==="success"){if(j){var w=v.event_id;if(typeof v.exceptions[w]!=="undefined"){bookacti.booking_system["bookacti-template-calendar"]["exceptions"][w]=v.exceptions[w]}if(!$j.isEmptyObject(v.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][w]=v.event_data}$j("#bookacti-template-calendar").fullCalendar("addEventSource",v.events);f.trigger("bookacti_event_duplicated",[i,v,p]);return false}var z=i.start.format("HH:mm:ss");var x=i.end.format("HH:mm:ss");if(!$j.isEmptyObject(v.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][l]=v.event_data}$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(C,B){if(B.id==i.id){var D=moment(B.start).add(s,"days").format("YYYY-MM-DD")+" "+z;var A=moment(B.end).add(s,"days").format("YYYY-MM-DD")+" "+x;B.start=D;B.end=A}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(A,B){$j.each(B,function(D,F){if(F.id==i.id){var E=moment(F.start).add(s,"days").format("YYYY-MM-DD")+" "+z;var C=moment(F.end).add(s,"days").format("YYYY-MM-DD")+" "+x;F.start=E;F.end=C}})});if(v.events.length>0){$j("#bookacti-template-calendar").fullCalendar("removeEvents",l);$j("#bookacti-template-calendar").fullCalendar("addEventSource",v.events)}f.trigger("bookacti_event_moved",[i,v,p])}else{if(v.status==="failed"){r();if(v.error==="has_bookings"){if(!i.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurences(i,["move"])}}var y=bookacti_localized.error_move_event;if(v.error==="not_allowed"){y+="\n"+bookacti_localized.error_not_allowed}else{if(v.error==="has_bookings"){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id);y+="\n"+bookacti_localized.error_edit_locked_event;y+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(y);console.log(v)}}},error:function(v){r();alert("AJAX "+bookacti_localized.error_move_event);console.log(v)},complete:function(){bookacti_stop_template_loading()}})},eventDragStart:function(j,i,k,h){bookacti.is_dragging=true},eventDragStop:function(j,i,k,h){bookacti.is_dragging=false},eventResizeStart:function(j,i,k,h){bookacti.is_resizing=true},eventResizeStop:function(j,i,k,h){bookacti.is_resizing=false},eventClick:function(k,i,h){var j=$j(this);var l=$j('.fc-event[data-event-id="'+k.id+'"][data-event-start="'+k.start.format("YYYY-MM-DD HH:mm:ss")+'"]');if(bookacti.is_touch_device){if(!j.find(".bookacti-event-action").is(":visible")){$j(".bookacti-event-over").removeClass("bookacti-event-over");bookacti_show_event_actions(j)}else{bookacti_hide_event_actions(j,k)}}$j(".fc-event").removeClass("bookacti-picked-event");l.addClass("bookacti-picked-event");bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"].push({id:k.id,start:k.start.format("YYYY-MM-DD HH:mm:ss"),end:k.end.format("YYYY-MM-DD HH:mm:ss")});if($j(i.target).parents(".bookacti-event-actions").length){if($j(i.target).is(".bookacti-event-action-edit")||$j(i.target).parents(".bookacti-event-action-edit").length){if(k.editable!==false){bookacti_dialog_update_event(k)}}else{if($j(i.target).is(".bookacti-event-action-select")||$j(i.target).parents(".bookacti-event-action-select").length){if(j.find(".bookacti-event-action-select-checkbox").is(":checked")){bookacti_select_event(k)}else{bookacti_unselect_event(k);j.find(".bookacti-event-action-select").show()}}}}f.trigger("bookacti_pick_event",[k,i,h])},eventMouseover:function(k,i,h){var j=$j(this);bookacti_show_event_actions(j)},eventMouseout:function(k,i,h){var j=$j(this);bookacti_hide_event_actions(j,k)},loading:function(h){if(!h&&bookacti.is_touch_device){$j(".fc-event").each(function(){var i=$j.Event("mouseover",{target:this.firstChild,_dummyCalledOnStartup:true});$j(this).trigger(i)})}}};f.trigger("bookacti_calendar_editor_init_data",[e]);f.fullCalendar(e)};