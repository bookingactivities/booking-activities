$j(document).ready(function(){if(!$j("#bookacti-template-container").length){return}bookacti.selected_template=parseInt($j("#bookacti-template-picker").val())||0;bookacti.hidden_activities=[];bookacti.selected_category="new";bookacti.is_dragging=false;bookacti.is_resizing=false;bookacti.is_hovering=false;bookacti.blocked_events=false;bookacti.load_events=false;var b,a="";if($j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').length){b=$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-start");a=$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-end")}bookacti.booking_system["bookacti-template-calendar"]={};bookacti.booking_system["bookacti-template-calendar"]["calendars"]=bookacti.selected_template?[bookacti.selected_template]:[];bookacti.booking_system["bookacti-template-calendar"]["bookings"]=[];bookacti.booking_system["bookacti-template-calendar"]["exceptions"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["activities_data"]={};bookacti.booking_system["bookacti-template-calendar"]["events_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["events_interval"]=[];bookacti.booking_system["bookacti-template-calendar"]["group_categories_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["start"]=b?b+" 00:00:00":"";bookacti.booking_system["bookacti-template-calendar"]["end"]=a?a+" 23:59:59":"";bookacti.booking_system["bookacti-template-calendar"]["display_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]={start:b,end:a};bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=0;bookacti.booking_system["bookacti-template-calendar"]["method"]="calendar";bookacti.booking_system["bookacti-template-calendar"]["past_events"]=true;bookacti.booking_system["bookacti-template-calendar"]["past_events_bookable"]=true;bookacti_init_activities();bookacti_init_groups_of_events();bookacti_init_show_hide_activities_switch();bookacti_init_event_duplication_feedbacks();bookacti_init_template_dialogs();bookacti_bind_template_dialogs();$j("body").on("change","#bookacti-template-picker",function(){bookacti_switch_template($j(this).val())});if($j("#bookacti-template-calendar").length){bookacti_load_template_calendar($j("#bookacti-template-calendar"))}if(bookacti.selected_template){bookacti_switch_template(bookacti.selected_template)}$j("body").on("dragstart","#bookacti-template-activities-container .fc-event",function(d,c){c.helper.css("maxWidth",$j(this).width())});window.onerror=function(g,d,c,f,e){$j("#bookacti-fatal-error").show()};$j("body").on("click","#bookacti-exit-loading",function(){bookacti_exit_template_loading_state(true);bookacti.load_events=true})});function bookacti_load_template_calendar(f){f=f||$j("#bookacti-template-calendar");var c=bookacti_get_availability_period(f);var d=typeof bookacti.booking_system["bookacti-template-calendar"]["display_data"]!=="undefined"?bookacti.booking_system["bookacti-template-calendar"]["display_data"]:{};var a=typeof d.minTime!=="undefined"?d.minTime:"00:00";var b=typeof d.maxTime!=="undefined"?(d.maxTime==="00:00"?"24:00":d.maxTime):"24:00";var g=typeof d.snapDuration!=="undefined"?d.snapDuration:"00:05";var e={locale:bookacti_localized.fullcalendar_locale,defaultView:"agendaWeek",minTime:a,maxTime:b,slotLabelFormat:"LT",slotDuration:"00:30",snapDuration:g,scrollTime:"00:00",aspectRatio:"auto",validRange:{start:c.start?moment.utc(c.start.substr(0,10)):moment.utc($j("#bookacti-template-picker :selected").data("template-start")),end:c.end?moment.utc(c.end.substr(0,10)).add(1,"days"):moment.utc($j("#bookacti-template-picker :selected").data("template-end")).add(1,"days")},nowIndicator:false,weekNumbers:false,weekNumbersWithinDays:true,navLinks:true,slotEventOverlap:false,eventLimit:false,eventLimitClick:"popover",allDaySlot:false,allDayDefault:false,fixedWeekCount:false,showNonCurrentDates:false,editable:true,droppable:true,dropAccept:".fc-event",eventDurationEditable:false,dragRevertDuration:0,header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:function(k,h,i,j){j([])},viewRender:function(h,k){if(bookacti.load_events===true){var i={start:moment.utc(moment.utc(h.intervalStart).clone().locale("en").format("YYYY-MM-DD")+" 00:00:00").locale("en"),end:moment.utc(moment.utc(h.intervalEnd).clone().locale("en").subtract(1,"days").format("YYYY-MM-DD")+" 23:59:59").locale("en")};bookacti_fetch_events_from_interval($j("#bookacti-template-calendar"),i)}if(h.name.indexOf("agenda")>-1){var j=typeof d.slotEventOverlap!=="undefined"?d.slotEventOverlap:f.fullCalendar("option","slotEventOverlap");if(j){k.addClass("bookacti-events-overlap")}}f.trigger("bookacti_view_render",[h,k])},eventRender:function(A,k,y){if(!A.start||!A.end||A.start===A.end){return false}if(bookacti.is_dragging||bookacti.is_resizing){return true}var r=bookacti.booking_system["bookacti-template-calendar"]["events_data"][A.id];var w=0;var n=moment.utc(A.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var t=moment.utc(A.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");k.data("event-id",A.id);k.attr("data-event-id",A.id);k.data("event-start",n);k.attr("data-event-start",n);k.data("event-end",t);k.attr("data-event-end",t);A.render=1;if(typeof r!=="undefined"&&r.activity_id){w=r.activity_id;k.data("activity-id",w);k.attr("data-activity-id",w)}var D=k.find(".fc-title");D.html(D.text());var m="LT";if(y.name.indexOf("agenda")>-1){m=f.fullCalendar("option","noMeridiemTimeFormat")}if(bookacti_localized.calendar_localization==="wp_settings"){m=bookacti_convert_php_datetime_format_to_moment_js(bookacti_localized.wp_time_format)}k.find(".fc-time").html('<span class="bookacti-event-time-start">'+A.start.format(m)+'</span><span class="bookacti-event-time-separator"> - </span><span class="bookacti-event-time-end">'+A.end.format(m)+"</span>");if(typeof r!=="undefined"&&r.availability){var x=parseInt(r.availability);A.bookings=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),A);if(A.bookings!=null){var s="",h="",j="";if(x===0){s="bookacti-no-availability"}else{if(A.bookings>0){h="bookacti-booked"}else{h="bookacti-not-booked"}if(A.bookings>=x){j="bookacti-full"}}var i='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+s+" "+h+" "+j+'" ><span class="bookacti-bookings" >'+A.bookings+'</span><span class="bookacti-total-availability" >/'+x+"</span></span></div>";k.append(i)}}var u=k.find(".bookacti-event-actions").length>0?k.find(".bookacti-event-actions"):$j("<div></div>",{"class":"bookacti-event-actions"});var B=[];if(!u.find(".bookacti-event-action-edit").length){var l=$j("<div></div>",{"class":"bookacti-event-action bookacti-event-action-edit","data-hide-on-mouseout":"1"});var q=$j("<span></span>",{type:"checkbox","class":"dashicons dashicons-admin-generic bookacti-event-action-edit-button","aria-hidden":"true"});B.push(l.prepend(q))}if(!u.find(".bookacti-event-action-select").length){var v=moment.utc(A.start).clone().locale("en").format("YYYY-MM-DD");var z=false;$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(F,E){if(E.id==A.id&&E.start.substr(0,10)===v){z=true;return false}});var C=$j("<div></div>",{"class":"bookacti-event-action bookacti-event-action-select","data-hide-on-mouseout":"0"});var p=$j("<input />",{type:"checkbox","class":"bookacti-event-action-select-checkbox",value:"0",checked:z});B.push(C.append(p))}$j.each(B,function(F,E){u.append(E)});f.trigger("bookacti_event_actions",[u,A,k,y]);k.append(u);if(y.name==="month"||y.name==="basicWeek"||y.name==="basicDay"){var o=$j("<div></div>",{"class":"fc-bg"});k.append(o)}if(typeof r!=="undefined"&&r.repeat_freq){if(r.repeat_freq!=="none"){if(bookacti.booking_system["bookacti-template-calendar"]["exceptions"]!==undefined&&bookacti.booking_system["bookacti-template-calendar"]["exceptions"][A.id]!==undefined){$j.each(bookacti.booking_system["bookacti-template-calendar"]["exceptions"][A.id],function(E,F){if(F.exception_type==="date"&&F.exception_value===v){A.render=0}})}}}if(bookacti.hidden_activities&&w){if($j.inArray(parseInt(w),bookacti.hidden_activities)>=0){A.render=0}}f.trigger("bookacti_event_render",[A,k,y]);if(!A.render){return false}},eventAfterRender:function(j,i,h){bookacti_add_class_according_to_event_size(i)},eventAfterAllRender:function(h){if(bookacti.blocked_events===true){$j(".fc-event").addClass("bookacti-event-unavailable")}else{if($j.isNumeric(bookacti.blocked_events)){$j('.fc-event[data-event-id="'+bookacti.blocked_events+'"]').addClass("bookacti-event-unavailable")}else{$j(".fc-event").removeClass("bookacti-event-unavailable")}}$j(".fc-event.event-exception").remove();$j('.bookacti-event-action[data-hide-on-mouseout="1"]').hide();$j.each(bookacti.booking_system["bookacti-template-calendar"]["picked_events"],function(j,k){f.find('.fc-event[data-event-id="'+k.id+'"][data-event-start="'+k.start+'"]').addClass("bookacti-picked-event")});bookacti_refresh_selected_events_display()},eventReceive:function(h){var p=parseInt(h.activity_id);var n=bookacti.booking_system["bookacti-template-calendar"]["activities_data"][p];var m=f.fullCalendar("getView");if(!n){return false}if(m.name.substr(0,6)!=="agenda"){var i=f.fullCalendar("option","minTime");h.start.set({hours:i.substr(0,2),minutes:i.substr(3,2),seconds:0})}var k=n.duration?n.duration:"000.01:00:00";h.end=h.start.clone();h.end.add(moment.duration(k));if(parseInt(n.is_resizable)===1){h.durationEditable=true}var l=moment.utc(h.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var o=moment.utc(h.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var j={action:"bookactiInsertEvent",activity_id:p,template_id:bookacti.selected_template,title:n.multilingual_title,start:l,end:o,availability:n.availability,nonce:$j("#nonce_edit_template").val()};f.trigger("bookacti_insert_event_before",[h,j]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:j,type:"POST",dataType:"json",success:function(q){if(q.status==="success"){h.id=q.event_id;h.bookings=0;bookacti.booking_system["bookacti-template-calendar"]["events_data"][h.id]=q.event_data;f.fullCalendar("updateEvent",h);f.trigger("bookacti_event_inserted",[h,q,j])}else{if(h._id!==undefined){if(h._id.indexOf("_")>=0){f.fullCalendar("removeEvents",h._id)}}f.fullCalendar("removeEvents",h.id);f.fullCalendar("refetchEvents");var r=typeof q.message!=="undefined"?q.message:bookacti_localized.error;alert(r);console.log(r);console.log(q)}},error:function(q){alert("AJAX "+bookacti_localized.error);console.log(q)},complete:function(){bookacti_stop_template_loading()}})},eventResize:function(i,q,o){var h={id:i.id,start:i.start.clone(),end:i.end.clone().subtract(q._data)};var r=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),h);if(r>0){o();var l=bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none";if(l){bookacti_dialog_unbind_occurrences(i,["resize"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}var j=i.id;var k=moment.utc(i.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var m=moment.utc(i.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var p=q._days;var n={action:"bookactiResizeEvent",delta_days:p,event_id:j,event_start:k,event_end:m,nonce:$j("#nonce_edit_template").val()};f.trigger("bookacti_resize_event_before",[i,n,q]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:n,type:"POST",dataType:"json",success:function(s){if(s.status==="success"){var t=moment.utc(i.end).clone().locale("en").format("HH:mm:ss");$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(x,w){if(w.id==i.id){var v=moment.utc(w.end).clone().locale("en").add(p,"days").format("YYYY-MM-DD")+" "+t;w.end=v}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(v,w){$j.each(w,function(y,z){if(z.id==i.id){var x=moment.utc(z.end).clone().locale("en").add(p,"days").format("YYYY-MM-DD")+" "+t;z.end=x}})});f.trigger("bookacti_event_resized",[i,s,n])}else{if(s.status==="failed"){o();if(s.error==="has_bookings"){if(!i.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurrences(i,["resize"])}}var u=typeof s.message!=="undefined"?s.message:bookacti_localized.error;alert(u);console.log(u);console.log(s)}}},error:function(s){o();alert("AJAX "+bookacti_localized.error);console.log(s)},complete:function(){bookacti_stop_template_loading()}})},eventDrop:function(i,t,r,q){var j=0;if(q.altKey){j=1}if(j){r()}else{var h={id:i.id,start:i.start.clone().subtract(t._data),end:i.end.clone().subtract(t._data)};var u=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),h);if(u>0){r();var n=bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none";if(n){bookacti_dialog_unbind_occurrences(i,["move"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}}var l=i.id;var k=moment.utc(i.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var o=!i.end?k:moment.utc(i.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var s=t._days;var m=bookacti.booking_system["bookacti-template-calendar"]["events_interval"];var p={action:"bookactiMoveEvent",delta_days:s,event_id:l,event_start:k,event_end:o,interval:m,is_duplicated:j,nonce:$j("#nonce_edit_template").val()};f.trigger("bookacti_move_event_before",[i,p,t]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:p,type:"POST",dataType:"json",success:function(v){if(v.status==="success"){if(j){var w=v.event_id;if(typeof v.exceptions[w]!=="undefined"){bookacti.booking_system["bookacti-template-calendar"]["exceptions"][w]=v.exceptions[w]}if(!$j.isEmptyObject(v.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][w]=v.event_data}$j("#bookacti-template-calendar").fullCalendar("addEventSource",v.events);f.trigger("bookacti_event_duplicated",[i,v,p]);return false}var z=moment.utc(i.start).clone().locale("en").format("HH:mm:ss");var x=moment.utc(i.end).clone().locale("en").format("HH:mm:ss");if(!$j.isEmptyObject(v.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][l]=v.event_data}$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(C,B){if(B.id==i.id){var D=moment.utc(B.start).clone().locale("en").add(s,"days").format("YYYY-MM-DD")+" "+z;var A=moment.utc(B.end).clone().locale("en").add(s,"days").format("YYYY-MM-DD")+" "+x;B.start=D;B.end=A}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(A,B){$j.each(B,function(D,F){if(F.id==i.id){var E=moment.utc(F.start).clone().locale("en").add(s,"days").format("YYYY-MM-DD")+" "+z;var C=moment.utc(F.end).clone().locale("en").add(s,"days").format("YYYY-MM-DD")+" "+x;F.start=E;F.end=C}})});if(v.events.length>0){$j("#bookacti-template-calendar").fullCalendar("removeEvents",l);$j("#bookacti-template-calendar").fullCalendar("addEventSource",v.events)}f.trigger("bookacti_event_moved",[i,v,p])}else{if(v.status==="failed"){r();if(v.error==="has_bookings"){if(!i.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurrences(i,["move"])}}var y=typeof v.message!=="undefined"?v.message:bookacti_localized.error;alert(y);console.log(y);console.log(v)}}},error:function(v){r();alert("AJAX "+bookacti_localized.error);console.log(v)},complete:function(){bookacti_stop_template_loading()}})},eventDragStart:function(j,i,l,h){bookacti.is_dragging=true;var k=$j('.fc-event[data-event-id="'+j.id+'"]');k.addClass("bookacti-event-dragged")},eventDragStop:function(j,i,l,h){bookacti.is_dragging=false;var k=$j('.fc-event[data-event-id="'+j.id+'"]');k.removeClass("bookacti-event-dragged")},eventResizeStart:function(j,i,k,h){bookacti.is_resizing=true},eventResizeStop:function(j,i,k,h){bookacti.is_resizing=false},eventClick:function(l,j,i){var k=$j(this);var h=moment.utc(l.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var n=moment.utc(l.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var m=$j('.fc-event[data-event-id="'+l.id+'"][data-event-start="'+h+'"]');if(bookacti.is_touch_device){if(!k.find(".bookacti-event-action").is(":visible")){$j(".bookacti-event-over").removeClass("bookacti-event-over");bookacti_show_event_actions(k)}else{bookacti_hide_event_actions(k,l)}}$j(".fc-event").removeClass("bookacti-picked-event");m.addClass("bookacti-picked-event");bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"].push({id:l.id,start:h,end:n});if($j(j.target).parents(".bookacti-event-actions").length){if($j(j.target).is(".bookacti-event-action-edit")||$j(j.target).parents(".bookacti-event-action-edit").length){if(l.editable!==false){bookacti_dialog_update_event(l)}}else{if($j(j.target).is(".bookacti-event-action-select")||$j(j.target).parents(".bookacti-event-action-select").length){if(k.find(".bookacti-event-action-select-checkbox").is(":checked")){bookacti_select_event(l)}else{bookacti_unselect_event(l);k.find(".bookacti-event-action-select").show()}}}}f.trigger("bookacti_pick_event",[l,j,i])},eventMouseover:function(k,i,h){var j=$j(this);bookacti_show_event_actions(j);bookacti.is_hovering=true},eventMouseout:function(k,i,h){var j=$j(this);bookacti_hide_event_actions(j,k);bookacti.is_hovering=false},loading:function(h){if(!h&&bookacti.is_touch_device){$j(".fc-event").each(function(){var i=$j.Event("mouseover",{target:this.firstChild,_dummyCalledOnStartup:true});$j(this).trigger(i)})}}};if(bookacti_localized.calendar_localization==="wp_settings"){e.firstDay=bookacti_localized.wp_start_of_week;e.slotLabelFormat=bookacti_convert_php_datetime_format_to_moment_js(bookacti_localized.wp_time_format);e.timeFormat=bookacti_convert_php_datetime_format_to_moment_js(bookacti_localized.wp_time_format)}f.trigger("bookacti_calendar_editor_init_data",[e]);f.fullCalendar(e)};