$j(document).ready(function(){bookacti_init_form_dialogs();bookacti_init_tooltip();$j("body").on("keyup mouseup change",".bookacti-booking-form input[name=password], .bookacti-form-fields input[name=password]",function(){var d=$j(this);var b=null;var e=$j(this).closest(".bookacti-form-field-container").find(".bookacti-password-strength-meter");var f=[];var a=d.closest(".bookacti-booking-form, .bookacti-form-fields").find('input[name="login_type"]:checked').val();if(e.length&&a==="new_account"){var c=bookacti_check_password_strength(d,b,e,f);$j(this).closest(".bookacti-form-field-container").find("input[name=password_strength]").val(c)}else{d.removeClass("short bad good strong")}});$j("body").on("click",".bookacti-forgotten-password-link",function(b){b.preventDefault();var a=$j(this).data("field-id");bookacti_dialog_forgotten_password(a)});$j(".bookacti-form-field-container.bookacti-form-field-type-login").each(function(){bookacti_show_hide_register_fields($j(this))});$j("body").on("change",'.bookacti-form-field-container.bookacti-form-field-type-login input[name="login_type"]',function(){var a=$j(this).closest(".bookacti-form-field-container.bookacti-form-field-type-login");bookacti_show_hide_register_fields(a)});$j("body").on("click",".bookacti-form-field-login-field-container .bookacti-login-button",function(a){a.preventDefault();if(typeof bookacti_localized.current_user_id!=="undefined"){if(bookacti_localized.current_user_id){return}}bookacti_submit_login_form($j(this))});$j("body").on("submit",".bookacti-booking-form",function(i){i.preventDefault();var c=$j(this);var a=c.find(".bookacti-form-field-type-calendar .bookacti-booking-system");var l=a.attr("id");if(typeof bookacti.booking_system[l]==="undefined"){return}var f=bookacti.booking_system[l];var h=typeof f.form_action!=="undefined";if(h){if(f.form_action){h=f.form_action}}var g=typeof f.when_perform_form_action!=="undefined";if(g){if(f.when_perform_form_action){g=f.when_perform_form_action}}if(!h||h==="default"||!g||g!=="on_submit"){bookacti_submit_booking_form(c);return}if(h==="redirect_to_url"){var k=a.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_group_id"]').val();var m=a.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_id"]').val();var d=a.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_start"]').val();var j=a.siblings(".bookacti-booking-system-inputs").find('input[name="bookacti_event_end"]').val();if(k==="single"&&m&&d&&j){var b={id:m,start:d,end:j};bookacti_redirect_to_activity_url(a,b)}else{if($j.isNumeric(k)){bookacti_redirect_to_group_category_url(a,k)}}}$j(this).trigger("bookacti_submit_booking_form")});$j("body").on("click",".bookacti-booking-form .bookacti-new-booking-button",function(){if($j(this).hasClass("bookacti-reload-page")){window.location.reload(true);$j(this).prop("disabled",true);return}var c=$j(this).closest("form");var a=c.find(".bookacti-booking-system");bookacti_clear_booking_system_displayed_info(a);var b=c.find("> .bookacti-notices").length?c.find("> .bookacti-notices"):a.siblings(".bookacti-notices");b.empty();c.find('.bookacti-form-field-container:not(.bookacti-hidden-field), input[type="submit"]').show();$j(this).hide();c.trigger("bookacti_make_new_booking")});$j("body").on("keyup mouseup change",".bookacti-booking-form input.bookacti-quantity, .bookacti-form-fields input.bookacti-quantity",function(){var a=$j(this).closest(".bookacti-booking-form, .bookacti-form-fields").find(".bookacti-booking-system");if(a.length){bookacti_fill_picked_events_list(a)}});$j("body").on("bookacti_picked_events_list_data",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(f,b,d){var a=$j(this);var c=a.closest(".bookacti-booking-form, .bookacti-form-fields").find("input.bookacti-quantity");if(c.length){bookacti_set_min_and_max_quantity(a,c,b)}});$j("body").on("bookacti_view_refreshed bookacti_displayed_info_cleared",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(){var a=$j(this).closest(".bookacti-booking-form, .bookacti-form-fields");a.find('input[name="quantity"]').attr("disabled",false);a.find('button[type="submit"]').attr("disabled",false)});$j("body").on("bookacti_error_displayed",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(){var a=$j(this).closest(".bookacti-booking-form, .bookacti-form-fields");a.find('input[name="quantity"]').attr("disabled",true);a.find('button[type="submit"]').attr("disabled",true)})});function bookacti_init_form_dialogs(){$j(".bookacti-form-dialog").dialog({modal:true,autoOpen:false,minHeight:300,minWidth:460,resize:"auto",show:true,hide:true,dialogClass:"bookacti-dialog",closeText:"&#10006;",beforeClose:function(){if(!bookacti_localized.is_admin){return}var b=".bookacti-form-dialog";var a=$j(this).attr("id");if(a){b="#"+a}bookacti_empty_all_dialog_forms(b)}});$j("body").on("click",".ui-widget-overlay",function(){$j("div:ui-dialog:visible").dialog("close")});$j(".bookacti-form-dialog").on("keydown",function(a){if(!$j("textarea").is(":focus")&&a.keyCode==$j.ui.keyCode.ENTER){$j(this).parent().find(".ui-dialog-buttonpane button:first").focus();return false}})}function bookacti_show_hide_register_fields(f){var b=f.find('input[name="login_type"]:checked').val();var h=f.find(".bookacti-password-strength");var e=f.find(".bookacti-forgotten-password");var d=f.find(".bookacti-login-field-password");var c=f.find(".bookacti-register-fields");var a=f.find(".bookacti-login-button");var g=f.find(".bookacti-login-field-submit-button");if(b==="new_account"){h.show();e.hide();if(d.hasClass("bookacti-generated-password")){d.hide();d.find('input[name="password"]').prop("required",false)}else{d.show();d.find('input[name="password"]').prop("required",true)}c.show();c.find(".bookacti-required-field").prop("required",true);a.val(a.data("register-label")).prop("disabled",false);g.show()}else{if(b==="my_account"){h.hide();e.show();if(d.hasClass("bookacti-password-not-required")){d.hide();d.find('input[name="password"]').prop("required",false)}else{d.show();d.find('input[name="password"]').prop("required",true)}c.hide();c.find(".bookacti-required-field").prop("required",false);a.val(a.data("login-label")).prop("disabled",false);g.show()}else{if(b==="no_account"){d.hide();d.find('input[name="password"]').prop("required",false);c.show();c.find(".bookacti-required-field").prop("required",true);a.prop("disabled",true);g.hide()}}}}function bookacti_check_password_strength(d,b,e,f){if(typeof window.zxcvbn==="undefined"||typeof wp.passwordStrength==="undefined"||typeof pwsL10n==="undefined"){return 4}var g=d.val();var a=b!=null?b.val():g;f=f.concat(wp.passwordStrength.userInputBlacklist());d.removeClass("short bad good strong");e.removeClass("short bad good strong");var c=wp.passwordStrength.meter(g,f,a);switch(c){case 2:d.addClass("bad");e.addClass("bad").html(pwsL10n.bad);break;case 3:d.addClass("good");e.addClass("good").html(pwsL10n.good);break;case 4:d.addClass("strong");e.addClass("strong").html(pwsL10n.strong);break;case 5:d.addClass("short");e.addClass("short").html(pwsL10n.mismatch);break;default:d.addClass("short");e.addClass("short").html(pwsL10n["short"])}return c}function bookacti_submit_login_form(a){if(!a.closest(".bookacti-form-field-container").length){return}if(!a.closest(".bookacti-form-field-container").find(".bookacti-email").length){return}var g=a.closest(".bookacti-form-field-container");if(!a.closest("form").length){if(g.closest(".bookacti-form-fields").length){g.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>')}else{g.wrap('<form class="bookacti-temporary-form"></form>')}}var d=a.closest("form");var b=d.find('input[name="action"]').length?d.find('input[name="action"]').val():"";if(!d.find("> .bookacti-notices").length){d.append('<div class="bookacti-notices"></div>')}var c=d.find("> .bookacti-notices");c.empty();if(d.find('input[name="login_type"][value="new_account"]').is(":checked")&&!d.find(".bookacti-generated-password").length&&parseInt(d.find(".bookacti-password_strength").val())<parseInt(d.find(".bookacti-password_strength").attr("min"))){c.append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show();bookacti_scroll_to(c,500,"middle");return}var e=new FormData(d.get(0));g.trigger("bookacti_before_submit_login_form",[e]);if(e instanceof FormData){e.set("action","bookactiSubmitLoginForm")}else{return}a.prop("disabled",true);var f='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";a.after(f);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:e,dataType:"json",cache:false,contentType:false,processData:false,success:function(k){if(k.message){var l=k.status==="success"?"bookacti-success-list":"bookacti-error-list";var m='<ul class="'+l+'"><li>'+k.message+"</li></ul>";c.append(m).show();bookacti_scroll_to(c,500,"middle")}if(k.status==="success"){var n={};if(typeof e.forEach==="function"){e.forEach(function(p,o){n[o]=p})}else{n=d.serializeObject()}d.trigger("bookacti_login_form_submitted",[k,n]);var j=d.serialize();var i=typeof d.attr("action")!=="undefined"&&b==="bookactiSubmitLoginForm"?d.attr("action"):"";var h=k.redirect_url?k.redirect_url:i;h+=h.indexOf("?")>=0?"&"+j:"?"+j;window.location.replace(h)}a.next(".bookacti-loading-alt").remove()},error:function(i){var h='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";c.empty().append(h).show();bookacti_scroll_to(c,500,"middle");console.log("AJAX "+bookacti_localized.error);console.log(i);a.next(".bookacti-loading-alt").remove()},complete:function(){a.prop("disabled",false)}})}function bookacti_submit_booking_form(b){var a=b.find(".bookacti-booking-system");var f=b.find("> .bookacti-notices").length?b.find("> .bookacti-notices"):a.siblings(".bookacti-notices");var c=b.find('input[type="submit"]').length?b.find('input[type="submit"]'):null;if(c){c.prop("disabled",true)}var g=false;if(typeof bookacti_localized.current_user_id!=="undefined"){if(bookacti_localized.current_user_id){g=true}}var h=b.find(".bookacti-email").length?true:false;if(!g&&!h){f.empty().append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_user_not_logged_in+"</li></ul>").show();if(c){c.prop("disabled",false)}bookacti_scroll_to(f,500,"middle");return false}if(h){if(b.find('input[name="login_type"][value="new_account"]').is(":checked")&&!b.find(".bookacti-generated-password").length&&parseInt(b.find(".bookacti-password_strength").val())<parseInt(b.find(".bookacti-password_strength").attr("min"))){f.empty().append("<ul class='bookacti-error-list'><li>"+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show();if(c){c.prop("disabled",false)}bookacti_scroll_to(f,500,"middle");return false}}var i=bookacti_validate_picked_events(a,b.find(".bookacti-quantity").val());if(!i){bookacti_scroll_to(a.siblings(".bookacti-notices"),500,"middle");if(c){c.prop("disabled",false)}return false}var e=new FormData(b.get(0));b.trigger("bookacti_before_submit_booking_form",[e]);if(e instanceof FormData){e.set("action","bookactiSubmitBookingForm")}else{return}if(c){var d='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";c.after(d)}bookacti_start_loading_booking_system(a);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:e,dataType:"json",cache:false,contentType:false,processData:false,success:function(k){var j=typeof k.redirect_url!=="undefined"?k.redirect_url:"";var l="";if(k.status!=="success"){l="<ul class='bookacti-error-list'><li>"+k.message+"</li></ul>"}else{b.find('.bookacti-form-field-container:not(.bookacti-form-field-name-submit):not(.bookacti-form-field-name-calendar), input[type="submit"]').hide();if(k.has_logged_in){b.find(".bookacti-new-booking-button").addClass("bookacti-reload-page")}else{b.find(".bookacti-new-booking-button").removeClass("bookacti-reload-page")}b.find(".bookacti-new-booking-button").show();l="<ul class='bookacti-success-list bookacti-persistent-notice'><li>"+k.message+"</li></ul>";if(j.indexOf("://")<0){bookacti_refresh_booking_numbers(a)}}if(typeof k.nonce!=="undefined"){if(k.nonce){b.find('input[name="nonce_booking_form"]').val(k.nonce)}}if(l){f.empty().append(l).show();if(!j){bookacti_scroll_to(f,500,"middle")}}var m={};if(typeof e.forEach==="function"){e.forEach(function(o,n){m[n]=o})}else{m=b.serializeObject()}b.trigger("bookacti_booking_form_submitted",[k,m]);if(k.status==="success"&&j){bookacti_start_loading_booking_system(a);window.location.replace(j);bookacti_stop_loading_booking_system(a)}},error:function(k){var j='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";f.empty().append(j).show();bookacti_scroll_to(f,500,"middle");console.log("AJAX "+bookacti_localized.error);console.log(k)},complete:function(){if(c){c.next(".bookacti-loading-alt").remove();c.prop("disabled",false)}bookacti_stop_loading_booking_system(a)}})}function bookacti_dialog_forgotten_password(b){var a=$j('.bookacti-forgotten-password-dialog[data-field-id="'+b+'"]');if(!a.length){a=$j(".bookacti-forgotten-password-dialog:first")}a.dialog("open");a.dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){a.find(".bookacti-loading-alt, .bookacti-notices").remove();var c=a.find(".bookacti-forgotten-password-email").val();var d=a.find(".bookacti-nonce-forgotten-password").val();if(!c||!d){return}var e='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";a.append(e);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiForgottenPassword",email:c,nonce:d},dataType:"json",success:function(f){if(f.status==="success"){if(typeof f.message!=="undefined"){a.append('<div class="bookacti-notices"><ul class="bookacti-success-list"><li>'+f.message+"</li></ul></div>")}$j("body").trigger("bookacti_forgotten_password_email_sent",[c,f])}else{if(f.status==="failed"){var g=typeof f.message!=="undefined"?f.message:bookacti_localized.error;a.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+g+"</li></ul></div>");console.log(g);console.log(f)}}},error:function(f){a.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul></div>");console.log(f)},complete:function(){a.find(".bookacti-notices").show();a.find(".bookacti-loading-alt").remove()}})}}])};