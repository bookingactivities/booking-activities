$j(document).ready(function(){bookacti_init_form_dialogs();bookacti_init_tooltip();$j("body").on("keyup mouseup change",".bookacti-booking-form input[name=password], .bookacti-form-fields input[name=password]",function(){var d=$j(this);var b=null;var e=$j(this).closest(".bookacti-form-field-container").find(".bookacti-password-strength-meter");var f=[];var a=d.closest("form, .bookacti-form-fields").find('input[name="login_type"]:checked').val();if(e.length&&a==="new_account"){var c=bookacti_check_password_strength(d,b,e,f);$j(this).closest(".bookacti-form-field-container").find("input[name=password_strength]").val(c)}else{d.removeClass("short bad good strong")}});$j("body").on("click",".bookacti-forgotten-password-link",function(b){if(!$j(this).attr("href")||$j(this).attr("href")==="#"){b.preventDefault();var a=$j(this).data("field-id");bookacti_dialog_forgotten_password(a)}});$j(".bookacti-form-field-container.bookacti-form-field-type-login").each(function(){bookacti_show_hide_register_fields($j(this))});$j("body").on("change",'.bookacti-form-field-container.bookacti-form-field-type-login input[name="login_type"]',function(){var a=$j(this).closest(".bookacti-form-field-container.bookacti-form-field-type-login");bookacti_show_hide_register_fields(a)});$j("body").on("click",".bookacti-form-field-login-field-container .bookacti-login-button",function(a){a.preventDefault();if(typeof bookacti_localized.current_user_id!=="undefined"){if(bookacti_localized.current_user_id){return}}bookacti_submit_login_form($j(this))});$j("body").on("submit",".bookacti-booking-form",function(b){b.preventDefault();var a=$j(this).find(".bookacti-form-field-type-calendar .bookacti-booking-system");bookacti_perform_form_action(a);$j(this).trigger("bookacti_submit_booking_form")});$j("body").on("click",".bookacti-booking-form .bookacti-new-booking-button",function(){if($j(this).hasClass("bookacti-reload-page")){window.location.reload(true);$j(this).prop("disabled",true);return}var c=$j(this).closest("form");var a=c.find(".bookacti-booking-system");bookacti_clear_booking_system_displayed_info(a);var b=c.find("> .bookacti-notices").length?c.find("> .bookacti-notices"):a.siblings(".bookacti-notices");b.empty();c.find('.bookacti-form-field-container:not(.bookacti-hidden-field), input[type="submit"]').show();$j(this).hide();c.trigger("bookacti_make_new_booking")});$j("body").on("bookacti_displayed_info_cleared",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.find('input[name="quantity"]').attr("disabled",false);a.find('button[type="submit"]').attr("disabled",false)});$j("body").on("bookacti_error_displayed",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.find('input[name="quantity"]').attr("disabled",true);a.find('button[type="submit"]').attr("disabled",true)});$j('form input[name="quantity"]').each(function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");if(a.length&&a.find(".bookacti-booking-system").length){a.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)])}});$j("body").on("keyup mouseup change",".bookacti-booking-form input.bookacti-quantity, .bookacti-form-fields input.bookacti-quantity",function(){var b=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");if(!b.length){return}b.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)]);var a=b.find(".bookacti-booking-system");if(a.length){bookacti_set_min_and_max_quantity(a);bookacti_fill_picked_events_list(a)}});$j("body").on("bookacti_quantity_updated",".bookacti-booking-form input.bookacti-quantity, .bookacti-form-fields input.bookacti-quantity",function(d,a,c){var b=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");if(b.length){b.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)])}});$j("body").on("bookacti_booking_form_quantity_change","form, .bookacti-form-fields",function(d,c,a){var b=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");if(b.length){bookacti_update_total_price_field_data_and_refresh(b)}});if($j(".bookacti-form-field-type-total_price").length){$j(".bookacti-form-field-type-total_price").each(function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");bookacti_update_total_price_field_data_and_refresh(a)})}});function bookacti_init_form_dialogs(){$j(".bookacti-form-dialog").dialog({modal:true,autoOpen:false,minHeight:300,minWidth:460,resize:"auto",show:true,hide:true,dialogClass:"bookacti-dialog",closeText:"&#10006;",beforeClose:function(){if(!bookacti_localized.is_admin){return}var b=".bookacti-form-dialog";var a=$j(this).attr("id");if(a){b="#"+a}bookacti_empty_all_dialog_forms(b)}});$j("body").on("click",".ui-widget-overlay",function(){$j("div:ui-dialog:visible").dialog("close")});$j(".bookacti-form-dialog").on("keydown",function(a){if(!$j("textarea").is(":focus")&&a.keyCode==$j.ui.keyCode.ENTER){$j(this).parent().find(".ui-dialog-buttonpane button:first").focus();return false}})}function bookacti_show_hide_register_fields(e){var a=e.find('input[name="login_type"]:checked').val();var g=e.find(".bookacti-password-strength");var c=e.find(".bookacti-forgotten-password");var i=e.find(".bookacti-login-field-password");var h=e.find(".bookacti-login-field-remember");var d=e.find(".bookacti-register-fields");var f=e.find(".bookacti-login-button");var b=e.find(".bookacti-login-field-submit-button");if(a==="new_account"){g.show();c.hide();if(i.hasClass("bookacti-generated-password")){i.hide();i.find('input[name="password"]').prop("required",false)}else{i.show();i.find('input[name="password"]').prop("required",true)}h.show();d.show();d.find(".bookacti-required-field").prop("required",true);f.val(f.data("register-label")).prop("disabled",false);b.show()}else{if(a==="my_account"){g.hide();c.show();if(i.hasClass("bookacti-password-not-required")){i.hide();i.find('input[name="password"]').prop("required",false)}else{i.show();i.find('input[name="password"]').prop("required",true)}h.show();d.hide();d.find(".bookacti-required-field").prop("required",false);f.val(f.data("login-label")).prop("disabled",false);b.show()}else{if(a==="no_account"){i.hide();i.find('input[name="password"]').prop("required",false);h.hide();d.show();d.find(".bookacti-required-field").prop("required",true);f.prop("disabled",true);b.hide()}}}}function bookacti_check_password_strength(d,b,e,f){if(typeof window.zxcvbn==="undefined"||typeof wp.passwordStrength==="undefined"||typeof pwsL10n==="undefined"){return 4}var g=d.val();var a=b!=null?b.val():g;f=typeof wp.passwordStrength.userInputDisallowedList==="function"?f.concat(wp.passwordStrength.userInputDisallowedList()):f.concat(wp.passwordStrength.userInputBlacklist());d.removeClass("short bad good strong");e.removeClass("short bad good strong");var c=wp.passwordStrength.meter(g,f,a);switch(c){case 2:d.addClass("bad");e.addClass("bad").html(pwsL10n.bad);break;case 3:d.addClass("good");e.addClass("good").html(pwsL10n.good);break;case 4:d.addClass("strong");e.addClass("strong").html(pwsL10n.strong);break;case 5:d.addClass("short");e.addClass("short").html(pwsL10n.mismatch);break;default:d.addClass("short");e.addClass("short").html(pwsL10n["short"])}return c}function bookacti_submit_login_form(b){if(!b.closest(".bookacti-form-field-container").length){return}if(!b.closest(".bookacti-form-field-container").find(".bookacti-email").length){return}var g=b.closest(".bookacti-form-field-container");b.prop("disabled",true);if(!b.closest("form").length){if(g.closest(".bookacti-form-fields").length){g.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>')}else{g.wrap('<form class="bookacti-temporary-form"></form>')}}var e=b.closest("form");if(!e.find("> .bookacti-notices").length){e.append('<div class="bookacti-notices"></div>')}var d=e.find("> .bookacti-notices");d.empty();if(e.find('input[name="login_type"][value="new_account"]').is(":checked")&&!e.find(".bookacti-generated-password").length&&parseInt(e.find(".bookacti-password_strength").val())<parseInt(e.find(".bookacti-password_strength").attr("min"))){d.append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show();b.prop("disabled",false);bookacti_scroll_to(d,500,"middle");return}var a=e.find('input[name="action"]').length;var c=a?e.find('input[name="action"]').val():"";if(a){e.find('input[name="action"]').val("bookactiSubmitLoginForm")}else{e.append('<input type="hidden" name="action" value="bookactiSubmitLoginForm"/>')}var f={form_data:new FormData(e.get(0))};g.trigger("bookacti_before_submit_login_form",[f]);if(a){e.find('input[name="action"]').val(c)}else{e.find('input[name="action"]').remove()}if(!(f.form_data instanceof FormData)){b.prop("disabled",false);return false}bookacti_add_loading_html(b,"after");$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:f.form_data,dataType:"json",cache:false,contentType:false,processData:false,success:function(k){var m=k.message?k.message:(k.messages?k.messages:"");if(m){var l=k.status==="success"?"bookacti-success-list":"bookacti-error-list";var n='<ul class="'+l+'"><li>'+m+"</li></ul>";d.append(n).show();bookacti_scroll_to(d,500,"middle")}if(k.status==="success"){e.trigger("bookacti_login_form_submitted",[k,f]);e.find(".bookacti-form-field-name-login :input").prop("disabled",true);var j=e.serialize();e.find(".bookacti-form-field-name-login :input").prop("disabled",false);var i=typeof e.attr("action")!=="undefined"&&c==="bookactiSubmitLoginForm"?e.attr("action"):"";var h=k.redirect_url?k.redirect_url:i;h+=h.indexOf("?")>=0?"&"+j:"?"+j;window.location.replace(h)}},error:function(i){var h='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";d.empty().append(h).show();bookacti_scroll_to(d,500,"middle");console.log("AJAX "+bookacti_localized.error);console.log(i)},complete:function(){bookacti_remove_loading_html(b.parent());b.prop("disabled",false)}})}function bookacti_submit_booking_form(b){var a=b.find(".bookacti-booking-system");var c=b.find('input[type="submit"]');if(c.length){c.prop("disabled",true)}var g=b.find("> .bookacti-notices").length?b.find("> .bookacti-notices"):a.siblings(".bookacti-notices");var h=false;if(typeof bookacti_localized.current_user_id!=="undefined"){if(bookacti_localized.current_user_id){h=true}}var i=b.find(".bookacti-email").length?true:false;if(!h&&!i){g.empty().append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_user_not_logged_in+"</li></ul>").show();if(c.length){c.prop("disabled",false)}bookacti_scroll_to(g,500,"middle");return false}if(i){if(b.find('input[name="login_type"][value="new_account"]').is(":checked")&&!b.find(".bookacti-generated-password").length&&parseInt(b.find(".bookacti-password_strength").val())<parseInt(b.find(".bookacti-password_strength").attr("min"))){g.empty().append("<ul class='bookacti-error-list'><li>"+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show();if(c.length){c.prop("disabled",false)}bookacti_scroll_to(g,500,"middle");return false}}var j=bookacti_validate_picked_events(a,b.find(".bookacti-quantity").val());if(!j){bookacti_scroll_to(a.siblings(".bookacti-notices"),500,"middle");if(c.length){c.prop("disabled",false)}return false}var f=b.find('input[name="action"]').length;var e=f?b.find('input[name="action"]').val():"";if(f){b.find('input[name="action"]').val("bookactiSubmitBookingForm")}else{b.append('<input type="hidden" name="action" value="bookactiSubmitBookingForm"/>')}var d={form_data:new FormData(b.get(0))};b.trigger("bookacti_before_submit_booking_form",[d]);if(f){b.find('input[name="action"]').val(e)}else{b.find('input[name="action"]').remove()}if(!(d.form_data instanceof FormData)){if(c.length){c.prop("disabled",false)}return false}bookacti_start_loading_booking_system(a);if(c.length){bookacti_add_loading_html(c,"after")}$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:d.form_data,dataType:"json",cache:false,contentType:false,processData:false,success:function(l){var k=typeof l.redirect_url!=="undefined"?l.redirect_url:"";var m="";if(l.status!=="success"){m="<ul class='bookacti-error-list'><li>"+l.message+"</li></ul>"}else{b.find('.bookacti-form-field-container:not(.bookacti-form-field-name-submit):not(.bookacti-form-field-name-calendar), input[type="submit"]').hide();if(l.has_logged_in){b.find(".bookacti-new-booking-button").addClass("bookacti-reload-page")}else{b.find(".bookacti-new-booking-button").removeClass("bookacti-reload-page")}b.find(".bookacti-new-booking-button").show();m="<ul class='bookacti-success-list bookacti-persistent-notice'><li>"+l.message+"</li></ul>";if(k.indexOf("://")<0){bookacti_refresh_booking_numbers(a)}}if(m){g.empty().append(m).show();if(!k){bookacti_scroll_to(g,500,"middle")}}var n=b.serializeObject();b.trigger("bookacti_booking_form_submitted",[l,n]);if(l.status==="success"&&k){bookacti_start_loading_booking_system(a);window.location.replace(k);bookacti_stop_loading_booking_system(a)}},error:function(l){var k='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";g.empty().append(k).show();bookacti_scroll_to(g,500,"middle");console.log("AJAX "+bookacti_localized.error);console.log(l)},complete:function(){if(c.length){bookacti_remove_loading_html(c.parent());c.prop("disabled",false)}bookacti_stop_loading_booking_system(a)}})}function bookacti_perform_form_action(b){var d={trigger:true};if(b.closest("#bookacti-form-editor-page-form").length){d.trigger=false}b.trigger("bookacti_trigger_perform_form_action",[d]);if(!d.trigger){return}var a=b.attr("id");var c=bookacti.booking_system[a];if(typeof c.form_action==="undefined"){return}if(c.form_action==="default"){if(!b.closest("form").length&&b.closest(".bookacti-form-fields").length){b.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>')}if(b.closest("form.bookacti-booking-form").length||b.closest("form.bookacti-temporary-form").length){bookacti_submit_booking_form(b.closest("form"))}}else{if(c.form_action==="redirect_to_url"){var h=b.closest(".bookacti-form-fields").length?(b.closest(".bookacti-form-fields").find(".bookacti-quantity").length?b.closest(".bookacti-form-fields").find(".bookacti-quantity").val():1):1;var g=bookacti_validate_picked_events(b,h);if(!g){bookacti_scroll_to(b.siblings(".bookacti-notices"),500,"middle");return}var e=parseInt(c.picked_events[0]["group_id"]);var f=c.picked_events[0];if(e>0){bookacti_redirect_to_group_category_url(b,e)}else{bookacti_redirect_to_activity_url(b,f)}}}b.trigger("bookacti_perform_form_action")}function bookacti_dialog_forgotten_password(b){var a=$j('.bookacti-forgotten-password-dialog[data-field-id="'+b+'"]');if(!a.length){a=$j(".bookacti-forgotten-password-dialog:first")}a.dialog("open");a.dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){a.find(".bookacti-notices").remove();var c=a.find(".bookacti-forgotten-password-email").val();if(!c){return}bookacti_add_loading_html(a);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiForgottenPassword",email:c},dataType:"json",success:function(d){if(d.status==="success"){if(typeof d.message!=="undefined"){a.append('<div class="bookacti-notices"><ul class="bookacti-success-list"><li>'+d.message+"</li></ul></div>")}$j("body").trigger("bookacti_forgotten_password_email_sent",[c,d])}else{if(d.status==="failed"){var e=typeof d.message!=="undefined"?d.message:bookacti_localized.error;a.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+e+"</li></ul></div>");console.log(e);console.log(d)}}},error:function(d){a.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul></div>");console.log(d)},complete:function(){a.find(".bookacti-notices").show();bookacti_remove_loading_html(a)}})}}])}function bookacti_update_total_price_field_data_and_refresh(c){if(!c.find(".bookacti-form-field-type-total_price").length){return}var a=c.attr("id");var b="bookacti_update_total_price_field_"+a;if(typeof window[b]!=="undefined"){if(window[b]){clearTimeout(window[b])}}window[b]=setTimeout(function(){bookacti_update_total_price_field_data(c);bookacti_refresh_total_price_field(c)},200)}function bookacti_update_total_price_field_data(a){bookacti_update_total_price_field_picked_events_data(a);a.trigger("bookacti_update_total_price_field_data")}function bookacti_update_total_price_field_picked_events_data(f){var c=f.attr("id");if(typeof bookacti.total_price_fields_data[c]==="undefined"){bookacti.total_price_fields_data[c]={items:[],total:{price:0,price_to_display:""}}}var g=bookacti.total_price_fields_data[c];g.items=$j.grep(g.items,function(h){if(typeof h.id==="undefined"){return true}return h.id.indexOf("picked-")<0});var b=f.find(".bookacti-booking-system");if(!b.length){return}var a=b.attr("id");if(typeof bookacti.booking_system[a]["picked_events"]==="undefined"){return}var e=[];var d=bookacti_get_picked_events_list_items(b);$j.each(d,function(i,h){if(h.quantity>0){e.push({id:"picked-"+i,label:h.list_element.html(),price:h.price,price_to_display:h.price_to_display})}});g.items=e.concat(g.items);f.trigger("bookacti_total_price_field_picked_events_data",[g,d])}function bookacti_refresh_total_price_field(e){var a=e.attr("id");if(typeof bookacti.total_price_fields_data[a]==="undefined"){return}if($j.isEmptyObject(bookacti.total_price_fields_data[a])){return}var f=$j.extend(true,{},bookacti.total_price_fields_data[a]);e.trigger("bookacti_refresh_total_price_field",[f]);var d=0;var g=f.total.price_to_display;var b=e.find(".bookacti-form-field-type-total_price .bookacti-total-price-table");var c=e.find(".bookacti-form-field-type-total_price .bookacti-grand-total-price-container");if(b.length){b.find("tbody").empty()}$j.each(f.items,function(j,l){if(typeof l.price==="undefined"){return true}if(!$j.isNumeric(l.price)){return true}d+=parseFloat(l.price);if(b.length){var h=typeof l.label!=="undefined"?l.label:"";var k=l.price_to_display;if(typeof l.price_to_display==="undefined"){l.price_to_display=""}if(!l.price_to_display&&l.price){l.price_to_display=bookacti_format_price(parseFloat(l.price))}var m=$j("<tr></tr>",{html:"<td>"+h+"</td><td>"+k+"</td>"});b.find("tbody").append(m)}});if(!g&&d){g=bookacti_format_price(d)}if(c.length){c.html(g)}e.find(".bookacti-form-field-type-total_price .bookacti-total-price-value").val(d);e.find(".bookacti-form-field-type-total_price:not(.bookacti-form-editor-field)").toggle(b.length?(b.find("tbody tr").length>0):(c.html().length>0));e.trigger("bookacti_total_price_field_refreshed",[f])};