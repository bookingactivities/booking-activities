$j(document).ready(function(){bookacti_init_form_dialogs();bookacti_init_tooltip();$j("body").on("keyup mouseup change",".bookacti-booking-form input[name=password], .bookacti-form-fields input[name=password]",function(){var a=$j(this),b=$j(this).closest(".bookacti-form-field-container").find(".bookacti-password-strength-meter"),c=[],e=a.closest("form, .bookacti-form-fields").find('input[name="login_type"]:checked').val();b.length&&"new_account"===e?(a=bookacti_check_password_strength(a,null,b,c),
$j(this).closest(".bookacti-form-field-container").find("input[name=password_strength]").val(a)):a.removeClass("short bad good strong")});$j("body").on("click",".bookacti-forgotten-password-link",function(a){$j(this).attr("href")&&"#"!==$j(this).attr("href")||(a.preventDefault(),a=$j(this).data("field-id"),bookacti_dialog_forgotten_password(a))});$j(".bookacti-form-field-container.bookacti-form-field-type-login").each(function(){bookacti_show_hide_register_fields($j(this))});$j("body").on("change",
'.bookacti-form-field-container.bookacti-form-field-type-login input[name="login_type"]',function(){var a=$j(this).closest(".bookacti-form-field-container.bookacti-form-field-type-login");bookacti_show_hide_register_fields(a)});$j("body").on("click",".bookacti-form-field-login-field-container .bookacti-login-button",function(a){a.preventDefault();"undefined"!==typeof bookacti_localized.current_user_id&&bookacti_localized.current_user_id||bookacti_submit_login_form($j(this))});$j("body").on("submit",
".bookacti-booking-form",function(a){a.preventDefault();a=$j(this).find(".bookacti-form-field-type-calendar .bookacti-booking-system");bookacti_perform_form_action(a);$j(this).trigger("bookacti_submit_booking_form")});$j("body").on("click",".bookacti-booking-form .bookacti-new-booking-button",function(){if($j(this).hasClass("bookacti-reload-page"))window.location.reload(!0),$j(this).prop("disabled",!0);else{var a=$j(this).closest("form"),b=a.find(".bookacti-booking-system");bookacti_clear_booking_system_displayed_info(b);
(a.find("> .bookacti-notices").length?a.find("> .bookacti-notices"):b.siblings(".bookacti-notices")).empty();a.find('.bookacti-form-field-container:not(.bookacti-hidden-field), input[type="submit"]').show();$j(this).hide();a.trigger("bookacti_make_new_booking")}});$j("body").on("bookacti_displayed_info_cleared",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");
a.find('input[name="quantity"]').attr("disabled",!1);a.find('button[type="submit"]').attr("disabled",!1)});$j("body").on("bookacti_error_displayed",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.find('input[name="quantity"]').attr("disabled",!0);a.find('button[type="submit"]').attr("disabled",!0)});$j('form input[name="quantity"]').each(function(){var a=
$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.length&&a.find(".bookacti-booking-system").length&&a.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)])});$j("body").on("keyup mouseup change",".bookacti-booking-form input.bookacti-quantity, .bookacti-form-fields input.bookacti-quantity",function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.length&&(a.trigger("bookacti_booking_form_quantity_change",
[$j(this).val(),$j(this)]),a=a.find(".bookacti-booking-system"),a.length&&(bookacti_set_min_and_max_quantity(a),bookacti_fill_picked_events_list(a)))});$j("body").on("bookacti_quantity_updated",".bookacti-booking-form input.bookacti-quantity, .bookacti-form-fields input.bookacti-quantity",function(a,b,c){a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.length&&a.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)])});$j("body").on("bookacti_booking_form_quantity_change",
"form, .bookacti-form-fields",function(a,b,c){a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.length&&bookacti_update_total_price_field_data_and_refresh(a)});$j(".bookacti-form-field-type-total_price").length&&$j(".bookacti-form-field-type-total_price").each(function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");bookacti_update_total_price_field_data_and_refresh(a)})});
function bookacti_init_form_dialogs(){$j(".bookacti-form-dialog").dialog({modal:!0,autoOpen:!1,minHeight:300,minWidth:460,resize:"auto",show:!0,hide:!0,dialogClass:"bookacti-dialog",closeText:"&#10006;",beforeClose:function(){if(bookacti_localized.is_admin){var a=".bookacti-form-dialog",b=$j(this).attr("id");b&&(a="#"+b);bookacti_empty_all_dialog_forms(a)}}});$j("body").on("click",".ui-widget-overlay",function(){$j("div:ui-dialog:visible").dialog("close")});$j(".bookacti-form-dialog").on("keydown",
function(a){if(!$j("textarea").is(":focus")&&a.keyCode==$j.ui.keyCode.ENTER)return $j(this).parent().find(".ui-dialog-buttonpane button:first").focus(),!1})}
function bookacti_show_hide_register_fields(a){var b=a.find('input[name="login_type"]:checked').val(),c=a.find(".bookacti-password-strength"),e=a.find(".bookacti-forgotten-password"),f=a.find(".bookacti-login-field-password"),h=a.find(".bookacti-login-field-remember"),g=a.find(".bookacti-register-fields"),d=a.find(".bookacti-login-button");a=a.find(".bookacti-login-field-submit-button");"new_account"===b?(c.show(),e.hide(),f.hasClass("bookacti-generated-password")?(f.hide(),f.find('input[name="password"]').prop("required",
!1)):(f.show(),f.find('input[name="password"]').prop("required",!0)),h.show(),g.show(),g.find(".bookacti-required-field").prop("required",!0),d.val(d.data("register-label")).prop("disabled",!1),a.show()):"my_account"===b?(c.hide(),e.show(),f.hasClass("bookacti-password-not-required")?(f.hide(),f.find('input[name="password"]').prop("required",!1)):(f.show(),f.find('input[name="password"]').prop("required",!0)),h.show(),g.hide(),g.find(".bookacti-required-field").prop("required",!1),d.val(d.data("login-label")).prop("disabled",
!1),a.show()):"no_account"===b&&(f.hide(),f.find('input[name="password"]').prop("required",!1),h.hide(),g.show(),g.find(".bookacti-required-field").prop("required",!0),d.prop("disabled",!0),a.hide())}
function bookacti_check_password_strength(a,b,c,e){if("undefined"===typeof window.zxcvbn||"undefined"===typeof wp.passwordStrength||"undefined"===typeof pwsL10n)return 4;var f=a.val();b=null!=b?b.val():f;e="function"===typeof wp.passwordStrength.userInputDisallowedList?e.concat(wp.passwordStrength.userInputDisallowedList()):e.concat(wp.passwordStrength.userInputBlacklist());a.removeClass("short bad good strong");c.removeClass("short bad good strong");e=wp.passwordStrength.meter(f,e,b);switch(e){case 2:a.addClass("bad");
c.addClass("bad").html(pwsL10n.bad);break;case 3:a.addClass("good");c.addClass("good").html(pwsL10n.good);break;case 4:a.addClass("strong");c.addClass("strong").html(pwsL10n.strong);break;case 5:a.addClass("short");c.addClass("short").html(pwsL10n.mismatch);break;default:a.addClass("short"),c.addClass("short").html(pwsL10n["short"])}return e}
function bookacti_submit_login_form(a){if(a.closest(".bookacti-form-field-container").length&&a.closest(".bookacti-form-field-container").find(".bookacti-email").length){var b=a.closest(".bookacti-form-field-container");a.prop("disabled",!0);a.closest("form").length||(b.closest(".bookacti-form-fields").length?b.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>'):b.wrap('<form class="bookacti-temporary-form"></form>'));var c=a.closest("form");c.find("> .bookacti-notices").length||
c.append('<div class="bookacti-notices"></div>');var e=c.find("> .bookacti-notices");e.empty();if(c.find('input[name="login_type"][value="new_account"]').is(":checked")&&!c.find(".bookacti-generated-password").length&&parseInt(c.find(".bookacti-password_strength").val())<parseInt(c.find(".bookacti-password_strength").attr("min")))e.append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show(),a.prop("disabled",!1),bookacti_scroll_to(e,500,"middle");
else{var f=c.find('input[name="action"]').length,h=f?c.find('input[name="action"]').val():"";f?c.find('input[name="action"]').val("bookactiSubmitLoginForm"):c.append('<input type="hidden" name="action" value="bookactiSubmitLoginForm"/>');var g={form_data:new FormData(c.get(0))};b.trigger("bookacti_before_submit_login_form",[g]);f?c.find('input[name="action"]').val(h):c.find('input[name="action"]').remove();if(!(g.form_data instanceof FormData))return a.prop("disabled",!1),!1;bookacti_add_loading_html(a,
"after");$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:g.form_data,dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(d){var k=d.message?d.message:d.messages?d.messages:"";k&&(e.append('<ul class="'+("success"===d.status?"bookacti-success-list":"bookacti-error-list")+'"><li>'+k+"</li></ul>").show(),bookacti_scroll_to(e,500,"middle"));if("success"===d.status){c.trigger("bookacti_login_form_submitted",[d,g]);c.find(".bookacti-form-field-name-login :input").prop("disabled",
!0);k=c.serialize();c.find(".bookacti-form-field-name-login :input").prop("disabled",!1);var l="undefined"!==typeof c.attr("action")&&"bookactiSubmitLoginForm"===h?c.attr("action"):"";d=d.redirect_url?d.redirect_url:l;d+=0<=d.indexOf("?")?"&"+k:"?"+k;window.location.replace(d)}},error:function(d){var k='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";e.empty().append(k).show();bookacti_scroll_to(e,500,"middle");console.log("AJAX "+bookacti_localized.error);console.log(d)},
complete:function(){bookacti_remove_loading_html(a.parent());a.prop("disabled",!1)}})}}}
function bookacti_submit_booking_form(a){var b=a.find(".bookacti-booking-system"),c=a.find('input[type="submit"]');c.length&&c.prop("disabled",!0);var e=a.find("> .bookacti-notices").length?a.find("> .bookacti-notices"):b.siblings(".bookacti-notices"),f=!1;"undefined"!==typeof bookacti_localized.current_user_id&&bookacti_localized.current_user_id&&(f=!0);var h=a.find(".bookacti-email").length?!0:!1;if(!f&&!h)return e.empty().append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_user_not_logged_in+
"</li></ul>").show(),c.length&&c.prop("disabled",!1),bookacti_scroll_to(e,500,"middle"),!1;if(h&&a.find('input[name="login_type"][value="new_account"]').is(":checked")&&!a.find(".bookacti-generated-password").length&&parseInt(a.find(".bookacti-password_strength").val())<parseInt(a.find(".bookacti-password_strength").attr("min")))return e.empty().append("<ul class='bookacti-error-list'><li>"+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show(),c.length&&c.prop("disabled",!1),bookacti_scroll_to(e,
500,"middle"),!1;if(!bookacti_validate_picked_events(b,a.find(".bookacti-quantity").val()))return bookacti_scroll_to(b.siblings(".bookacti-notices"),500,"middle"),c.length&&c.prop("disabled",!1),!1;h=(f=a.find('input[name="action"]').length)?a.find('input[name="action"]').val():"";f?a.find('input[name="action"]').val("bookactiSubmitBookingForm"):a.append('<input type="hidden" name="action" value="bookactiSubmitBookingForm"/>');var g={form_data:new FormData(a.get(0))};a.trigger("bookacti_before_submit_booking_form",
[g]);f?a.find('input[name="action"]').val(h):a.find('input[name="action"]').remove();if(!(g.form_data instanceof FormData))return c.length&&c.prop("disabled",!1),!1;bookacti_start_loading_booking_system(b);c.length&&bookacti_add_loading_html(c,"after");$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:g.form_data,dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(d){var k="undefined"!==typeof d.redirect_url?d.redirect_url:"";if("success"!==d.status)var l="<ul class='bookacti-error-list'><li>"+
d.message+"</li></ul>";else a.find('.bookacti-form-field-container:not(.bookacti-form-field-name-submit):not(.bookacti-form-field-name-calendar), input[type="submit"]').hide(),d.has_logged_in?a.find(".bookacti-new-booking-button").addClass("bookacti-reload-page"):a.find(".bookacti-new-booking-button").removeClass("bookacti-reload-page"),a.find(".bookacti-new-booking-button").show(),l="<ul class='bookacti-success-list bookacti-persistent-notice'><li>"+d.message+"</li></ul>",0>k.indexOf("://")&&bookacti_refresh_booking_numbers(b);
l&&(e.empty().append(l).show(),k||bookacti_scroll_to(e,500,"middle"));l=a.serializeObject();a.trigger("bookacti_booking_form_submitted",[d,l]);"success"===d.status&&k&&(bookacti_start_loading_booking_system(b),window.location.replace(k),bookacti_stop_loading_booking_system(b))},error:function(d){var k='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";e.empty().append(k).show();bookacti_scroll_to(e,500,"middle");console.log("AJAX "+bookacti_localized.error);console.log(d)},
complete:function(){c.length&&(bookacti_remove_loading_html(c.parent()),c.prop("disabled",!1));bookacti_stop_loading_booking_system(b)}})}
function bookacti_perform_form_action(a){var b={trigger:!0};a.closest("#bookacti-form-editor-page-form").length&&(b.trigger=!1);a.trigger("bookacti_trigger_perform_form_action",[b]);if(b.trigger&&(b=a.attr("id"),b=bookacti.booking_system[b],"undefined"!==typeof b.form_action)){if("default"===b.form_action)!a.closest("form").length&&a.closest(".bookacti-form-fields").length&&a.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>'),(a.closest("form.bookacti-booking-form").length||
a.closest("form.bookacti-temporary-form").length)&&bookacti_submit_booking_form(a.closest("form"));else if("redirect_to_url"===b.form_action){var c=a.closest(".bookacti-form-fields").length?a.closest(".bookacti-form-fields").find(".bookacti-quantity").length?a.closest(".bookacti-form-fields").find(".bookacti-quantity").val():1:1;if(!bookacti_validate_picked_events(a,c)){bookacti_scroll_to(a.siblings(".bookacti-notices"),500,"middle");return}c=parseInt(b.picked_events[0].group_id);b=b.picked_events[0];
0<c?bookacti_redirect_to_group_category_url(a,c):bookacti_redirect_to_activity_url(a,b)}a.trigger("bookacti_perform_form_action")}}
function bookacti_dialog_forgotten_password(a){var b=$j('.bookacti-forgotten-password-dialog[data-field-id="'+a+'"]');b.length||(b=$j(".bookacti-forgotten-password-dialog:first"));b.dialog("open");b.dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){b.find(".bookacti-notices").remove();var c=b.find(".bookacti-forgotten-password-email").val();c&&(bookacti_add_loading_html(b),$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiForgottenPassword",
email:c},dataType:"json",success:function(e){if("success"===e.status)"undefined"!==typeof e.message&&b.append('<div class="bookacti-notices"><ul class="bookacti-success-list"><li>'+e.message+"</li></ul></div>"),$j("body").trigger("bookacti_forgotten_password_email_sent",[c,e]);else if("failed"===e.status){var f="undefined"!==typeof e.message?e.message:bookacti_localized.error;b.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+f+"</li></ul></div>");console.log(f);console.log(e)}},
error:function(e){b.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul></div>");console.log(e)},complete:function(){b.find(".bookacti-notices").show();bookacti_remove_loading_html(b)}}))}}])}
function bookacti_update_total_price_field_data_and_refresh(a){if(a.find(".bookacti-form-field-type-total_price").length){var b="bookacti_update_total_price_field_"+a.attr("id");"undefined"!==typeof window[b]&&window[b]&&clearTimeout(window[b]);window[b]=setTimeout(function(){bookacti_update_total_price_field_data(a);bookacti_refresh_total_price_field(a)},200)}}
function bookacti_update_total_price_field_data(a){bookacti_update_total_price_field_picked_events_data(a);a.trigger("bookacti_update_total_price_field_data")}
function bookacti_update_total_price_field_picked_events_data(a){var b=a.attr("id");"undefined"===typeof bookacti.total_price_fields_data[b]&&(bookacti.total_price_fields_data[b]={items:[],total:{price:0,price_to_display:""}});b=bookacti.total_price_fields_data[b];b.items=$j.grep(b.items,function(h){return"undefined"===typeof h.id?!0:0>h.id.indexOf("picked-")});var c=a.find(".bookacti-booking-system");if(c.length){var e=c.attr("id");if("undefined"!==typeof bookacti.booking_system[e].picked_events){var f=
[];c=bookacti_get_picked_events_list_items(c);$j.each(c,function(h,g){0<g.quantity&&f.push({id:"picked-"+h,label:g.list_element.html(),price:g.price,price_to_display:g.price_to_display})});b.items=f.concat(b.items);a.trigger("bookacti_total_price_field_picked_events_data",[b,c])}}}
function bookacti_refresh_total_price_field(a){var b=a.attr("id");if("undefined"!==typeof bookacti.total_price_fields_data[b]&&!$j.isEmptyObject(bookacti.total_price_fields_data[b])){b=$j.extend(!0,{},bookacti.total_price_fields_data[b]);a.trigger("bookacti_refresh_total_price_field",[b]);var c=0,e=b.total.price_to_display,f=a.find(".bookacti-form-field-type-total_price .bookacti-total-price-table"),h=a.find(".bookacti-form-field-type-total_price .bookacti-grand-total-price-container");f.length&&
f.find("tbody").empty();$j.each(b.items,function(g,d){if("undefined"===typeof d.price||!$j.isNumeric(d.price))return!0;c+=parseFloat(d.price);if(f.length){g="undefined"!==typeof d.label?d.label:"";var k=d.price_to_display;"undefined"===typeof d.price_to_display&&(d.price_to_display="");!d.price_to_display&&d.price&&(d.price_to_display=bookacti_format_price(parseFloat(d.price)));d=$j("<tr></tr>",{html:"<td>"+g+"</td><td>"+k+"</td>"});f.find("tbody").append(d)}});!e&&c&&(e=bookacti_format_price(c));
h.length&&h.html(e);a.find(".bookacti-form-field-type-total_price .bookacti-total-price-value").val(c);a.find(".bookacti-form-field-type-total_price:not(.bookacti-form-editor-field)").toggle(f.length?0<f.find("tbody tr").length:0<h.html().length);a.trigger("bookacti_total_price_field_refreshed",[b])}};
