$j(document).ready(function(){bookacti_init_tooltip();$j("body").on("keyup mouseup change",".bookacti-booking-form input[name=password], .bookacti-form-fields input[name=password]",function(){var a=$j(this),b=$j(this).closest(".bookacti-form-field-container").find(".bookacti-password-strength-meter"),d=[],c=a.closest("form, .bookacti-form-fields").find('input[name="login_type"]:checked').val();b.length&&"new_account"===c?(a=bookacti_check_password_strength(a,null,b,d),$j(this).closest(".bookacti-form-field-container").find("input[name=password_strength]").val(a)):
a.removeClass("short bad good strong")});$j("body").on("click",".bookacti-forgotten-password-link",function(a){$j(this).attr("href")&&"#"!==$j(this).attr("href")||(a.preventDefault(),a=$j(this).data("field-id"),bookacti_dialog_forgotten_password(a))});$j(".bookacti-form-field-container.bookacti-form-field-type-login").each(function(){bookacti_show_hide_register_fields($j(this))});$j("body").on("change",'.bookacti-form-field-container.bookacti-form-field-type-login input[name="login_type"]',function(){var a=
$j(this).closest(".bookacti-form-field-container.bookacti-form-field-type-login");bookacti_show_hide_register_fields(a)});$j("body").on("click",".bookacti-form-field-login-field-container .bookacti-login-button",function(a){a.preventDefault();"undefined"!==typeof bookacti_localized.current_user_id&&bookacti_localized.current_user_id||bookacti_submit_login_form($j(this))});$j("body").on("submit",".bookacti-booking-form",function(a){a.preventDefault();a=$j(this).find(".bookacti-form-field-type-calendar .bookacti-booking-system");
bookacti_perform_form_action(a);$j(this).trigger("bookacti_submit_booking_form")});$j("body").on("click",".bookacti-booking-form .bookacti-new-booking-button",function(){if($j(this).hasClass("bookacti-reload-page"))window.location.reload(),$j(this).prop("disabled",!0);else{var a=$j(this).closest("form"),b=a.find(".bookacti-booking-system");bookacti_clear_booking_system_displayed_info(b);(a.find("> .bookacti-notices").length?a.find("> .bookacti-notices"):b.siblings(".bookacti-notices")).empty();a.find('.bookacti-form-field-container:not(.bookacti-hidden-field), input[type="submit"]').show();
$j(this).hide();a.trigger("bookacti_make_new_booking")}});$j("body").on("bookacti_displayed_info_cleared",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.find('input[name="quantity"]').attr("disabled",!1);a.find('button[type="submit"]').attr("disabled",!1)});$j("body").on("bookacti_error_displayed",".bookacti-booking-form .bookacti-booking-system, .bookacti-form-fields .bookacti-booking-system",
function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.find('input[name="quantity"]').attr("disabled",!0);a.find('button[type="submit"]').attr("disabled",!0)});$j('form input[name="quantity"]').each(function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.length&&a.find(".bookacti-booking-system").length&&a.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)])});
$j("body").on("keyup mouseup change",".bookacti-booking-form input.bookacti-quantity, .bookacti-form-fields input.bookacti-quantity",function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.length&&(a.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)]),a=a.find(".bookacti-booking-system"),a.length&&(bookacti_set_min_and_max_quantity(a),bookacti_fill_picked_events_list(a)))});$j("body").on("bookacti_quantity_updated",
".bookacti-booking-form input.bookacti-quantity, .bookacti-form-fields input.bookacti-quantity",function(a,b,d){a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");a.length&&a.trigger("bookacti_booking_form_quantity_change",[$j(this).val(),$j(this)])});$j("body").on("bookacti_booking_form_quantity_change","form, .bookacti-form-fields",function(a,b,d){a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");
a.length&&bookacti_update_total_price_field_data_and_refresh(a)});$j(".bookacti-form-field-type-total_price").length&&$j(".bookacti-form-field-type-total_price").each(function(){var a=$j(this).closest("form").length?$j(this).closest("form"):$j(this).closest(".bookacti-form-fields");bookacti_update_total_price_field_data_and_refresh(a)})});
function bookacti_show_hide_register_fields(a){var b=a.find('input[name="login_type"]:checked').val(),d=a.find(".bookacti-password-strength"),c=a.find(".bookacti-forgotten-password"),e=a.find(".bookacti-login-field-password"),h=a.find(".bookacti-login-field-remember"),k=a.find(".bookacti-register-fields"),f=a.find(".bookacti-login-button");a=a.find(".bookacti-login-field-submit-button");"new_account"===b?(d.show(),c.hide(),e.hasClass("bookacti-generated-password")?(e.hide(),e.find('input[name="password"]').prop("required",
!1)):(e.show(),e.find('input[name="password"]').prop("required",!0)),h.show(),k.show(),k.find(".bookacti-required-field").prop("required",!0),f.val(f.data("register-label")).prop("disabled",!1),a.show()):"my_account"===b?(d.hide(),c.show(),e.hasClass("bookacti-password-not-required")?(e.hide(),e.find('input[name="password"]').prop("required",!1)):(e.show(),e.find('input[name="password"]').prop("required",!0)),h.show(),k.hide(),k.find(".bookacti-required-field").prop("required",!1),f.val(f.data("login-label")).prop("disabled",
!1),a.show()):"no_account"===b&&(e.hide(),e.find('input[name="password"]').prop("required",!1),h.hide(),k.show(),k.find(".bookacti-required-field").prop("required",!0),f.prop("disabled",!0),a.hide())}
function bookacti_check_password_strength(a,b,d,c){if("undefined"===typeof window.zxcvbn||"undefined"===typeof wp.passwordStrength||"undefined"===typeof pwsL10n)return 4;var e=a.val();b=null!=b?b.val():e;c="function"===typeof wp.passwordStrength.userInputDisallowedList?c.concat(wp.passwordStrength.userInputDisallowedList()):c.concat(wp.passwordStrength.userInputBlacklist());a.removeClass("short bad good strong");d.removeClass("short bad good strong");c=wp.passwordStrength.meter(e,c,b);switch(c){case 2:a.addClass("bad");
d.addClass("bad").html(pwsL10n.bad);break;case 3:a.addClass("good");d.addClass("good").html(pwsL10n.good);break;case 4:a.addClass("strong");d.addClass("strong").html(pwsL10n.strong);break;case 5:a.addClass("short");d.addClass("short").html(pwsL10n.mismatch);break;default:a.addClass("short"),d.addClass("short").html(pwsL10n["short"])}return c}
function bookacti_submit_login_form(a){if(a.closest(".bookacti-form-field-container").length&&a.closest(".bookacti-form-field-container").find(".bookacti-email").length){var b=a.closest(".bookacti-form-field-container");a.prop("disabled",!0);var d=a.closest("form").length;d||(b.closest(".bookacti-form-fields").length?b.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>'):b.wrap('<form class="bookacti-temporary-form"></form>'));var c=a.closest("form");c.find("> .bookacti-notices").length||
c.append('<div class="bookacti-notices"></div>');var e=c.find("> .bookacti-notices");e.empty();if(c.find('input[name="login_type"][value="new_account"]').is(":checked")&&!c.find(".bookacti-generated-password").length&&parseInt(c.find(".bookacti-password_strength").val())<parseInt(c.find(".bookacti-password_strength").attr("min")))e.append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show(),a.prop("disabled",!1),bookacti_scroll_to(e,500,"middle");
else{var h=c.find('input[name="action"]').length,k=h?c.find('input[name="action"]').val():"";h?c.find('input[name="action"]').val("bookactiSubmitLoginForm"):c.append('<input type="hidden" name="action" value="bookactiSubmitLoginForm"/>');var f={form_data:new FormData(c.get(0))};b.trigger("bookacti_before_submit_login_form",[f]);h?c.find('input[name="action"]').val(k):c.find('input[name="action"]').remove();if(!(f.form_data instanceof FormData))return a.prop("disabled",!1),!1;bookacti_add_loading_html(a,
"after");$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:f.form_data,dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(g){var l=g.message?g.message:g.messages?g.messages:"";l&&(e.append('<ul class="'+("success"===g.status?"bookacti-success-list":"bookacti-error-list")+'"><li>'+l+"</li></ul>").show(),bookacti_scroll_to(e,500,"middle"));"success"===g.status&&(l="undefined"!==typeof c.attr("action")&&"bookactiSubmitLoginForm"===k?c.attr("action"):window.location.href,f.redirect_url=
g.redirect_url?g.redirect_url:l,c.trigger("bookacti_login_form_submitted",[g,f]),f.redirect_url&&(g=c.find(".bookacti-booking-system"),g.length?bookacti_redirect_booking_system_to_url(g,f.redirect_url):window.location.replace(f.redirect_url)))},error:function(g){var l='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";e.empty().append(l).show();bookacti_scroll_to(e,500,"middle");console.log("AJAX "+bookacti_localized.error);console.log(g)},complete:function(){bookacti_remove_loading_html(a.parent());
a.prop("disabled",!1);d||b.unwrap("form.bookacti-temporary-form")}})}}}
function bookacti_submit_booking_form(a){var b=a.find(".bookacti-booking-system"),d=a.find('input[type="submit"]');d.length&&d.prop("disabled",!0);var c=a.find("> .bookacti-notices").length?a.find("> .bookacti-notices"):b.siblings(".bookacti-notices"),e=!1;"undefined"!==typeof bookacti_localized.current_user_id&&bookacti_localized.current_user_id&&(e=!0);var h=a.find(".bookacti-email").length?!0:!1;if(!e&&!h)return c.empty().append('<ul class="bookacti-error-list"><li>'+bookacti_localized.error_user_not_logged_in+
"</li></ul>").show(),d.length&&d.prop("disabled",!1),bookacti_scroll_to(c,500,"middle"),!1;if(h&&a.find('input[name="login_type"][value="new_account"]').is(":checked")&&!a.find(".bookacti-generated-password").length&&parseInt(a.find(".bookacti-password_strength").val())<parseInt(a.find(".bookacti-password_strength").attr("min")))return c.empty().append("<ul class='bookacti-error-list'><li>"+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show(),d.length&&d.prop("disabled",!1),bookacti_scroll_to(c,
500,"middle"),!1;if(!bookacti_validate_picked_events(b,a.find(".bookacti-quantity").val()))return bookacti_scroll_to(b.siblings(".bookacti-notices"),500,"middle"),d.length&&d.prop("disabled",!1),!1;h=(e=a.find('input[name="action"]').length)?a.find('input[name="action"]').val():"";e?a.find('input[name="action"]').val("bookactiSubmitBookingForm"):a.append('<input type="hidden" name="action" value="bookactiSubmitBookingForm"/>');var k={form_data:new FormData(a.get(0))};a.trigger("bookacti_before_submit_booking_form",
[k]);e?a.find('input[name="action"]').val(h):a.find('input[name="action"]').remove();if(!(k.form_data instanceof FormData))return d.length&&d.prop("disabled",!1),!1;bookacti_start_loading_booking_system(b);d.length&&bookacti_add_loading_html(d,"after");$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:k.form_data,dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(f){var g="undefined"!==typeof f.redirect_url?f.redirect_url:"";if("success"!==f.status)var l="<ul class='bookacti-error-list'><li>"+
f.message+"</li></ul>";else a.find('.bookacti-form-field-container:not(.bookacti-form-field-name-submit):not(.bookacti-form-field-name-calendar), input[type="submit"]').hide(),f.has_logged_in?a.find(".bookacti-new-booking-button").addClass("bookacti-reload-page"):a.find(".bookacti-new-booking-button").removeClass("bookacti-reload-page"),a.find(".bookacti-new-booking-button").show(),l="<ul class='bookacti-success-list bookacti-persistent-notice'><li>"+f.message+"</li></ul>",0>g.indexOf("://")&&bookacti_refresh_booking_numbers(b);
l&&(c.empty().append(l).show(),g||bookacti_scroll_to(c,500,"middle"));l=bookacti_serialize_object(a);a.trigger("bookacti_booking_form_submitted",[f,l]);"success"===f.status&&g&&(bookacti_start_loading_booking_system(b),window.location.replace(g),bookacti_stop_loading_booking_system(b))},error:function(f){var g='<ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul>";c.empty().append(g).show();bookacti_scroll_to(c,500,"middle");console.log("AJAX "+bookacti_localized.error);
console.log(f)},complete:function(){d.length&&(bookacti_remove_loading_html(d.parent()),d.prop("disabled",!1));bookacti_stop_loading_booking_system(b)}})}
function bookacti_perform_form_action(a){var b={trigger:!0};a.closest("#bookacti-form-editor-page-form").length&&(b.trigger=!1);a.trigger("bookacti_trigger_perform_form_action",[b]);if(b.trigger&&(b=a.attr("id"),b=bookacti.booking_system[b],"undefined"!==typeof b.form_action)){if("default"===b.form_action)!a.closest("form").length&&a.closest(".bookacti-form-fields").length&&a.closest(".bookacti-form-fields").wrap('<form class="bookacti-temporary-form"></form>'),(a.closest("form.bookacti-booking-form").length||
a.closest("form.bookacti-temporary-form").length)&&bookacti_submit_booking_form(a.closest("form"));else if("redirect_to_url"===b.form_action){var d=a.closest(".bookacti-form-fields").length?a.closest(".bookacti-form-fields").find(".bookacti-quantity").length?a.closest(".bookacti-form-fields").find(".bookacti-quantity").val():1:1;if(!bookacti_validate_picked_events(a,d)){bookacti_scroll_to(a.siblings(".bookacti-notices"),500,"middle");return}d=parseInt(b.picked_events[0].group_id);b=b.picked_events[0];
0<d?bookacti_redirect_to_group_category_url(a,d):bookacti_redirect_to_activity_url(a,b)}a.trigger("bookacti_perform_form_action")}}
function bookacti_dialog_forgotten_password(a){var b=$j('.bookacti-forgotten-password-dialog[data-field-id="'+a+'"]');b.length||(b=$j(".bookacti-forgotten-password-dialog:first"));b.dialog("open");b.dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){b.find(".bookacti-notices").remove();var d=b.find(".bookacti-forgotten-password-email").val();d&&(bookacti_add_loading_html(b),$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiForgottenPassword",
user_login:d},dataType:"json",success:function(c){if("success"===c.status)"undefined"!==typeof c.message&&b.append('<div class="bookacti-notices"><ul class="bookacti-success-list"><li>'+c.message+"</li></ul></div>"),$j("body").trigger("bookacti_reset_password_notification_sent",[d,c]);else if("failed"===c.status){var e="undefined"!==typeof c.message?c.message:bookacti_localized.error;b.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+e+"</li></ul></div>");console.log(e);
console.log(c)}},error:function(c){b.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error+"</li></ul></div>");console.log(c)},complete:function(){b.find(".bookacti-notices").show();bookacti_remove_loading_html(b)}}))}}])}
function bookacti_update_total_price_field_data_and_refresh(a){if(a.find(".bookacti-form-field-type-total_price").length){var b="bookacti_update_total_price_field_"+a.attr("id");"undefined"!==typeof window[b]&&window[b]&&clearTimeout(window[b]);window[b]=setTimeout(function(){bookacti_update_total_price_field_data(a);bookacti_refresh_total_price_field(a)},200)}}
function bookacti_update_total_price_field_data(a){bookacti_update_total_price_field_picked_events_data(a);a.trigger("bookacti_update_total_price_field_data")}
function bookacti_update_total_price_field_picked_events_data(a){var b=a.attr("id");"undefined"===typeof bookacti.total_price_fields_data[b]&&(bookacti.total_price_fields_data[b]={items:[],total:{price:0,price_to_display:""}});b=bookacti.total_price_fields_data[b];b.items=$j.grep(b.items,function(h){return"undefined"===typeof h.id?!0:0>h.id.indexOf("picked-")});var d=a.find(".bookacti-booking-system");if(d.length){var c=d.attr("id");if("undefined"!==typeof bookacti.booking_system[c].picked_events){var e=
[];d=bookacti_get_picked_events_list_items(d);$j.each(d,function(h,k){0<k.quantity&&e.push({id:"picked-"+h,label:k.list_element.html(),price:k.price,price_to_display:k.price_to_display})});b.items=e.concat(b.items);a.trigger("bookacti_total_price_field_picked_events_data",[b,d])}}}
function bookacti_refresh_total_price_field(a){var b=a.attr("id");if("undefined"!==typeof bookacti.total_price_fields_data[b]&&!$j.isEmptyObject(bookacti.total_price_fields_data[b])){b=$j.extend(!0,{},bookacti.total_price_fields_data[b]);a.trigger("bookacti_refresh_total_price_field",[b]);var d=0,c=b.total.price_to_display,e=a.find(".bookacti-form-field-type-total_price .bookacti-total-price-table"),h=a.find(".bookacti-form-field-type-total_price .bookacti-grand-total-price-container");e.length&&
e.find("tbody").empty();$j.each(b.items,function(k,f){if("undefined"===typeof f.price||!$j.isNumeric(f.price))return!0;d+=parseFloat(f.price);if(e.length){k="undefined"!==typeof f.label?f.label:"";var g=f.price_to_display;"undefined"===typeof f.price_to_display&&(f.price_to_display="");!f.price_to_display&&f.price&&(f.price_to_display=bookacti_format_price(parseFloat(f.price)));f=$j("<tr></tr>",{html:"<td>"+k+"</td><td>"+g+"</td>"});e.find("tbody").append(f)}});!c&&d&&(c=bookacti_format_price(d));
h.length&&h.html(c);a.find(".bookacti-form-field-type-total_price .bookacti-total-price-value").val(d);a.find(".bookacti-form-field-type-total_price:not(.bookacti-form-editor-field)").toggle(e.length?0<e.find("tbody tr").length:0<h.html().length);a.trigger("bookacti_total_price_field_refreshed",[b])}};
