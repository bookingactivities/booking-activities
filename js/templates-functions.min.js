function bookacti_switch_template(a){if(!a){$j("#bookacti-template-picker").val("");bookacti.selected_template=0;$j("#bookacti-first-template-container").show();$j("#bookacti-template-sidebar, #bookacti-calendar-integration-tuto-container").addClass("bookacti-no-template");$j("#bookacti-template-calendar").remove();$j("#bookacti-template-activity-list .bookacti-activity").remove();bookacti_display_activity_tuto_if_no_activity_available();bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];$j("#bookacti-insert-group-of-events").css("visibility","hidden");$j("#bookacti-template-add-first-group-of-events-container").hide();$j("#bookacti-template-add-group-of-events-tuto-select-events").show();bookacti_bind_template_dialogs();return}$j("#bookacti-template-picker").val(a);bookacti.load_events=false;var b=$j.extend({},bookacti.booking_system["bookacti-template-calendar"]);delete b.events;delete b.events_data;delete b.events_interval;delete b.bookings;delete b.exceptions;delete b.activities_data;delete b.groups_events;delete b.groups_data;delete b.group_categories_data;delete b.display_data;delete b.template_data;delete b.selected_events;delete b.picked_events;bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiSwitchTemplate",template_id:a,attributes:JSON.stringify(b),nonce:$j("#nonce_edit_template").val()},type:"POST",dataType:"json",success:function(f){if(f.status==="success"){var h=bookacti.selected_template?false:true;var g=bookacti.booking_system["bookacti-template-calendar"]["loading_number"];bookacti.selected_template=parseInt(a);bookacti.hidden_activities=[];bookacti.booking_system["bookacti-template-calendar"]=f.booking_system_data;bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=g;bookacti.booking_system["bookacti-template-calendar"]["method"]="calendar";bookacti.booking_system["bookacti-template-calendar"]["past_events"]=true;bookacti.booking_system["bookacti-template-calendar"]["past_events_bookable"]=true;if(h){bookacti_bind_template_dialogs();bookacti_init_groups_of_events()}$j("#bookacti-template-activity-list .bookacti-activity").remove();$j("#bookacti-template-activity-list").append(f.activities_list);bookacti_init_activities();$j("#bookacti-group-categories").empty();$j("#bookacti-group-categories").append(f.groups_list);if(f.groups_list===""){$j("#bookacti-template-add-group-of-events-tuto-select-events").show()}else{$j("#bookacti-template-add-group-of-events-tuto-select-events").hide()}bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];$j("#bookacti-insert-group-of-events").css("visibility","hidden");$j("#bookacti-template-add-first-group-of-events-container").hide();$j('#bookacti-group-of-events-category-selectbox option[value!="new"]').remove();var e=[];$j("#bookacti-group-categories .bookacti-group-category").each(function(){$j("#bookacti-group-of-events-category-selectbox").append('<option value="'+$j(this).data("group-category-id")+'">'+$j(this).find(".bookacti-group-category-title").attr("title")+"</option>");if($j(this).data("visible")==1){e.push($j(this).data("group-category-id"))}});bookacti_make_group_categories_sortable();bookacti_make_groups_of_events_sortable();bookacti_update_create_form_link_template_id(bookacti.selected_template);$j("#bookacti-template-calendar").replaceWith('<div id="bookacti-template-calendar" class="bookacti-calendar"></div>');bookacti_load_template_calendar($j("#bookacti-template-calendar"));$j("#bookacti-template-calendar").fullCalendar("gotoDate",moment.utc());bookacti_booking_method_clear_events($j("#bookacti-template-calendar"));var c=$j("#bookacti-template-calendar").fullCalendar("getView");var d={start:moment.utc(moment.utc(c.intervalStart).clone().locale("en").format("YYYY-MM-DD")+" 00:00:00").locale("en"),end:moment.utc(moment.utc(c.intervalEnd).clone().locale("en").subtract(1,"days").format("YYYY-MM-DD")+" 23:59:59").locale("en")};bookacti_fetch_events_from_interval($j("#bookacti-template-calendar"),d);bookacti.load_events=true}else{if(f.status==="failed"){var i=typeof f.message!=="undefined"?f.message:bookacti_localized.error;alert(i);console.log(i);console.log(f)}}},error:function(c){console.log("AJAX "+bookacti_localized.error);console.log(c)},complete:function(){bookacti_stop_template_loading()}})}function bookacti_init_activities(){$j("#bookacti-template-activity-list .fc-event").draggable({zIndex:1000,revert:true,revertDuration:100,appendTo:"parent",helper:"clone",start:function(a,b){bookacti.is_dragging=true;$j(this).css("visibility","hidden");$j(this).parent().css("overflow","visible")},stop:function(a,b){bookacti.is_dragging=false;$j(this).css("visibility","visible");$j(this).parent().css("overflow","")}});if(bookacti.blocked_events===true){$j("#bookacti-template-activities-container .dashicons").addClass("bookacti-disabled");$j("#bookacti-template-activities-container .fc-event").addClass("bookacti-event-unavailable")}if($j("#bookacti-template-activity-list").outerHeight()>200){$j("#bookacti-template-activity-list").css("height",200)}else{$j("#bookacti-template-activity-list").css("height","auto")}bookacti_display_activity_tuto_if_no_activity_available();bookacti_refresh_show_hide_activities_icons();bookacti_make_activities_sortable()}function bookacti_init_show_hide_activities_switch(){$j("body").on("click","#bookacti-template-activity-list .bookacti-activity-visibility",function(){var b=$j(this).closest(".bookacti-activity").data("activity-id");var a=$j.inArray(b,bookacti.hidden_activities);if($j(this).data("activity-visible")===1){$j(this).removeClass("dashicons-visibility");$j(this).addClass("dashicons-hidden");$j(this).data("activity-visible",0);$j(this).attr("data-activity-visible",0);if(a===-1){bookacti.hidden_activities.push(b)}}else{$j(this).addClass("dashicons-visibility");$j(this).removeClass("dashicons-hidden");$j(this).data("activity-visible",1);$j(this).attr("data-activity-visible",1);if(a!==-1){bookacti.hidden_activities.splice(a,1)}}$j("#bookacti-template-calendar").fullCalendar("rerenderEvents")})}function bookacti_refresh_show_hide_activities_icons(){var a=$j("#bookacti-template-activity-list .bookacti-activity-visibility");a.addClass("dashicons-visibility");a.removeClass("dashicons-hidden");a.data("activity-visible",1);a.attr("data-activity-visible",1);$j.each(bookacti.hidden_activities,function(b,d){if($j('#bookacti-template-activity-list .bookacti-activity[data-activity-id="'+d+'"] .bookacti-activity-visibility').length){var c=$j('#bookacti-template-activity-list .bookacti-activity[data-activity-id="'+d+'"] .bookacti-activity-visibility');c.removeClass("dashicons-visibility");c.addClass("dashicons-hidden");c.data("activity-visible",0);c.attr("data-activity-visible",0)}})}function bookacti_make_activities_sortable(){$j("#bookacti-template-activity-list").sortable({items:".bookacti-activity",handle:".bookacti-activity-visibility",placeholder:"bookacti-calendar-editor-sortable-placeholder",update:function(b,a){bookacti_save_template_items_order("activities")}});$j("#bookacti-template-activity-list").disableSelection()}function bookacti_save_template_items_order(a,b){a=typeof a!=="undefined"?a:"";b=typeof b!=="undefined"?parseInt(b):0;var d,f="";switch(a){case"activities":d="#bookacti-template-activity-list .bookacti-activity";f="activity-id";break;case"group_categories":d="#bookacti-group-categories .bookacti-group-category";f="group-category-id";break;case"groups_of_events":d='.bookacti-group-category[data-group-category-id="'+b+'"] .bookacti-groups-of-events-editor-list .bookacti-group-of-events';f="group-id";break}var c=[];if(d&&f){if($j(d).length){$j(d).each(function(){if(typeof $j(this).data(f)!=="undefined"){c.push($j(this).data(f))}})}}if(!c.length){return}var e={action:"bookactiSaveTemplateItemsOrder",template_id:bookacti.selected_template,item_type:a,item_id:b,items_order:c,nonce:$j("#nonce_edit_template").val()};$j("#bookacti-template-container").trigger("bookacti_update_template_items_order_data",[e,a,b]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:e,type:"POST",dataType:"json",success:function(g){if(g.status==="success"){$j("#bookacti-template-container").trigger("bookacti_template_items_order_updated",[g,e,a,b])}else{if(g.status==="failed"){var h=typeof g.message!=="undefined"?g.message:bookacti_localized.error;console.log(h);console.log(g)}}},error:function(h){var g="AJAX "+bookacti_localized.error;console.log(g);console.log(h)},complete:function(){bookacti_stop_template_loading()}})}function bookacti_init_groups_of_events(){$j("body").on("click","#bookacti-template-calendar .fc-more",function(){bookacti_refresh_selected_events_display()});$j("body").on("bookacti_select_event bookacti_unselect_event bookacti_unselect_all_events","#bookacti-template-calendar",function(){bookacti_maybe_display_add_group_of_events_button()});$j("body").on("bookacti_select_event bookacti_unselect_event","#bookacti-template-calendar",function(){if(bookacti.booking_system["bookacti-template-calendar"]["selected_events"].length<=0){bookacti_unselect_all_events();bookacti_refresh_selected_events_display()}});$j("body").on("click","#bookacti-group-categories .bookacti-group-category-title",function(){var a=$j(this).parent().data("group-category-id");bookacti_expand_collapse_groups_of_events(a)});$j("body").on("click","#bookacti-group-categories .bookacti-group-of-events-title",function(){var b=$j(this).closest(".bookacti-group-of-events").hasClass("bookacti-selected-group");if(!b){var a=$j(this).closest(".bookacti-group-of-events").data("group-id");bookacti_select_events_of_group(a)}else{bookacti_unselect_all_events();bookacti_refresh_selected_events_display()}})}function bookacti_make_group_categories_sortable(){$j("#bookacti-group-categories").sortable({items:".bookacti-group-category",handle:".bookacti-group-category-title",placeholder:"bookacti-calendar-editor-sortable-placeholder",update:function(b,a){bookacti_save_template_items_order("group_categories")}});$j("#bookacti-group-categories").disableSelection()}function bookacti_make_groups_of_events_sortable(){$j(".bookacti-groups-of-events-editor-list").sortable({items:".bookacti-group-of-events",handle:".bookacti-group-of-events-title",placeholder:"bookacti-calendar-editor-sortable-placeholder",update:function(c,b){var a=$j(b.item).closest(".bookacti-group-category").data("group-category-id");bookacti_save_template_items_order("groups_of_events",a)}});$j(".bookacti-groups-of-events-editor-list").disableSelection()}function bookacti_add_group_category(b,a){$j("#bookacti-group-categories").append("<div class='bookacti-group-category'  data-group-category-id='"+b+"' data-show-groups='0' data-visible='1' ><div class='bookacti-group-category-title' title='"+a+"' ><span>"+a+"</span></div><div class='bookacti-update-group-category dashicons dashicons-admin-generic' ></div><div class='bookacti-groups-of-events-editor-list bookacti-custom-scrollbar'></div></div>");$j("#bookacti-group-of-events-category-selectbox").append("<option value='"+b+"' >"+a+"</option>");bookacti.selected_category=b}function bookacti_add_group_of_events(c,b,a){if(!$j('.bookacti-group-category[data-group-category-id="'+a+'"]').length){bookacti_add_group_category(a,"Untitled")}$j('.bookacti-group-category[data-group-category-id="'+a+'"] .bookacti-groups-of-events-editor-list').append("<div class='bookacti-group-of-events' data-group-id='"+c+"' ><div class='bookacti-group-of-events-title' title='"+b+"'>"+b+"</div><div class='bookacti-update-group-of-events dashicons dashicons-admin-generic' ></div></div>");bookacti_expand_collapse_groups_of_events(a,"expand",true)}function bookacti_select_events_of_group(a){if(!a){return false}bookacti_unselect_all_events();bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];$j("#bookacti-template-calendar").fullCalendar("rerenderEvents");if(typeof bookacti.booking_system["bookacti-template-calendar"]["groups_events"][a]!=="undefined"){$j("#bookacti-template-calendar").fullCalendar("gotoDate",bookacti.booking_system["bookacti-template-calendar"]["groups_events"][a][0]["start"])}var b=true;$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"][a],function(c,d){var e=bookacti_select_event(d);if(e===false){b=false}});if(b){$j('.bookacti-group-of-events[data-group-id="'+a+'"]').addClass("bookacti-selected-group")}return b}function bookacti_select_event(b){if((typeof b!=="object")||(typeof b==="object"&&(typeof b.id==="undefined"||typeof b.start==="undefined"))){return false}var c="";if(!b.title&&typeof bookacti.booking_system["bookacti-template-calendar"]["events_data"][b.id]!=="undefined"){var a=bookacti.booking_system["bookacti-template-calendar"]["events_data"][b.id];if(a.title){c=a.title}else{if($j('.bookacti-activity[data-activity-id="'+a.activity_id+'"] .fc-event').length){c=$j('.bookacti-activity[data-activity-id="'+a.activity_id+'"] .fc-event').text()}}}var d={id:b.id,title:b.title?b.title:c,start:moment.utc(b.start).clone().locale("en"),end:moment.utc(b.end).clone().locale("en")};var e=$j('.fc-event[data-event-id="'+d.id+'"][data-event-start="'+d.start.format("YYYY-MM-DD HH:mm:ss")+'"]');if(e.length){e.addClass("bookacti-selected-event");e.find(".bookacti-event-action-select-checkbox").prop("checked",true);e.find(".bookacti-event-actions").show();e.find(".bookacti-event-action-select").show()}bookacti.booking_system["bookacti-template-calendar"]["selected_events"].push({id:d.id,title:d.title,start:d.start.format("YYYY-MM-DD HH:mm:ss"),end:d.end.format("YYYY-MM-DD HH:mm:ss")});$j("#bookacti-template-calendar").trigger("bookacti_select_event",[d]);return true}function bookacti_unselect_event(e,b){b=b?true:false;if((typeof e!=="object"&&!$j.isNumeric(e))||(typeof e==="object"&&(typeof e.id==="undefined"||typeof e.start==="undefined"))||($j.isNumeric(e)&&!b)){return false}if(typeof e!=="object"){var g=e;e={id:g}}var d=moment.utc(e.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var a=moment.utc(e.start).clone().locale("en").format("YYYY-MM-DD");var f=$j('.fc-event[data-event-id="'+e.id+'"][data-event-start="'+d+'"]');if(f.length){f.removeClass("bookacti-selected-event");f.find(".bookacti-event-action-select-checkbox").prop("checked",false);f.find(".bookacti-event-action-select").hide()}var c=$j.grep(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(h){if(h.id==e.id&&(b||h.start.substr(0,10)===a)){return false}return true});bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=c;$j("#bookacti-template-calendar").trigger("bookacti_unselect_event",[e,b]);return true}function bookacti_unselect_all_events(){$j(".fc-event").removeClass("bookacti-selected-event");$j(".fc-event").find(".bookacti-event-action-select-checkbox").prop("checked",false);$j(".fc-event").find(".bookacti-event-action-select").hide();bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];$j(".bookacti-group-of-events.bookacti-selected-group").removeClass("bookacti-selected-group");$j("#bookacti-template-calendar").trigger("bookacti_unselect_all_events")}function bookacti_refresh_selected_events_display(){$j(".fc-event").removeClass("bookacti-selected-event");$j(".fc-event .bookacti-event-action-select-checkbox").prop("checked",false);$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(b,c){var a=$j('.fc-event[data-event-id="'+c.id+'"][data-event-start="'+c.start+'"]');a.addClass("bookacti-selected-event");a.find(".bookacti-event-action-select-checkbox").prop("checked",true);a.find(".bookacti-event-actions").show();a.find('.bookacti-event-action[data-hide-on-mouseout="1"]').hide();a.find(".bookacti-event-action-select").show()});$j("#bookacti-template-calendar").trigger("bookacti_refresh_selected_events")}function bookacti_update_create_form_link_template_id(a){$j('#bookacti-calendar-integration-tuto-container input[name="calendar_field[calendars]"]').val(a);bookacti_update_create_form_link_url()}function bookacti_update_create_form_link_url(){var b=$j("#bookacti-create-form-link").data("base-url");var a=$j("#bookacti-calendar-integration-tuto-container input").serialize();$j("#bookacti-create-form-link").attr("href",b+"?"+a)}function bookacti_fetch_events_on_template(c,b){c=c||null;b=b||bookacti.booking_system["bookacti-template-calendar"]["events_interval"];if($j.isEmptyObject(b)){var a=$j("#bookacti-template-calendar").fullCalendar("getView");b=bookacti_get_new_interval_of_events($j("#bookacti-template-calendar"),a)}bookacti.booking_system["bookacti-template-calendar"]["events_interval"]=bookacti_get_extended_events_interval($j("#bookacti-template-calendar"),b);bookacti_start_template_loading();$j.ajax({url:ajaxurl,type:"POST",data:{action:"bookactiFetchTemplateEvents",template_id:bookacti.selected_template,event_id:c,interval:b,nonce:$j("#nonce_fetch_template_events").val()},dataType:"json",success:function(d){if(d.status==="success"){if($j.isEmptyObject(bookacti.booking_system["bookacti-template-calendar"]["events"])){bookacti.booking_system["bookacti-template-calendar"]["events"]=d.events}else{$j.extend(bookacti.booking_system["bookacti-template-calendar"]["events"],d.events)}if($j.isEmptyObject(bookacti.booking_system["bookacti-template-calendar"]["events_data"])){bookacti.booking_system["bookacti-template-calendar"]["events_data"]=d.events_data}else{$j.extend(bookacti.booking_system["bookacti-template-calendar"]["events_data"],d.events_data)}$j("#bookacti-template-calendar").fullCalendar("addEventSource",d.events)}else{var e=typeof d.message!=="undefined"?d.message:bookacti_localized.error;alert(e);console.log(e);console.log(d)}},error:function(d){alert("AJAX "+bookacti_localized.error);console.log(d)},complete:function(){bookacti_stop_template_loading()}})}function bookacti_refetch_events_on_template(b){b=b||null;var c=b!=null?b.id:null;bookacti_booking_method_clear_events($j("#bookacti-template-calendar"),b);var d=$j("#bookacti-template-calendar").fullCalendar("getView");var a=bookacti_get_new_interval_of_events($j("#bookacti-template-calendar"),d);bookacti_fetch_events_on_template(c,a)}function bookacti_delete_event(a){bookacti_unselect_event(a);$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(c,d){var b=$j.grep(d,function(e){if(e&&e.id==a.id){return false}return true});bookacti.booking_system["bookacti-template-calendar"]["groups_events"][c]=b});if(a._id!==undefined){if(a._id.indexOf("_")>=0){$j("#bookacti-template-calendar").fullCalendar("removeEvents",a._id)}}$j("#bookacti-template-calendar").fullCalendar("removeEvents",a.id);$j("#bookacti-template-calendar").fullCalendar("refetchEvents")}function bookacti_update_event_dates(a,k,i,m){k=typeof k!=="undefined"?k:{_days:0};i=typeof i!=="undefined"&&i!==false?i:false;m=typeof m!=="undefined"?m:"";var f="";var h={};h.forced_update=0;if(m==="normal"){f="bookacti-update-event-dates-dialog"}if(m==="booked"){f="bookacti-update-booked-event-dates-dialog";h=$j("#bookacti-update-booked-event-dates-form").serializeObject();h.forced_update=1}if(f){$j("#"+f+" .bookacti-notices").remove();var d='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";$j("#"+f).append(d)}var l=a.id;var b=moment.utc(a.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var e=!a.end?b:moment.utc(a.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var j=k._days;var c=bookacti.booking_system["bookacti-template-calendar"]["events_interval"];var g=$j.extend({action:"bookactiUpdateEventDates",event_id:l,event_start:b,event_end:e,delta_days:j,interval:c,nonce:$j("#nonce_edit_template").val()},h);$j("#bookacti-template-calendar").trigger("bookacti_update_event_dates_before",[a,g,k,i]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:g,type:"POST",dataType:"json",success:function(n){if(n.status==="success"){var q=moment.utc(a.start).clone().locale("en").format("HH:mm:ss");var o=moment.utc(a.end).clone().locale("en").format("HH:mm:ss");if(!$j.isEmptyObject(n.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][l]=n.event_data}if(typeof n.exceptions[l]!=="undefined"){bookacti.booking_system["bookacti-template-calendar"]["exceptions"][l]=n.exceptions[l]}else{if(typeof bookacti.booking_system["bookacti-template-calendar"]["exceptions"][l]!=="undefined"){delete bookacti.booking_system["bookacti-template-calendar"]["exceptions"][l]}}$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(u,t){if(t.id==a.id){var v=moment.utc(t.start).clone().locale("en").add(j,"days").format("YYYY-MM-DD")+" "+q;var s=moment.utc(t.end).clone().locale("en").add(j,"days").format("YYYY-MM-DD")+" "+o;t.start=v;t.end=s}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(s,t){$j.each(t,function(u,v){if(v.id==a.id){v.start=moment.utc(v.start).clone().locale("en").add(j,"days").format("YYYY-MM-DD")+" "+q;v.end=moment.utc(v.end).clone().locale("en").add(j,"days").format("YYYY-MM-DD")+" "+o}})});var r={};if(typeof bookacti.booking_system["bookacti-template-calendar"]["bookings"][l]!=="undefined"){$j.each(bookacti.booking_system["bookacti-template-calendar"]["bookings"][l],function(t,s){var u=moment.utc(t).clone().locale("en").add(j,"days").format("YYYY-MM-DD")+" "+q;r[u]=$j.extend({},s)});if($j.isEmptyObject(r)){delete bookacti.booking_system["bookacti-template-calendar"]["bookings"][l]}}if(!$j.isEmptyObject(r)){bookacti.booking_system["bookacti-template-calendar"]["bookings"][l]=r}if(n.events.length>0){$j("#bookacti-template-calendar").fullCalendar("removeEvents",l);$j("#bookacti-template-calendar").fullCalendar("addEventSource",n.events)}if(f){$j("#"+f).off("dialogbeforeclose");$j("#"+f).dialog("close")}$j("#bookacti-template-calendar").trigger("bookacti_event_dates_updated",[a,n,g])}else{if(n.status==="failed"){if(n.error==="has_bookings"&&!h.forced_update){if(f){$j("#"+f).dialog("close")}bookacti_dialog_update_booked_event_dates(a,k,i);$j("#bookacti-update-booked-event-dates-intro").append('<span class="bookacti-bookings-nb">'+n.bookings_nb+"</span>");$j("#bookacti-update-booked-event-dates-send_notifications-container").append('<span class="bookacti-notifications-nb">'+n.notifications_nb+"</span>")}else{if(i!==false){i()}var p=typeof n.message!=="undefined"?n.message:bookacti_localized.error;if(f){$j("#"+f).append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+p+"</li></ul></div>");$j("#"+f+" .bookacti-notices").show()}else{alert(p)}console.log(n)}}}},error:function(n){if(i!==false){i()}alert("AJAX "+bookacti_localized.error);console.log(n)},complete:function(){if(f){$j("#"+f+" .bookacti-loading-alt").remove()}bookacti_stop_template_loading()}})}function bookacti_duplicate_event(c,g){g=typeof g!=="undefined"?g:{_days:0};var f=c.id;var e=moment.utc(c.start).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var a=!c.end?e:moment.utc(c.end).clone().locale("en").format("YYYY-MM-DD HH:mm:ss");var b=bookacti.booking_system["bookacti-template-calendar"]["events_interval"];var d={action:"bookactiDuplicateEvent",event_id:f,event_start:e,event_end:a,interval:b,delta_days:g._days,nonce:$j("#nonce_edit_template").val()};$j("#bookacti-template-calendar").trigger("bookacti_duplicate_event_before",[c,d]);bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:d,type:"POST",dataType:"json",success:function(h){if(h.status==="success"){var i=h.event_id;if(typeof h.exceptions[i]!=="undefined"){bookacti.booking_system["bookacti-template-calendar"]["exceptions"][i]=h.exceptions[i]}if(!$j.isEmptyObject(h.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][i]=h.event_data}$j("#bookacti-template-calendar").fullCalendar("addEventSource",h.events);$j("#bookacti-template-calendar").trigger("bookacti_event_duplicated",[c,h,d])}else{if(h.status==="failed"){var j=typeof h.message!=="undefined"?h.message:bookacti_localized.error;alert(j);console.log(j);console.log(h)}}},error:function(h){alert("AJAX "+bookacti_localized.error);console.log(h)},complete:function(){bookacti_stop_template_loading()}})}function bookacti_bind_template_dialogs(){if(bookacti.selected_template){$j("#bookacti-update-template").off().on("click","span",function(){bookacti_dialog_update_template(bookacti.selected_template)});$j("#bookacti-template-activities-container").off().on("click","#bookacti-insert-activity, #bookacti-template-add-first-activity-button",function(){if($j("#bookacti-template-picker option").length>1){bookacti_dialog_choose_activity_creation_type()}else{bookacti_dialog_create_activity()}})}else{$j("#bookacti-update-template").off().on("click","span",function(){alert(bookacti_localized.error_no_template_selected)});$j("#bookacti-template-activities-container").off().on("click","#bookacti-insert-activity, #bookacti-template-add-first-activity-button",function(){alert(bookacti_localized.error_no_template_selected)})}}function bookacti_is_locked_event(b){var a=false;$j.each(lockedEvents,function(d,c){if(parseInt(b)===parseInt(c)){a=true;return false}});return a}function bookacti_start_template_loading(){if(bookacti.booking_system["bookacti-template-calendar"]["loading_number"]===0){bookacti_enter_template_loading_state()}bookacti.booking_system["bookacti-template-calendar"]["loading_number"]++}function bookacti_stop_template_loading(){bookacti.booking_system["bookacti-template-calendar"]["loading_number"]--;bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=Math.max(bookacti.booking_system["bookacti-template-calendar"]["loading_number"],0);if(bookacti.booking_system["bookacti-template-calendar"]["loading_number"]===0){bookacti_exit_template_loading_state()}}function bookacti_enter_template_loading_state(){var a='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";if(!$j.isNumeric(bookacti.booking_system["bookacti-template-calendar"]["loading_number"])){bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=0}if($j("#bookacti-template-calendar").find(".fc-view-container").length){if(bookacti.booking_system["bookacti-template-calendar"]["loading_number"]===0||!$j("#bookacti-template-calendar").find(".bookacti-loading-overlay").length){$j("#bookacti-template-calendar").find(".bookacti-loading-alt").remove();bookacti_enter_calendar_loading_state($j("#bookacti-template-calendar"))}}else{if(!$j("#bookacti-template-calendar").find(".bookacti-loading-alt").length){$j("#bookacti-template-calendar").append(a)}}bookacti.blocked_events=true;$j("#bookacti-template-sidebar .dashicons").addClass("bookacti-disabled");$j(".bookacti-template-dialog").find("input, select, button").attr("disabled",true);$j("#bookacti-template-picker").attr("disabled",true);$j("#bookacti-template-calendar").fullCalendar("rerenderEvents")}function bookacti_exit_template_loading_state(a){a=a||false;if(a){bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=0}bookacti_exit_calendar_loading_state($j("#bookacti-template-calendar"));$j("#bookacti-template-calendar").find(".bookacti-loading-alt").remove();bookacti.blocked_events=false;$j("#bookacti-template-sidebar .dashicons").removeClass("bookacti-disabled");$j(".bookacti-template-dialog").find("input, select, button").attr("disabled",false);$j("#bookacti-template-picker").attr("disabled",false);$j("#bookacti-template-calendar").fullCalendar("rerenderEvents")}function bookacti_display_activity_tuto_if_no_activity_available(){if($j("#bookacti-template-first-activity-container").length){$j("#bookacti-template-first-activity-container").toggle($j(".bookacti-activity").length<=0)}}function bookacti_maybe_display_add_group_of_events_button(){if(!$j("#bookacti-template-add-first-group-of-events-container").length){return}if(bookacti.booking_system["bookacti-template-calendar"]["selected_events"].length>=2){$j("#bookacti-insert-group-of-events").css("visibility","visible");if(!$j(".bookacti-group-category").length){$j("#bookacti-template-add-group-of-events-tuto-select-events").hide();$j("#bookacti-template-add-first-group-of-events-container").show()}}else{$j("#bookacti-template-add-first-group-of-events-container").hide();$j("#bookacti-insert-group-of-events").css("visibility","hidden");if(!$j(".bookacti-group-category").length){$j("#bookacti-template-add-group-of-events-tuto-select-events").show()}}$j(".bookacti-group-of-events .bookacti-update-group-of-events").removeClass("dashicons-insert").addClass("dashicons-admin-generic");if($j(".bookacti-group-of-events.bookacti-selected-group").length){$j(".bookacti-group-of-events.bookacti-selected-group .bookacti-update-group-of-events").removeClass("dashicons-admin-generic").addClass("dashicons-insert")}}function bookacti_expand_collapse_groups_of_events(c,d,a){a=a?true:false;d=$j.inArray(d,["expand","collapse"])>=0?d:false;var b=$j('.bookacti-group-category[data-group-category-id="'+c+'"]').data("show-groups");if((b||d==="collapse")&&d!=="expand"){$j('.bookacti-group-category[data-group-category-id="'+c+'"]').attr("data-show-groups",0);$j('.bookacti-group-category[data-group-category-id="'+c+'"]').data("show-groups",0);$j('.bookacti-group-category[data-group-category-id="'+c+'"] .bookacti-groups-of-events-editor-list').slideUp(200,function(){bookacti_set_editor_group_of_events_max_height(c)})}else{if((!b||d==="expand")&&d!=="collapse"){if(a){bookacti_expand_collapse_all_groups_of_events("collapse",c)}$j('.bookacti-group-category[data-group-category-id="'+c+'"]').attr("data-show-groups",1);$j('.bookacti-group-category[data-group-category-id="'+c+'"]').data("show-groups",1);$j('.bookacti-group-category[data-group-category-id="'+c+'"] .bookacti-groups-of-events-editor-list').slideDown(200,function(){bookacti_set_editor_group_of_events_max_height(c)})}}}function bookacti_set_editor_group_of_events_max_height(a){if($j('.bookacti-group-category[data-group-category-id="'+a+'"] .bookacti-groups-of-events-editor-list').outerHeight()>=150){$j('.bookacti-group-category[data-group-category-id="'+a+'"] .bookacti-groups-of-events-editor-list').css("height",150)}else{$j('.bookacti-group-category[data-group-category-id="'+a+'"] .bookacti-groups-of-events-editor-list').css("height","auto")}if($j("#bookacti-group-categories").outerHeight()>200){$j("#bookacti-group-categories").css("height",200)}else{$j("#bookacti-group-categories").css("height","auto")}}function bookacti_expand_collapse_all_groups_of_events(c,b){b=b?b:false;var a=".bookacti-group-category";if(b){if($j.isArray(b)){$j.each(b,function(e,d){a+=':not([data-group-category-id="'+d+'"])'})}else{a='.bookacti-group-category:not([data-group-category-id="'+b+'"])'}}if(c==="collapse"){$j(a).attr("data-show-groups",0);$j(a).data("show-groups",0);$j(a+" .bookacti-groups-of-events-editor-list").slideUp(200)}else{if(c==="expand"){$j(a).attr("data-show-groups",1);$j(a).data("show-groups",1);$j(a+" .bookacti-groups-of-events-editor-list").slideDown(200)}}}function bookacti_load_activities_bound_to_template(a){if(parseInt(a)===parseInt(bookacti.selected_template)){return}$j("#bookacti-activities-bound-to-template .bookacti-form-error").remove();bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiGetActivitiesByTemplate",selected_template_id:a,current_template_id:bookacti.selected_template,nonce:$j("#nonce_edit_template").val()},type:"POST",dataType:"json",success:function(b){$j("select#activities-to-import").empty();if(b.status==="success"){if(b.activities){$j.each(b.activities,function(d,e){if(!$j('#bookacti-template-activity-list .bookacti-activity[data-activity-id="'+d+'"]').length){$j("select#activities-to-import").append('<option value="'+d+'" >'+e.title+"</option>")}})}}else{var c=typeof b.message!=="undefined"?b.message:bookacti_localized.error;$j("#bookacti-activities-bound-to-template").append('<div class="bookacti-form-error">'+b.message+"</div>");console.log(c);console.log(b)}},error:function(b){alert("AJAX "+bookacti_localized.error);console.log(b)},complete:function(){bookacti_stop_template_loading()}})}function bookacti_show_event_actions(a){a.addClass("bookacti-event-over");a.find(".bookacti-event-action").show()}function bookacti_hide_event_actions(b,c){b.removeClass("bookacti-event-over");b.find('.bookacti-event-action[data-hide-on-mouseout="1"]').hide();var a=moment.utc(c.start).clone().locale("en").format("YYYY-MM-DD");var d=false;$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(f,e){if(e.id==c.id&&e.start.substr(0,10)===a){d=true;return false}});if(d){b.find(".bookacti-event-actions").show();b.find(".bookacti-event-action-select").show()}else{b.find(".bookacti-event-action-select").hide()}}function bookacti_init_event_duplication_feedbacks(){$j(document).on("keydown",function(a){if(a.altKey){alt_key_down=true;if(bookacti.is_hovering||bookacti.is_dragging){$j("#bookacti-template-container .bookacti-event-dragged, #bookacti-template-container .bookacti-event-over, #bookacti-template-container .fc-helper").addClass("bookacti-duplicate-event")}a.stopPropagation();a.preventDefault()}});$j(document).on("keyup",function(a){if(a.keyCode==18){$j("#bookacti-template-container .bookacti-duplicate-event").removeClass("bookacti-duplicate-event");a.stopPropagation();a.preventDefault()}})};